<script>
/**
 * ===========================
 * SISTEMA NEUROTEA - JAVASCRIPT CLIENTE
 * Google Apps Script Version
 * ===========================
 */

// ===========================
// VARIABLES GLOBALES
// ===========================
let fechaActual = '';
let terapeutas = [];
let sesiones = [];
let sesionesGrupales = [];
let egresos = [];
let paquetesActivos = [];
let paquetesFecha = [];  // Paquetes comprados en la fecha actual
let gruposActivos = [];
let confirmaciones = {};
let estadosTransferencia = {};
let saldoInicial = 0;
let config = {};

// Mini carrito de sesiones futuras
let sesionesFuturasTemp = [];

// ===========================
// INICIALIZACION
// ===========================

/**
 * Inicializa el sistema
 */
function initializeSystem() {
  try {
    // Establecer fecha actual
    fechaActual = new Date().toISOString().split('T')[0];
    const sessionDateInput = document.getElementById('session-date');
    if (sessionDateInput) {
      sessionDateInput.value = fechaActual;
    }

    // Event listeners primero (no bloquean)
    setupEventListeners();

    // Cargar datos iniciales
    loadInitialData();
  } catch (error) {
    console.error('Error en initializeSystem:', error);
    // Intentar ocultar loading si hay error
    try { showLoading(false); } catch (e) {}
    alert('Error inicializando sistema: ' + error.message);
  }
}

/**
 * Carga datos iniciales desde el servidor
 */
function loadInitialData() {
  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      try {
        showLoading(false);

        if (result && result.success) {
          // Asignar datos a variables globales
          const data = result.data || {};
          fechaActual = data.fechaActual || fechaActual;
          terapeutas = data.terapeutas || [];
          sesiones = data.sesiones || [];
          sesionesGrupales = data.sesionesGrupales || [];
          egresos = data.egresos || [];
          paquetesActivos = data.paquetes || [];
          paquetesFecha = data.paquetesFecha || [];
          gruposActivos = data.grupos || [];
          confirmaciones = data.confirmaciones || [];
          estadosTransferencia = data.estadosTransferencia || {};
          saldoInicial = data.saldoInicial || 0;
          config = data.config || {};

          // Mostrar errores parciales si existen
          if (result.errors && result.errors.length > 0) {
            console.warn('Errores cargando datos:', result.errors);
            showNotification('Algunos datos no se cargaron: ' + result.errors.join(', '), 'warning');
          }

          // Log para depuracion
          console.log('Datos cargados:', {
            fecha: fechaActual,
            terapeutas: terapeutas.length,
            sesiones: sesiones.length,
            sesionesGrupales: sesionesGrupales.length
          });

          // Actualizar fecha en input
          const sessionDateInput = document.getElementById('session-date');
          if (sessionDateInput) {
            sessionDateInput.value = fechaActual;
          }

          // Actualizar todas las vistas
          updateAllViews();
        } else {
          const msg = result ? result.message : 'Respuesta invalida del servidor';
          showNotification('Error cargando datos: ' + msg, 'error');
        }
      } catch (error) {
        console.error('Error procesando datos:', error);
        showNotification('Error procesando datos: ' + error.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      console.error('Error de conexion:', error);
      showNotification('Error de conexion: ' + (error.message || error), 'error');
    })
    .cargarDatosIniciales();
}

/**
 * Carga datos de una fecha especifica
 * También refresca terapeutas y grupos para mantener sincronización
 */
function loadDateData(fecha) {
  showLoading(true);
  fechaActual = fecha;

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);

      if (result.success) {
        const data = result.data;
        sesiones = data.sesiones || [];
        sesionesGrupales = data.sesionesGrupales || [];
        egresos = data.egresos || [];
        paquetesFecha = data.paquetesFecha || [];
        confirmaciones = data.confirmaciones || {};
        estadosTransferencia = data.estadosTransferencia || {};
        saldoInicial = data.saldoInicial || 0;

        // Refrescar terapeutas y grupos si fueron incluidos en la respuesta
        if (data.terapeutas) {
          terapeutas = data.terapeutas;
        }
        if (data.grupos) {
          gruposActivos = data.grupos;
        }

        updateAllViews();
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .cargarDatosFecha(fecha);
}

/**
 * Configura event listeners
 */
function setupEventListeners() {
  // Helper para agregar event listener de forma segura
  function safeAddListener(id, event, handler) {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener(event, handler);
    } else {
      console.warn('Elemento no encontrado:', id);
    }
  }

  // Cambio de fecha
  safeAddListener('session-date', 'change', function(e) {
    loadDateData(e.target.value);
  });

  // Formulario de paquete (el unico que existe como form)
  safeAddListener('package-form', 'submit', handlePackageSubmit);

  // Event listeners para calculo en tiempo real del paquete
  ['package-sessions', 'package-cash', 'package-transfer-therapist', 'package-transfer-neurotea'].forEach(id => {
    safeAddListener(id, 'input', updatePackageCalculations);
  });
  // Validacion de terapeuta y paciente para habilitar boton crear paquete
  safeAddListener('package-therapist', 'change', updatePackageCalculations);
  safeAddListener('package-patient-name', 'input', updatePackageCalculations);

  // Aporte NeuroTEA en paquetes
  document.querySelectorAll('input[name="package-neurotea-contribution"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const fixedInput = document.getElementById('package-fixed-amount-input');
      if (fixedInput) {
        fixedInput.disabled = this.value !== 'fixed';
        if (this.value !== 'fixed') {
          fixedInput.value = '';
        }
      }
      updatePackageCalculations();
    });
  });
  safeAddListener('package-fixed-amount-input', 'input', updatePackageCalculations);

  // Tipo de egreso - mostrar/ocultar selector de terapeuta
  safeAddListener('egreso-type', 'change', function(e) {
    const container = document.getElementById('egreso-therapist-container');
    if (container) {
      container.style.display = e.target.value === 'adelanto' ? 'block' : 'none';
    }
  });

  // Verificar creditos al escribir nombre de paciente
  safeAddListener('patient-name', 'blur', checkPatientCredits);
  safeAddListener('patient-name', 'input', validateRegisterButton);

  // Validacion del boton registrar - escuchar cambios en campos relevantes
  safeAddListener('therapist-select', 'change', function() {
    validateRegisterButton();
    var modo = document.querySelector('input[name="modo-registro"]:checked');
    if (modo && modo.value === 'usar-credito') {
      updateAvailablePatients();
    }
  });

  // Campos de pago - calculos en tiempo real
  safeAddListener('cash-to-neurotea', 'input', function() {
    validateRegisterButton();
    updatePaymentDisplay();
  });
  safeAddListener('transfer-to-neurotea', 'input', function() {
    validateRegisterButton();
    updatePaymentDisplay();
  });
  safeAddListener('transfer-to-therapist', 'input', function() {
    validateRegisterButton();
    updatePaymentDisplay();
  });

  // Aporte NeuroTEA - escuchar cambios
  document.querySelectorAll('input[name="neurotea-contribution"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const fixedInput = document.getElementById('fixed-amount-input');
      if (fixedInput) {
        fixedInput.disabled = this.value !== 'fixed';
        if (this.value !== 'fixed') {
          fixedInput.value = '';
        }
      }
      updatePaymentDisplay();
    });
  });
  safeAddListener('fixed-amount-input', 'input', updatePaymentDisplay);

  // Modo de registro - validar y alternar vistas al cambiar
  document.querySelectorAll('input[name="modo-registro"]').forEach(radio => {
    radio.addEventListener('change', function() {
      togglePaymentMode();
      validateRegisterButton();
    });
  });

  // Mini carrito de sesiones futuras
  safeAddListener('crear-creditos-adicionales', 'change', toggleSesionesFuturasContainer);
  safeAddListener('agregar-sesion-futura-btn', 'click', agregarSesionFutura);

  console.log('Event listeners configurados correctamente');
}

/**
 * Valida si el boton de registrar debe estar habilitado
 */
function validateRegisterButton() {
  const btn = document.getElementById('register-btn');
  const therapist = document.getElementById('therapist-select').value;
  const patient = document.getElementById('patient-name').value.trim();
  const modoRegistro = document.querySelector('input[name="modo-registro"]:checked')?.value;

  let isValid = false;

  // Si es sesion grupal, la validacion es diferente (se maneja en el modal)
  if (modoRegistro === 'sesion-grupal') {
    isValid = false; // El boton principal no aplica para grupales
  } else if (modoRegistro === 'usar-credito') {
    // Para creditos, necesita terapeuta y paciente
    isValid = therapist && patient;
  } else {
    // Para pago del dia, necesita terapeuta, paciente y al menos un valor de pago
    const cash = parseInt(document.getElementById('cash-to-neurotea').value) || 0;
    const transferNeurotea = parseInt(document.getElementById('transfer-to-neurotea').value) || 0;
    const transferTerapeuta = parseInt(document.getElementById('transfer-to-therapist').value) || 0;
    const totalPago = cash + transferNeurotea + transferTerapeuta;

    isValid = therapist && patient && totalPago > 0;
  }

  // Actualizar estado del boton
  if (isValid) {
    btn.disabled = false;
    btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
    btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
  } else {
    btn.disabled = true;
    btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
  }
}

/**
 * Actualiza el display de valores de pago en tiempo real
 */
function updatePaymentDisplay() {
  // Leer valores de los campos de pago
  const cash = parseInt(document.getElementById('cash-to-neurotea').value) || 0;
  const transferNeurotea = parseInt(document.getElementById('transfer-to-neurotea').value) || 0;
  const transferTerapeuta = parseInt(document.getElementById('transfer-to-therapist').value) || 0;

  // Calcular valor total de la sesion
  const valorSesion = cash + transferNeurotea + transferTerapeuta;

  // Calcular aporte NeuroTEA segun seleccion
  let aporteNeurotea = 0;
  const contributionType = document.querySelector('input[name="neurotea-contribution"]:checked')?.value;

  if (contributionType === '20') {
    aporteNeurotea = Math.round(valorSesion * 0.20);
  } else if (contributionType === '30') {
    aporteNeurotea = Math.round(valorSesion * 0.30);
  } else if (contributionType === 'fixed') {
    aporteNeurotea = parseInt(document.getElementById('fixed-amount-input').value) || 0;
  }

  // Calcular honorarios terapeuta
  const honorarios = valorSesion - aporteNeurotea;

  // Actualizar displays
  document.getElementById('session-value-display').textContent = formatCurrency(valorSesion);
  document.getElementById('neurotea-contribution-display').textContent = formatCurrency(aporteNeurotea);
  document.getElementById('therapist-fee-display').textContent = formatCurrency(honorarios);

  // Validar boton de registro
  validateRegisterButton();
}

/**
 * Alterna las secciones visibles segun el modo de registro seleccionado
 * (pago-dia, usar-credito, sesion-grupal)
 */
function togglePaymentMode() {
  const modoRegistro = document.querySelector('input[name="modo-registro"]:checked')?.value;

  // Secciones a controlar
  const desgloseSection = document.getElementById('desglose-pago-section');
  const aporteSection = document.getElementById('aporte-neurotea-section');
  const creditoSection = document.getElementById('paciente-credito-section');
  const creditosAdicionalesSection = document.getElementById('creditos-adicionales-section');
  const patientInput = document.getElementById('patient-name');

  // Resetear campos de pago al cambiar modo
  if (desgloseSection) {
    document.getElementById('cash-to-neurotea').value = '';
    document.getElementById('transfer-to-neurotea').value = '';
    document.getElementById('transfer-to-therapist').value = '';
  }

  if (modoRegistro === 'pago-dia') {
    // Mostrar desglose de pago y aporte
    if (desgloseSection) desgloseSection.style.display = 'block';
    if (aporteSection) aporteSection.style.display = 'block';
    if (creditoSection) creditoSection.style.display = 'none';
    if (creditosAdicionalesSection) creditosAdicionalesSection.style.display = 'block';
    if (patientInput) patientInput.disabled = false;

  } else if (modoRegistro === 'usar-credito') {
    // Mostrar selector de pacientes con creditos
    if (desgloseSection) desgloseSection.style.display = 'none';
    if (aporteSection) aporteSection.style.display = 'none';
    if (creditoSection) creditoSection.style.display = 'block';
    if (creditosAdicionalesSection) creditosAdicionalesSection.style.display = 'none';
    if (patientInput) patientInput.disabled = true;

    // Cargar pacientes con creditos
    updateAvailablePatients();

  } else if (modoRegistro === 'sesion-grupal') {
    // Ocultar todo y abrir modal de sesion grupal
    if (desgloseSection) desgloseSection.style.display = 'none';
    if (aporteSection) aporteSection.style.display = 'none';
    if (creditoSection) creditoSection.style.display = 'none';
    if (creditosAdicionalesSection) creditosAdicionalesSection.style.display = 'none';

    // Abrir modal de sesion grupal
    openGroupSessionModal();

    // Resetear radio a pago-dia (replica comportamiento original)
    var modoPagoDia = document.getElementById('modo-pago-dia');
    if (modoPagoDia) modoPagoDia.checked = true;
  }

  // Actualizar display de pagos
  updatePaymentDisplay();
}

/**
 * Actualiza el selector de pacientes que tienen creditos disponibles
 */
function updateAvailablePatients() {
  const terapeuta = document.getElementById('therapist-select').value;
  const select = document.getElementById('paciente-credito-select');
  const infoDisplay = document.getElementById('creditos-info-display');

  if (!select) return;

  // Limpiar selector
  select.innerHTML = '<option value="">Seleccionar paciente...</option>';
  if (infoDisplay) infoDisplay.innerHTML = '';

  if (!terapeuta) {
    if (infoDisplay) infoDisplay.innerHTML = '<p class="text-yellow-600">Primero seleccione un terapeuta</p>';
    return;
  }

  // Obtener todos los creditos activos
  google.script.run
    .withSuccessHandler(function(creditos) {
      // Filtrar creditos con sesiones restantes
      const creditosDisponibles = creditos.filter(c =>
        c.terapeuta === terapeuta && c.restante > 0
      );

      // Agrupar por paciente
      const pacientesConCreditos = {};
      creditosDisponibles.forEach(c => {
        if (!pacientesConCreditos[c.paciente]) {
          pacientesConCreditos[c.paciente] = { total: 0, paquetes: [] };
        }
        pacientesConCreditos[c.paciente].total += c.restante;
        pacientesConCreditos[c.paciente].paquetes.push(c);
      });

      // Llenar selector
      Object.keys(pacientesConCreditos).forEach(paciente => {
        const option = document.createElement('option');
        option.value = paciente;
        option.textContent = `${paciente} (${pacientesConCreditos[paciente].total} creditos)`;
        option.dataset.paquetes = JSON.stringify(pacientesConCreditos[paciente].paquetes);
        select.appendChild(option);
      });

      if (Object.keys(pacientesConCreditos).length === 0) {
        if (infoDisplay) infoDisplay.innerHTML = '<p class="text-gray-500">No hay pacientes con creditos para este terapeuta</p>';
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error cargando creditos:', error);
      if (infoDisplay) infoDisplay.innerHTML = '<p class="text-red-500">Error cargando creditos</p>';
    })
    .getCreditosActivos();

  // Listener para mostrar info al seleccionar paciente
  select.onchange = function() {
    updateCreditInfo(this.value, this.options[this.selectedIndex].dataset.paquetes);
  };
}

/**
 * Muestra informacion del credito seleccionado y selector de paquete
 */
function updateCreditInfo(paciente, paquetesJSON) {
  const infoDisplay = document.getElementById('creditos-info-display');
  const patientInput = document.getElementById('patient-name');
  const paqueteSelectorSection = document.getElementById('paquete-selector-section');
  const paqueteSelectorList = document.getElementById('paquete-selector-list');
  const selectedPaqueteInput = document.getElementById('selected-paquete-id');

  if (!infoDisplay) return;

  if (!paciente || !paquetesJSON) {
    infoDisplay.innerHTML = '';
    if (patientInput) patientInput.value = '';
    if (paqueteSelectorSection) paqueteSelectorSection.style.display = 'none';
    if (selectedPaqueteInput) selectedPaqueteInput.value = '';
    return;
  }

  const paquetes = JSON.parse(paquetesJSON);
  const totalCreditos = paquetes.reduce((sum, p) => sum + p.restante, 0);

  // Actualizar campo de paciente
  if (patientInput) patientInput.value = paciente;

  // Mostrar info basica
  infoDisplay.innerHTML = `
    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg mt-2">
      <p class="font-medium text-blue-800 dark:text-blue-200">Creditos disponibles: ${totalCreditos}</p>
    </div>
  `;

  // Si hay múltiples paquetes, mostrar selector
  if (paquetes.length > 1 && paqueteSelectorSection && paqueteSelectorList) {
    paqueteSelectorSection.style.display = 'block';
    paqueteSelectorList.innerHTML = paquetes.map((p, index) => `
      <div class="flex items-center p-2 bg-white dark:bg-gray-700 border rounded ${index === 0 ? 'border-blue-500' : ''}">
        <input type="radio" name="paquete-credito" id="paquete-${p.paqueteId}"
               value="${p.paqueteId}" ${index === 0 ? 'checked' : ''}
               onchange="selectPaquete('${p.paqueteId}')"
               class="mr-2">
        <label for="paquete-${p.paqueteId}" class="flex-1 text-sm cursor-pointer">
          <span class="font-medium">Paquete #${p.paqueteId.toString().slice(-6)}</span>
          <span class="text-gray-600 dark:text-gray-400 ml-2">${p.restante}/${p.total} sesiones restantes</span>
        </label>
      </div>
    `).join('');

    // Seleccionar el primer paquete por defecto
    if (selectedPaqueteInput) selectedPaqueteInput.value = paquetes[0].paqueteId;
  } else if (paquetes.length === 1) {
    // Solo un paquete, seleccionarlo automaticamente
    if (paqueteSelectorSection) paqueteSelectorSection.style.display = 'none';
    if (selectedPaqueteInput) selectedPaqueteInput.value = paquetes[0].paqueteId;

    // Mostrar info del paquete único
    infoDisplay.innerHTML = `
      <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg mt-2">
        <p class="font-medium text-blue-800 dark:text-blue-200">Creditos disponibles: ${totalCreditos}</p>
        <p class="text-sm text-blue-700 dark:text-blue-300 mt-1">
          Paquete: ${paquetes[0].restante}/${paquetes[0].total} sesiones restantes
        </p>
      </div>
    `;
  } else {
    if (paqueteSelectorSection) paqueteSelectorSection.style.display = 'none';
    if (selectedPaqueteInput) selectedPaqueteInput.value = '';
  }
}

/**
 * Selecciona un paquete específico para usar el crédito
 */
function selectPaquete(paqueteId) {
  const selectedPaqueteInput = document.getElementById('selected-paquete-id');
  if (selectedPaqueteInput) {
    selectedPaqueteInput.value = paqueteId;
  }

  // Actualizar estilos de selección
  const radios = document.querySelectorAll('input[name="paquete-credito"]');
  radios.forEach(radio => {
    const container = radio.closest('div');
    if (container) {
      if (radio.value === paqueteId) {
        container.classList.add('border-blue-500');
        container.classList.remove('border-gray-200');
      } else {
        container.classList.remove('border-blue-500');
        container.classList.add('border-gray-200');
      }
    }
  });
}

/**
 * Inicializa el selector de terapeutas para sesiones futuras
 */
function initTerapeutasFuturasSelect() {
  const select = document.getElementById('terapeuta-futura-select');
  if (!select) return;

  select.innerHTML = '<option value="">Seleccionar terapeuta...</option>';

  terapeutas.forEach(t => {
    const nombre = typeof t === 'string' ? t : t.nombre;
    const option = document.createElement('option');
    option.value = nombre;
    option.textContent = nombre;
    select.appendChild(option);
  });
}

/**
 * Maneja el cambio de tipo de egreso (mostrar/ocultar selector de terapeuta)
 */
function handleEgresoTypeChange() {
  const tipoSelect = document.getElementById('egreso-type');
  const terapeutaContainer = document.getElementById('egreso-therapist-container');

  if (!tipoSelect || !terapeutaContainer) return;

  if (tipoSelect.value === 'adelanto') {
    terapeutaContainer.style.display = 'block';
  } else {
    terapeutaContainer.style.display = 'none';
  }
}

/**
 * Actualiza los calculos del formulario de paquetes en tiempo real
 */
function updatePackageCalculations() {
  // Leer valores
  const sessions = parseInt(document.getElementById('package-sessions').value) || 0;
  const cash = parseNumber(document.getElementById('package-cash').value);
  const transferTherapist = parseNumber(document.getElementById('package-transfer-therapist').value);
  const transferNeurotea = parseNumber(document.getElementById('package-transfer-neurotea').value);

  // Calcular total del paquete
  const total = cash + transferTherapist + transferNeurotea;

  // Calcular aporte NeuroTEA segun seleccion
  let aporteNeurotea = 0;
  const contributionType = document.querySelector('input[name="package-neurotea-contribution"]:checked')?.value;

  if (contributionType === '20') {
    aporteNeurotea = Math.round(total * 0.20);
  } else if (contributionType === '30') {
    aporteNeurotea = Math.round(total * 0.30);
  } else if (contributionType === 'fixed') {
    aporteNeurotea = parseNumber(document.getElementById('package-fixed-amount-input').value);
  }

  // Calcular honorarios terapeuta
  const honorarios = total - aporteNeurotea;

  // Calcular valor por sesion
  const perSession = sessions > 0 ? Math.round(total / sessions) : 0;

  // Actualizar displays
  document.getElementById('package-total').textContent = formatCurrency(total);
  document.getElementById('package-aporte-neurotea').textContent = formatCurrency(aporteNeurotea);
  document.getElementById('package-honorarios-terapeuta').textContent = formatCurrency(honorarios);
  document.getElementById('package-per-session').textContent = formatCurrency(perSession);

  // Habilitar/deshabilitar boton de crear paquete
  const createBtn = document.getElementById('create-package-btn');
  if (createBtn) {
    const terapeuta = document.getElementById('package-therapist')?.value;
    const paciente = document.getElementById('package-patient-name')?.value?.trim();
    const isValid = terapeuta && paciente && sessions > 0 && total > 0;
    createBtn.disabled = !isValid;
  }
}

// ===========================
// ACTUALIZACION DE VISTAS
// ===========================

/**
 * Actualiza todas las vistas
 */
function updateAllViews() {
  const viewUpdaters = [
    { name: 'TherapistSelects', fn: updateTherapistSelects },
    { name: 'SessionsList', fn: updateSessionsList },
    { name: 'SummaryView', fn: updateSummaryView },
    { name: 'TransfersView', fn: updateTransfersView },
    { name: 'RendicionView', fn: updateRendicionView },
    { name: 'EgresosList', fn: updateEgresosList },
    { name: 'TherapistsList', fn: updateTherapistsList },
    { name: 'PackagesList', fn: updatePackagesList },
    { name: 'GroupsList', fn: updateGroupsList },
    { name: 'GroupSelects', fn: updateGroupSelects },
    { name: 'AdminView', fn: updateAdminView },
    { name: 'SaldoBadge', fn: updateSaldoBadge }
  ];

  viewUpdaters.forEach(updater => {
    try {
      updater.fn();
    } catch (error) {
      console.error('Error en update' + updater.name + ':', error);
    }
  });

  // Actualizar iconos de Lucide
  try {
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
      lucide.createIcons();
    }
  } catch (error) {
    console.error('Error creando iconos Lucide:', error);
  }
}

/**
 * Actualiza los selectores de terapeutas
 */
function updateTherapistSelects() {
  const selects = [
    'therapist-select',
    'egreso-therapist-select',
    'package-therapist'
  ];

  selects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (!select) return;

    const currentValue = select.value;
    select.innerHTML = '<option value="">Seleccione terapeuta...</option>';

    terapeutas.forEach(t => {
      const name = typeof t === 'string' ? t : t.nombre;
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      select.appendChild(option);
    });

    select.value = currentValue;
  });

  // Actualizar contadores de terapeutas
  const count = terapeutas.length;
  const counterText = count + ' terapeuta' + (count !== 1 ? 's' : '') + ' disponibles';
  const counter = document.getElementById('therapist-counter');
  if (counter) counter.textContent = counterText;
  const listCounter = document.getElementById('therapist-list-counter');
  if (listCounter) listCounter.textContent = counterText;

  // Actualizar checkboxes de terapeutas para sesiones grupales
  updateGroupTherapistCheckboxes();
}

/**
 * Actualiza checkboxes de terapeutas para grupos
 */
function updateGroupTherapistCheckboxes() {
  const container = document.getElementById('group-therapists-list');
  if (!container) return;

  container.innerHTML = '';

  terapeutas.forEach(t => {
    const name = typeof t === 'string' ? t : t.nombre;
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-2';
    div.innerHTML = `
      <input type="checkbox" id="group-therapist-${name}" value="${name}" class="form-checkbox group-therapist-checkbox">
      <label for="group-therapist-${name}" class="text-sm text-gray-700 dark:text-gray-300">${name}</label>
    `;
    container.appendChild(div);
  });
}

/**
 * Alterna la visibilidad de un grupo de terapeuta
 */
function toggleTherapistGroup(therapistName, type) {
  type = type || 'normal';
  const sanitizedName = therapistName.replace(/[^a-zA-Z0-9]/g, '_');
  const sessionsContainer = document.getElementById('sessions-' + sanitizedName + '_' + type);
  const chevron = document.getElementById('chevron-' + sanitizedName + '_' + type);

  if (sessionsContainer && chevron) {
    if (sessionsContainer.classList.contains('hidden')) {
      sessionsContainer.classList.remove('hidden');
      chevron.classList.add('rotate-180');
    } else {
      sessionsContainer.classList.add('hidden');
      chevron.classList.remove('rotate-180');
    }
  }
}

/**
 * Alterna la visibilidad de sesiones de un grupo especifico
 */
function toggleGroupSection(groupId) {
  const sanitizedId = groupId.replace(/[^a-zA-Z0-9]/g, '_');
  const sessionsContainer = document.getElementById('sessions-group-' + sanitizedId);
  const chevron = document.getElementById('chevron-group-' + sanitizedId);

  if (sessionsContainer && chevron) {
    if (sessionsContainer.classList.contains('hidden')) {
      sessionsContainer.classList.remove('hidden');
      chevron.classList.add('rotate-180');
    } else {
      sessionsContainer.classList.add('hidden');
      chevron.classList.remove('rotate-180');
    }
  }
}

/**
 * Formatea el indicador de tipo de aporte
 */
function formatContributionIndicator(item) {
  if (!item) return '';

  // Para sesiones individuales
  if (item.tipoAporte) {
    if (item.tipoAporte === 'fixed' || item.tipoAporte === 'fijo') {
      return '(Fijo)';
    }
    return '(' + item.tipoAporte + '%)';
  }

  // Para sesiones grupales - usar porcentajeAporte del grupo
  if (item.porcentajeAporte !== undefined) {
    return '(' + item.porcentajeAporte + '%)';
  }

  // Calcular porcentaje si no esta guardado
  if (item.valorSesion && item.aporteNeurotea) {
    const calculatedPercentage = Math.round((item.aporteNeurotea / item.valorSesion) * 100);
    return '(' + calculatedPercentage + '%)';
  }

  if (item.valorTotal && item.aporteNeurotea) {
    const calculatedPercentage = Math.round((item.aporteNeurotea / item.valorTotal) * 100);
    return '(' + calculatedPercentage + '%)';
  }

  return '';
}

/**
 * Calcula el uso de creditos de una sesion
 */
function calculateCreditUsage(session) {
  try {
    // Buscar info de creditos del paciente
    const creditInfo = paquetesActivos.find(p =>
      p.paciente === session.paciente && p.terapeuta === session.terapeuta
    );

    if (creditInfo && creditInfo.sesionesTotal && creditInfo.sesionesRestantes !== undefined) {
      const total = creditInfo.sesionesTotal;
      const remaining = creditInfo.sesionesRestantes;
      const used = total - remaining;
      return 'Credito Usado ' + used + '/' + total;
    }

    // Usar info de la sesion si existe
    if (session.creditosRestantes !== undefined) {
      return 'Creditos restantes: ' + session.creditosRestantes;
    }

    return 'Credito Usado';
  } catch (error) {
    console.warn('Error calculando uso de creditos:', error);
    return 'Credito Usado';
  }
}

/**
 * Actualiza la lista de sesiones del dia
 * Estructura: Acordeones agrupados por terapeuta con sesiones grupales e individuales
 */
function updateSessionsList() {
  try {
    const container = document.getElementById('daily-sessions-container');
    if (!container) return;

    if (sesiones.length === 0 && sesionesGrupales.length === 0) {
      container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No hay sesiones registradas para este dia</p>';
      return;
    }

    let finalHTML = '';

    // ========================================
    // SECCION DE SESIONES GRUPALES (verde) - Agrupadas por GRUPO
    // ========================================
    if (sesionesGrupales.length > 0) {
      // Agrupar sesiones grupales por grupoId
      const sessionsByGroup = {};
      sesionesGrupales.forEach(gs => {
        if (!sessionsByGroup[gs.grupoId]) {
          sessionsByGroup[gs.grupoId] = [];
        }
        sessionsByGroup[gs.grupoId].push(gs);
      });

      Object.keys(sessionsByGroup).forEach(groupId => {
        const groupConfig = gruposActivos.find(g => g.id == groupId);
        const groupName = groupConfig ? groupConfig.nombre : (sessionsByGroup[groupId][0].grupoNombre || 'Grupo');
        const groupSessionsList = sessionsByGroup[groupId];
        const sessionCount = groupSessionsList.length;
        const totalGroupValue = groupSessionsList.reduce((sum, gs) => sum + (gs.valorTotal || 0), 0);

        const groupSessionsHTML = groupSessionsList.map(gs => {
          const asistencia = gs.asistencia || [];
          const presentChildren = asistencia.filter(a => a.presente).length;
          const totalChildren = asistencia.length;
          const therapistCount = gs.cantidadTerapeutas || (gs.terapeutas ? gs.terapeutas.length : 1);

          // Lista de ninos presentes
          const presentChildrenNames = asistencia
            .filter(a => a.presente)
            .map(a => a.nombre)
            .join(', ');

          // Lista de terapeutas
          const therapistNames = gs.terapeutas ? gs.terapeutas.join(', ') : 'Sin terapeutas';

          return '<div class="p-3 border-l-4 border-green-400 bg-green-50 dark:bg-green-900/30 ml-4 mb-2">' +
            '<div class="flex justify-between items-start mb-2">' +
              '<div>' +
                '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-200 text-green-800 dark:bg-green-700 dark:text-green-200">' +
                  'GRUPAL ÷' + therapistCount +
                '</span>' +
              '</div>' +
              '<div class="flex space-x-1">' +
                '<button onclick="editGroupSession(' + gs.id + ')" class="text-blue-500 hover:text-blue-700 p-1">' +
                  '<i data-lucide="edit" class="w-4 h-4"></i>' +
                '</button>' +
                '<button onclick="deleteGroupSession(' + gs.id + ')" class="text-red-500 hover:text-red-700 p-1">' +
                  '<i data-lucide="trash-2" class="w-4 h-4"></i>' +
                '</button>' +
              '</div>' +
            '</div>' +
            '<div class="text-sm text-green-700 dark:text-green-300 mb-2">' +
              '<div class="font-medium mb-1">Presentes (' + presentChildren + '/' + totalChildren + '):</div>' +
              '<div class="ml-2 text-green-600 dark:text-green-400">' + (presentChildrenNames || 'Ninguno') + '</div>' +
            '</div>' +
            '<div class="text-sm text-green-700 dark:text-green-300 mb-2">' +
              '<div class="font-medium">Terapeutas:</div>' +
              '<div class="ml-2">' + therapistNames + '</div>' +
            '</div>' +
            '<div class="grid grid-cols-2 gap-2 text-sm text-green-700 dark:text-green-300 border-t border-green-200 dark:border-green-700 pt-2 mt-2">' +
              '<div>Valor Total: ' + formatCurrency(gs.valorTotal) + '</div>' +
              '<div>Aporte NeuroTEA: ' + formatCurrency(gs.aporteNeurotea) + ' ' + formatContributionIndicator(gs) + '</div>' +
              '<div>Hon. c/Terapeuta: ' + formatCurrency(gs.honorariosPorTerapeuta) + '</div>' +
              '<div>Efectivo: ' + formatCurrency(gs.efectivo || 0) + '</div>' +
            '</div>' +
          '</div>';
        }).join('');

        const sanitizedGroupId = groupId.toString().replace(/[^a-zA-Z0-9]/g, '_');

        finalHTML += '<div class="mb-4 border rounded-md bg-white dark:bg-gray-800 overflow-hidden border-green-300">' +
          '<div class="bg-green-100 dark:bg-green-800 p-4 cursor-pointer hover:bg-green-200 dark:hover:bg-green-700 transition-colors"' +
               ' onclick="toggleGroupSection(\'' + groupId.toString().replace(/'/g, "\\'") + '\')">' +
            '<div class="flex justify-between items-center">' +
              '<h4 class="font-semibold text-green-800 dark:text-green-200 flex items-center">' +
                '<i data-lucide="users" class="w-5 h-5 mr-2"></i>' +
                groupName +
              '</h4>' +
              '<div class="flex items-center space-x-2">' +
                '<span class="text-sm text-green-600 dark:text-green-300">' + sessionCount + ' sesion' + (sessionCount !== 1 ? 'es' : '') + ' - ' + formatCurrency(totalGroupValue) + '</span>' +
                '<i data-lucide="chevron-down" class="w-4 h-4 text-green-600 dark:text-green-300 transform transition-transform" id="chevron-group-' + sanitizedGroupId + '"></i>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="hidden p-4" id="sessions-group-' + sanitizedGroupId + '">' +
            groupSessionsHTML +
          '</div>' +
        '</div>';
      });
    }

    // ========================================
    // SECCION DE SESIONES INDIVIDUALES - Agrupadas por terapeuta
    // ========================================
    const sessionsByTherapist = {};
    sesiones.forEach(session => {
      if (!sessionsByTherapist[session.terapeuta]) {
        sessionsByTherapist[session.terapeuta] = {
          normal: [],
          credits: [],
          groupParticipations: []
        };
      }

      // Separar sesiones normales de sesiones con credito
      if (session.usaCredito === true) {
        sessionsByTherapist[session.terapeuta].credits.push(session);
      } else {
        sessionsByTherapist[session.terapeuta].normal.push(session);
      }
    });

    // Agregar participaciones grupales a cada terapeuta
    sesionesGrupales.forEach(gs => {
      const terapeutasList = gs.terapeutas || [];
      if (terapeutasList.length > 0) {
        const therapistCount = terapeutasList.length;
        const groupConfig = gruposActivos.find(g => g.id == gs.grupoId);
        const groupName = groupConfig ? groupConfig.nombre : (gs.grupoNombre || 'Grupo');

        terapeutasList.forEach((therapist, index) => {
          if (!sessionsByTherapist[therapist]) {
            sessionsByTherapist[therapist] = {
              normal: [],
              credits: [],
              groupParticipations: []
            };
          }

          // Calcular valor proporcional para esta terapeuta
          const isFirstTherapist = index === 0;
          const baseValue = Math.floor(gs.valorTotal / therapistCount);
          const residuo = gs.valorTotal - (baseValue * therapistCount);
          const valorProporcional = baseValue + (isFirstTherapist ? residuo : 0);

          // Calcular aporte NeuroTEA proporcional
          const baseAporte = Math.floor(gs.aporteNeurotea / therapistCount);
          const residuoAporte = gs.aporteNeurotea - (baseAporte * therapistCount);
          const aporteProporcional = baseAporte + (isFirstTherapist ? residuoAporte : 0);

          // Calcular honorarios proporcionales
          const honorariosProporcionales = valorProporcional - aporteProporcional;

          // Calcular porcentaje de aporte
          const porcentajeAporte = valorProporcional > 0
            ? Math.round((aporteProporcional / valorProporcional) * 100)
            : 0;

          sessionsByTherapist[therapist].groupParticipations.push({
            groupName: groupName,
            totalValue: gs.valorTotal,
            therapistCount: therapistCount,
            valorProporcional: valorProporcional,
            aporteProporcional: aporteProporcional,
            honorariosProporcionales: honorariosProporcionales,
            porcentajeAporte: porcentajeAporte
          });
        });
      }
    });

    // Generar HTML agrupado por terapeuta
    const therapistGroups = Object.keys(sessionsByTherapist).sort().map(therapist => {
      const normalSessions = sessionsByTherapist[therapist].normal;
      const creditSessions = sessionsByTherapist[therapist].credits;
      const groupParticipations = sessionsByTherapist[therapist].groupParticipations || [];

      let html = '';

      // Calcular totales incluyendo participaciones grupales
      const normalTotalValue = normalSessions.reduce((sum, s) => sum + (s.valorSesion || 0), 0);
      const groupTotalValue = groupParticipations.reduce((sum, gp) => sum + gp.valorProporcional, 0);
      const totalCount = normalSessions.length + groupParticipations.length;
      const totalValue = normalTotalValue + groupTotalValue;

      const sanitizedName = therapist.replace(/[^a-zA-Z0-9]/g, '_');

      // SECCION NORMAL (azul) - si hay sesiones normales O participaciones grupales
      if (normalSessions.length > 0 || groupParticipations.length > 0) {
        // HTML de sesiones individuales normales
        const normalSessionsHTML = normalSessions.map(session => {
          return '<div class="p-3 border-l-4 border-blue-300 bg-gray-50 dark:bg-gray-700 ml-4 mb-2">' +
            '<div class="flex justify-between items-start mb-2">' +
              '<h5 class="font-semibold text-gray-800 dark:text-gray-200">' + (session.paciente || 'Sin nombre') + '</h5>' +
              '<div class="flex space-x-1">' +
                '<button onclick="editSession(' + session.id + ')" class="text-blue-500 hover:text-blue-700 p-1">' +
                  '<i data-lucide="edit" class="w-4 h-4"></i>' +
                '</button>' +
                '<button onclick="deleteSession(' + session.id + ')" class="text-red-500 hover:text-red-700 p-1">' +
                  '<i data-lucide="trash-2" class="w-4 h-4"></i>' +
                '</button>' +
              '</div>' +
            '</div>' +
            '<div class="grid grid-cols-2 gap-2 text-sm">' +
              '<div>Efectivo: ' + formatCurrency(session.efectivo) + '</div>' +
              '<div>Transf. Terapeuta: ' + formatCurrency(session.transferenciaTerapeuta) + '</div>' +
              '<div>Transf. NeuroTEA: ' + formatCurrency(session.transferenciaNeurotea) + '</div>' +
              '<div class="font-bold">Total: ' + formatCurrency(session.valorSesion) + '</div>' +
              '<div>Aporte NeuroTEA: ' + formatCurrency(session.aporteNeurotea) + ' ' + formatContributionIndicator(session) + '</div>' +
              '<div>Honorarios: ' + formatCurrency(session.honorarios) + '</div>' +
            '</div>' +
          '</div>';
        }).join('');

        // HTML de participaciones grupales (tarjetas informativas)
        const groupParticipationsHTML = groupParticipations.map(gp => {
          return '<div class="p-3 border-l-4 border-green-400 bg-gray-50 dark:bg-gray-700 ml-4 mb-2">' +
            '<div class="flex justify-between items-start mb-2">' +
              '<h5 class="font-semibold text-gray-800 dark:text-gray-200">' + gp.groupName + '</h5>' +
              '<div class="flex items-center space-x-2">' +
                '<span class="text-xs font-medium px-2 py-1 rounded bg-green-200 text-green-800 dark:bg-green-700 dark:text-green-200">Terapia Grupal</span>' +
                '<span class="text-blue-500 cursor-help" title="Participacion en sesion grupal. Para eliminar, use el registro del grupo.">' +
                  '<i data-lucide="info" class="w-4 h-4"></i>' +
                '</span>' +
              '</div>' +
            '</div>' +
            '<div class="text-sm text-gray-600 dark:text-gray-300 space-y-1">' +
              '<div class="font-medium">' + formatCurrency(gp.totalValue) + ' ÷ ' + gp.therapistCount + ' = ' + formatCurrency(gp.valorProporcional) + '</div>' +
              '<div>Aporte NeuroTEA: ' + formatCurrency(gp.aporteProporcional) + ' (' + gp.porcentajeAporte + '%)</div>' +
              '<div>Honorarios: ' + formatCurrency(gp.honorariosProporcionales) + '</div>' +
            '</div>' +
          '</div>';
        }).join('');

        html += '<div class="mb-4 border rounded-md bg-white dark:bg-gray-800 overflow-hidden">' +
          '<div class="bg-blue-50 dark:bg-blue-900 p-4 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-800 transition-colors"' +
               ' onclick="toggleTherapistGroup(\'' + therapist.replace(/'/g, "\\'") + '\', \'normal\')">' +
            '<div class="flex justify-between items-center">' +
              '<h4 class="font-semibold text-blue-800 dark:text-blue-200">' + therapist + '</h4>' +
              '<div class="flex items-center space-x-2">' +
                '<span class="text-sm text-blue-600 dark:text-blue-300">' + totalCount + ' sesion' + (totalCount !== 1 ? 'es' : '') + ' - ' + formatCurrency(totalValue) + '</span>' +
                '<i data-lucide="chevron-down" class="w-4 h-4 text-blue-600 dark:text-blue-300 transform transition-transform" id="chevron-' + sanitizedName + '_normal"></i>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="hidden p-4" id="sessions-' + sanitizedName + '_normal">' +
            normalSessionsHTML +
            groupParticipationsHTML +
          '</div>' +
        '</div>';
      }

      // SECCION CREDITOS (beige) - solo si hay sesiones con credito
      if (creditSessions.length > 0) {
        const creditCount = creditSessions.length;

        const creditSessionsHTML = creditSessions.map(session => {
          const creditUsage = calculateCreditUsage(session);
          return '<div class="session-credit p-3 border-l-4 ml-4 mb-2">' +
            '<div class="flex justify-between items-start mb-2">' +
              '<h5 class="font-semibold credit-text-bold">' + (session.paciente || 'Sin nombre') + '</h5>' +
              '<button onclick="deleteSession(' + session.id + ')" class="text-red-500 hover:text-red-700 p-1">' +
                '<i data-lucide="trash-2" class="w-4 h-4"></i>' +
              '</button>' +
            '</div>' +
            '<div class="grid grid-cols-2 gap-2 text-sm">' +
              '<div class="credit-text-secondary">Efectivo: Gs 0</div>' +
              '<div class="credit-text-secondary">Transf. Terapeuta: Gs 0</div>' +
              '<div class="credit-text-secondary">Transf. NeuroTEA: Gs 0</div>' +
              '<div class="font-bold credit-text-bold">' + creditUsage + '</div>' +
              '<div class="credit-text-secondary">Aporte NeuroTEA: Gs 0</div>' +
              '<div class="credit-text-secondary">Honorarios: Gs 0</div>' +
            '</div>' +
          '</div>';
        }).join('');

        html += '<div class="mb-4 border rounded-md bg-white dark:bg-gray-800 overflow-hidden">' +
          '<div class="therapist-section-credits p-4 cursor-pointer transition-colors"' +
               ' onclick="toggleTherapistGroup(\'' + therapist.replace(/'/g, "\\'") + '\', \'credits\')">' +
            '<div class="flex justify-between items-center">' +
              '<h4 class="font-semibold credit-text-bold">' + therapist + '</h4>' +
              '<div class="flex items-center space-x-2">' +
                '<span class="text-sm credit-text-primary">' + creditCount + ' sesion' + (creditCount !== 1 ? 'es' : '') + ' - Gs 0</span>' +
                '<i data-lucide="chevron-down" class="w-4 h-4 credit-text-primary transform transition-transform" id="chevron-' + sanitizedName + '_credits"></i>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="hidden p-4" id="sessions-' + sanitizedName + '_credits">' +
            creditSessionsHTML +
          '</div>' +
        '</div>';
      }

      return html;
    }).join('');

    finalHTML += therapistGroups;
    container.innerHTML = finalHTML;

    // Actualizar iconos de Lucide
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
      lucide.createIcons();
    }

  } catch (error) {
    console.error('Error en updateSessionsList:', error);
    const container = document.getElementById('daily-sessions-container');
    if (container) {
      container.innerHTML = '<p class="text-red-500 text-center py-4">Error al cargar sesiones. Revise la consola.</p>';
    }
  }
}

/**
 * Actualiza la vista de resumen
 */
function updateSummaryView() {
  try {
    // Calcular ingresos por tipo (sesiones, grupales, paquetes)
    const sessionIncome = sesiones.filter(s => !s.usaCredito).reduce((sum, s) => sum + (s.valorSesion || 0), 0);
    const packageIncome = paquetesFecha.reduce((sum, p) => sum + (p.valorTotal || 0), 0);
    const groupIncome = sesionesGrupales.reduce((sum, gs) => sum + (gs.valorTotal || 0), 0);
    const ingresoTotal = sessionIncome + packageIncome + groupIncome;

    // Aporte NeuroTEA
    const sessionAporte = sesiones.filter(s => !s.usaCredito).reduce((sum, s) => sum + (s.aporteNeurotea || 0), 0);
    const packageAporte = paquetesFecha.reduce((sum, p) => sum + (p.aporteNeurotea || 0), 0);
    const groupAporte = sesionesGrupales.reduce((sum, gs) => sum + (gs.aporteNeurotea || 0), 0);
    const totalContribution = sessionAporte + packageAporte + groupAporte;

    // Efectivo bruto del dia (sin restar pagos confirmados)
    const sessionEfectivo = sesiones.reduce((sum, s) => sum + (s.efectivo || 0), 0);
    const packageEfectivo = paquetesFecha.reduce((sum, p) => sum + (p.efectivo || 0), 0);
    const groupEfectivo = sesionesGrupales.reduce((sum, gs) => sum + (gs.efectivo || 0), 0);
    const totalEfectivo = sessionEfectivo + packageEfectivo + groupEfectivo;

    // Transferencias a cuenta NeuroTEA (bruto)
    const sessionTransfNeurotea = sesiones.filter(s => !s.usaCredito).reduce((sum, s) => sum + (s.transferenciaNeurotea || 0), 0);
    const packageTransfNeurotea = paquetesFecha.reduce((sum, p) => sum + (p.transferenciaNeurotea || 0), 0);
    const groupTransfNeurotea = sesionesGrupales.reduce((sum, gs) => sum + (gs.transferenciaNeurotea || 0), 0);

    // Total egresos
    const totalEgresos = egresos.reduce((sum, e) => sum + (e.monto || 0), 0);

    // SALDO CAJA = Saldo inicial + efectivo ingresado - egresos - pagos confirmados en efectivo
    const saldoCaja = calcularSaldoCajaLocal();

    // CUENTA NEUROTEA = Transferencias recibidas - transferencias salientes (pagos confirmados)
    const saldoCuentaNeuroTEA = calcularCuentaNeuroTEALocal();

    // Actualizar dashboard cards
    const elements = {
      'dashboard-ingreso-total': ingresoTotal,
      'dashboard-aporte-neurotea': totalContribution,
      'dashboard-saldo-caja': saldoCaja,
      'dashboard-total-efectivo': totalEfectivo,
      'dashboard-cuenta-neurotea': saldoCuentaNeuroTEA,
      'dashboard-total-egresos': totalEgresos
    };

    Object.entries(elements).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el) el.textContent = formatCurrency(value);
    });

    // Actualizar cards en rendicion tambien
    const rendicionBanco = document.getElementById('rendicion-banco');
    if (rendicionBanco) rendicionBanco.textContent = formatCurrency(saldoCuentaNeuroTEA);

    const rendicionSaldoCaja = document.getElementById('rendicion-saldo-caja');
    if (rendicionSaldoCaja) rendicionSaldoCaja.textContent = formatCurrency(saldoCaja);

    const totalEgresosDisplay = document.getElementById('total-egresos-display');
    if (totalEgresosDisplay) totalEgresosDisplay.textContent = formatCurrency(totalEgresos);

    // Actualizar tabla de resumen por terapeuta
    updateSummaryTable();

  } catch (error) {
    console.error('Error en updateSummaryView:', error);
  }
}

/**
 * Calcula el saldo en caja de forma DINAMICA (replica calcularSaldoCajaReal del original)
 * Saldo = Inicial + Efectivo ingresado - Egresos - Pagos confirmados en efectivo
 */
function calcularSaldoCajaLocal() {
  let saldo = saldoInicial || 0;

  // Sumar efectivo de sesiones
  sesiones.forEach(s => { saldo += s.efectivo || 0; });

  // Sumar efectivo de sesiones grupales
  sesionesGrupales.forEach(gs => { saldo += gs.efectivo || 0; });

  // Sumar efectivo de paquetes comprados en la fecha
  paquetesFecha.forEach(p => { saldo += p.efectivo || 0; });

  // Restar egresos
  egresos.forEach(e => { saldo -= e.monto || 0; });

  // Restar pagos confirmados en efectivo a terapeutas
  const confs = Array.isArray(confirmaciones) ? confirmaciones : [];
  confs.forEach(c => {
    const flujo = c.flujo || c.flujoJSON || {};
    // Efectivo que salio de caja
    saldo -= flujo.efectivoUsado || 0;
    // Vuelto en efectivo regresa a caja
    saldo += flujo.vueltoEfectivo || 0;
    // Si la terapeuta entrego efectivo, se suma a caja
    if (c.tipo === 'LA TERAPEUTA DEBE DAR' && flujo.efectivoRecibido) {
      saldo += flujo.efectivoRecibido;
    }
  });

  return Math.max(0, saldo);
}

/**
 * Calcula el saldo en cuenta NeuroTEA de forma DINAMICA (replica calcularSaldoCuentaNeuroTEA del original)
 * Saldo = Transferencias recibidas - Transferencias salientes por confirmaciones
 */
function calcularCuentaNeuroTEALocal() {
  let saldo = 0;

  // Sumar transferencias a NeuroTEA de sesiones
  sesiones.forEach(s => { saldo += s.transferenciaNeurotea || 0; });

  // Sumar transferencias de sesiones grupales
  sesionesGrupales.forEach(gs => { saldo += gs.transferenciaNeurotea || 0; });

  // Sumar transferencias de paquetes
  paquetesFecha.forEach(p => { saldo += p.transferenciaNeurotea || 0; });

  // Considerar confirmaciones de pago que afectan la cuenta
  const confs = Array.isArray(confirmaciones) ? confirmaciones : [];
  confs.forEach(c => {
    const flujo = c.flujo || c.flujoJSON || {};
    // Restar transferencias confirmadas (dinero que salio de la cuenta)
    saldo -= flujo.bancoUsado || 0;
    // Sumar vueltos por transferencia (regresa a cuenta)
    saldo += flujo.vueltoTransferencia || 0;
  });

  return Math.max(0, saldo);
}

/**
 * Actualiza tabla de resumen por terapeuta
 */
function updateSummaryTable() {
  const tbody = document.getElementById('rendicion-therapist-table-body');

  // Agrupar por terapeuta
  const byTherapist = {};

  terapeutas.forEach(t => {
    const name = typeof t === 'string' ? t : t.nombre;
    byTherapist[name] = {
      sesiones: 0,
      valor: 0,
      aporte: 0,
      honorarios: 0
    };
  });

  // Sesiones individuales
  sesiones.forEach(s => {
    if (!byTherapist[s.terapeuta]) return;
    byTherapist[s.terapeuta].sesiones++;
    if (!s.usaCredito) {
      byTherapist[s.terapeuta].valor += s.valorSesion || 0;
      byTherapist[s.terapeuta].aporte += s.aporteNeurotea || 0;
      byTherapist[s.terapeuta].honorarios += s.honorarios || 0;
    }
  });

  // Sesiones grupales (proporcionales)
  sesionesGrupales.forEach(gs => {
    const therapists = gs.terapeutas || [];
    const count = therapists.length || 1;

    therapists.forEach((t, index) => {
      if (!byTherapist[t]) return;
      byTherapist[t].sesiones++;

      const valorProp = Math.floor(gs.valorTotal / count);
      const aporteProp = Math.floor(gs.aporteNeurotea / count);
      const honorariosProp = gs.honorariosPorTerapeuta + (index === 0 ? gs.residuoHonorarios || 0 : 0);

      byTherapist[t].valor += valorProp;
      byTherapist[t].aporte += aporteProp;
      byTherapist[t].honorarios += honorariosProp;
    });
  });

  // Generar HTML
  let html = '';
  let hasData = false;

  Object.keys(byTherapist).forEach(name => {
    const data = byTherapist[name];
    if (data.sesiones === 0) return;
    hasData = true;

    html += `
      <tr class="border-b dark:border-gray-700">
        <td class="table-cell font-medium">${name}</td>
        <td class="table-cell">${data.sesiones}</td>
        <td class="table-cell">${formatCurrency(data.valor)}</td>
        <td class="table-cell">${formatCurrency(data.aporte)}</td>
        <td class="table-cell">${formatCurrency(data.honorarios)}</td>
        <td class="table-cell">
          <span class="badge badge-info">Ver rendicion</span>
        </td>
      </tr>
    `;
  });

  if (!hasData) {
    html = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Sin datos para mostrar</td></tr>';
  }

  tbody.innerHTML = html;
}

/**
 * Actualiza vista de transferencias (agrupadas por destinatario como el original)
 */
function updateTransfersView() {
  const container = document.getElementById('transfers-container');
  if (!container) return;

  google.script.run
    .withSuccessHandler(function(transfers) {
      if (!transfers || transfers.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay transferencias registradas para este dia</p>';
        return;
      }

      // Agrupar transferencias por destinatario
      const transfersByDestination = {};
      transfers.forEach(function(transfer) {
        const dest = transfer.destinatario || transfer.terapeuta || 'NeuroTEA';
        if (!transfersByDestination[dest]) {
          transfersByDestination[dest] = [];
        }
        transfersByDestination[dest].push(transfer);
      });

      // Generar HTML agrupado
      const destinationGroups = Object.keys(transfersByDestination).sort().map(function(destinatario) {
        const destinationTransfers = transfersByDestination[destinatario];
        const transferCount = destinationTransfers.length;
        const totalAmount = destinationTransfers.reduce(function(sum, t) { return sum + (t.monto || 0); }, 0);

        const transfersHTML = destinationTransfers.map(function(transfer) {
          const isNeuroTEA = destinatario === 'NeuroTEA';
          const isGroupSession = transfer.isGrupal || false;
          const borderColor = isGroupSession ? 'border-green-400' : (isNeuroTEA ? 'border-blue-300' : 'border-purple-300');
          const badgeColor = isGroupSession ? 'bg-green-100 text-green-800' :
                            (transfer.tipo === 'A NeuroTEA' ? 'bg-blue-100 text-blue-800' :
                            (transfer.tipo === 'Vuelto de Terapeuta' ? 'bg-orange-100 text-orange-800' :
                            'bg-purple-100 text-purple-800'));

          // Boton de confirmacion solo para transferencias a NeuroTEA
          let confirmationButton = '';
          if (isNeuroTEA) {
            const isConfirmed = transfer.confirmado || false;
            const statusClass = isConfirmed ? 'confirmed' : 'pending';
            const statusText = isConfirmed ? 'Confirmado' : 'Pendiente';

            confirmationButton = '<button class="transfer-status-btn ' + statusClass + '" ' +
              'onclick="toggleTransferConfirmation(\'' + transfer.id + '\')">' +
              '<span class="status-icon">' + (isConfirmed ? '&#10003;' : '&#10060;') + '</span> ' +
              statusText + '</button>';
          }

          return '<div class="p-3 border-l-4 ' + borderColor + ' bg-gray-50 dark:bg-gray-700 ml-4 mb-2">' +
            '<div class="flex justify-between items-center mb-2">' +
              '<h5 class="font-semibold text-gray-800 dark:text-gray-200">' + (transfer.concepto || transfer.tipo || 'Transferencia') + '</h5>' +
              confirmationButton +
              '<span class="text-sm px-2 py-1 rounded-full ' + badgeColor + '">' + (transfer.tipo || 'Transferencia') + '</span>' +
            '</div>' +
            '<div class="patient-info mb-2">' + (transfer.paciente || 'Sin paciente') + '</div>' +
            '<div class="text-lg font-bold text-gray-900 dark:text-gray-100">' + formatCurrency(transfer.monto || 0) + '</div>' +
          '</div>';
        }).join('');

        const isNeuroTEA = destinatario === 'NeuroTEA';
        const iconClass = isNeuroTEA ? 'building-2' : 'user';
        const colorClass = isNeuroTEA ? 'blue' : 'purple';
        const sanitizedName = destinatario.replace(/[^a-zA-Z0-9]/g, '_');

        // Contar pendientes y confirmados
        const confirmedCount = destinationTransfers.filter(function(t) { return t.confirmado; }).length;
        const pendingCount = transferCount - confirmedCount;

        return '<div class="mb-4 border rounded-md bg-white dark:bg-gray-800 overflow-hidden">' +
          '<div class="bg-' + colorClass + '-50 dark:bg-' + colorClass + '-900 p-4 cursor-pointer hover:bg-' + colorClass + '-100 dark:hover:bg-' + colorClass + '-800 transition-colors" ' +
            'onclick="toggleTransferGroup(\'' + destinatario.replace(/'/g, "\\'") + '\')">' +
            '<div class="flex justify-between items-center">' +
              '<h4 class="font-semibold text-' + colorClass + '-800 dark:text-' + colorClass + '-200 flex items-center">' +
                '<i data-lucide="' + iconClass + '" class="w-5 h-5 mr-2"></i>' +
                'Transferencias a ' + destinatario +
              '</h4>' +
              '<div class="flex items-center space-x-2">' +
                (isNeuroTEA ? '<span class="confirmed-count">' + confirmedCount + '</span>/<span class="pending-count">' + pendingCount + '</span> ' : '') +
                '<span class="text-sm text-' + colorClass + '-600 dark:text-' + colorClass + '-300">' +
                  transferCount + ' transferencia' + (transferCount !== 1 ? 's' : '') + ' - ' + formatCurrency(totalAmount) +
                '</span>' +
                '<i data-lucide="chevron-down" class="w-4 h-4 text-' + colorClass + '-600 dark:text-' + colorClass + '-300 transform transition-transform" id="chevron-transfer-' + sanitizedName + '"></i>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="hidden p-4" id="transfers-' + sanitizedName + '">' +
            transfersHTML +
          '</div>' +
        '</div>';
      }).join('');

      container.innerHTML = destinationGroups;
      lucide.createIcons();
    })
    .withFailureHandler(function(error) {
      console.error('Error cargando transferencias:', error);
      container.innerHTML = '<p class="text-red-500 text-center py-4">Error cargando transferencias</p>';
    })
    .getTransferenciasPendientes(fechaActual);
}

/**
 * Toggle visibilidad de grupo de transferencias
 */
function toggleTransferGroup(destinationName) {
  const sanitizedName = destinationName.replace(/[^a-zA-Z0-9]/g, '_');
  const transfersContainer = document.getElementById('transfers-' + sanitizedName);
  const chevron = document.getElementById('chevron-transfer-' + sanitizedName);

  if (transfersContainer && chevron) {
    if (transfersContainer.classList.contains('hidden')) {
      transfersContainer.classList.remove('hidden');
      chevron.classList.add('rotate-180');
    } else {
      transfersContainer.classList.add('hidden');
      chevron.classList.remove('rotate-180');
    }
  }
}

/**
 * Toggle estado de confirmacion individual de transferencia
 */
function toggleTransferConfirmation(transferId) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        updateTransfersView();
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showNotification('Error: ' + error.message, 'error');
    })
    .toggleTransferencia(transferId);
}

/**
 * Actualiza vista de rendicion
 * Genera filas de tabla con datos de rendicion por terapeuta
 */
function updateRendicionView() {
  const tbody = document.getElementById('rendicion-therapist-table-body');
  if (!tbody) {
    console.warn('Elemento rendicion-therapist-table-body no encontrado');
    return;
  }

  google.script.run
    .withSuccessHandler(function(resumen) {
      if (!resumen || !resumen.terapeutas || resumen.terapeutas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-gray-500">No hay datos de rendicion para esta fecha</td></tr>';
        return;
      }

      let html = '';

      resumen.terapeutas.forEach(status => {
        const badgeClass = getBadgeClass(status.estado);
        const ingresoTotal = status.valorTotalSesiones || 0;
        const rowClass = status.confirmacionInfo
          ? 'bg-red-50 dark:bg-red-900/20'
          : 'hover:bg-gray-50 dark:hover:bg-gray-700';

        // Generar boton de accion segun estado
        let actionButton = '';
        if (status.confirmacionInfo) {
          actionButton = `
            <button onclick="revertConfirmation('${status.terapeuta}')" class="btn-confirmar">
              Revertir
            </button>
          `;
        } else if (status.estado === 'LA TERAPEUTA DEBE DAR') {
          actionButton = `
            <select onchange="handleTherapistDebtPayment('${status.terapeuta}', this.value)" class="debt-payment-select">
              <option value="">Como entrega?</option>
              <option value="efectivo">Entrega efectivo</option>
              <option value="transferencia">Transfiere a cuenta</option>
            </select>
          `;
        } else if (status.estado === 'DAR EFECTIVO') {
          actionButton = `
            <select onchange="handlePaymentOption('${status.terapeuta}', this.value)" class="btn-confirmar">
              <option value="">Seleccionar...</option>
              <option value="exacto">Dar exacto (${formatCurrency(status.neuroteaLeDebe || 0)})</option>
              <option value="vuelto">Dar con vuelto (transferencia)...</option>
              <option value="vuelto-efectivo">Dar con vuelto en efectivo...</option>
              <option value="transferir">Solo transferir</option>
            </select>
          `;
        } else {
          actionButton = `
            <button onclick="confirmarRendicion('${status.terapeuta}')" class="btn-confirmar">
              Confirmar
            </button>
          `;
        }

        html += `
          <tr class="${rowClass}">
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 font-medium">${status.terapeuta}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center">${formatCurrency(ingresoTotal)}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center">${formatCurrency(status.aporteNeuroTEA || 0)}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center">${formatCurrency(status.honorarios || 0)}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center">${formatCurrency(status.transferenciaATerapeuta || 0)}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center">${formatCurrency(status.adelantosRecibidos || 0)}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center text-green-600 font-medium">${formatCurrency(status.neuroteaLeDebe || 0)}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center text-red-600 font-medium">${formatCurrency(status.terapeutaDebe || 0)}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center">
              <span class="badge ${badgeClass} text-xs">${status.estado}</span>
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center">
              ${actionButton}
            </td>
            <td class="border border-gray-300 dark:border-gray-600 px-2 py-2 text-center">
              <button onclick="generateTherapistReceipt('${status.terapeuta}')" class="btn-pdf-icon" title="Generar comprobante">
                <svg width="20" height="24" viewBox="0 0 20 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M2 2C2 0.895431 2.89543 0 4 0H13L18 5V22C18 23.1046 17.1046 24 16 24H4C2.89543 24 2 23.1046 2 22V2Z" fill="#E5E7EB"/>
                  <path d="M13 0V4C13 4.55228 13.4477 5 14 5H18L13 0Z" fill="#D1D5DB"/>
                  <rect x="5" y="8" width="8" height="1" rx="0.5" fill="#9CA3AF"/>
                  <rect x="5" y="11" width="10" height="1" rx="0.5" fill="#9CA3AF"/>
                  <rect x="1" y="14" width="18" height="6" rx="1" fill="#DC2626"/>
                  <text x="10" y="18.5" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="6" font-weight="bold">PDF</text>
                </svg>
              </button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
      lucide.createIcons();
    })
    .withFailureHandler(function(error) {
      console.error('Error cargando rendicion:', error);
      tbody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-red-500">Error cargando rendicion</td></tr>';
    })
    .getResumenRendicion(fechaActual);
}

/**
 * Actualiza lista de egresos
 */
function updateEgresosList() {
  const container = document.getElementById('egresos-list-container');

  if (egresos.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay egresos registrados</p>';
    return;
  }

  container.innerHTML = egresos.map(e => `
    <div class="session-item">
      <div class="session-item-info">
        <p class="session-item-patient">${e.concepto || e.tipo}</p>
        <p class="session-item-therapist">${e.terapeuta || 'NeuroTEA'} - ${e.tipo}</p>
      </div>
      <div class="flex items-center space-x-3">
        <span class="text-red-600 font-semibold">-${formatCurrency(e.monto)}</span>
        <button onclick="editEgreso(${e.id})" class="text-blue-500 hover:text-blue-700">
          <i data-lucide="edit" class="w-4 h-4"></i>
        </button>
        <button onclick="deleteEgreso(${e.id})" class="text-red-500 hover:text-red-700">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
      </div>
    </div>
  `).join('');
}

/**
 * Actualiza lista de terapeutas
 */
function updateTherapistsList() {
  const container = document.getElementById('therapist-list-container');

  if (terapeutas.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay terapeutas registrados</p>';
    return;
  }

  container.innerHTML = terapeutas.map(t => {
    const name = typeof t === 'string' ? t : t.nombre;
    return `
      <div class="session-item">
        <div class="flex items-center space-x-3">
          <i data-lucide="user" class="w-5 h-5 text-blue-500"></i>
          <span class="font-medium text-gray-800 dark:text-white">${name}</span>
        </div>
        <div class="flex items-center space-x-2">
          <button onclick="renameTherapist('${name}')" class="text-blue-500 hover:text-blue-700" title="Renombrar">
            <i data-lucide="edit" class="w-4 h-4"></i>
          </button>
          <button onclick="deleteTherapist('${name}')" class="text-red-500 hover:text-red-700" title="Eliminar">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    `;
  }).join('');
}

/**
 * Actualiza lista de paquetes
 */
function updatePackagesList() {
  const container = document.getElementById('active-packages-container');

  if (paquetesActivos.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay paquetes activos</p>';
    return;
  }

  container.innerHTML = paquetesActivos.map(p => {
    const progress = ((p.sesionesTotal - p.sesionesRestantes) / p.sesionesTotal) * 100;
    return `
      <div class="package-item">
        <div class="flex justify-between items-start">
          <div>
            <p class="font-medium text-gray-800 dark:text-white">${p.paciente}</p>
            <p class="text-sm text-gray-500">${p.terapeuta}</p>
          </div>
          <div class="text-right">
            <p class="text-sm font-medium">${p.sesionesRestantes}/${p.sesionesTotal} restantes</p>
            <p class="text-xs text-gray-500">${formatCurrency(p.valorTotal)}</p>
          </div>
        </div>
        <div class="package-progress">
          <div class="package-progress-bar" style="width: ${progress}%"></div>
        </div>
        <div class="mt-2 flex justify-end">
          <button onclick="deletePackage(${p.id})" class="text-red-500 hover:text-red-700 text-sm">
            <i data-lucide="trash-2" class="w-4 h-4 inline"></i> Eliminar
          </button>
        </div>
      </div>
    `;
  }).join('');
}

/**
 * Actualiza lista de grupos
 */
function updateGroupsList() {
  const container = document.getElementById('grupos-list-container');
  const counter = document.getElementById('grupos-counter');

  if (counter) counter.textContent = gruposActivos.length + ' grupo' + (gruposActivos.length !== 1 ? 's' : '');

  if (gruposActivos.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay grupos registrados</p>';
    return;
  }

  container.innerHTML = gruposActivos.map(g => {
    const ninos = g.ninos || [];
    return `
      <div class="group-item border rounded-lg p-4 bg-gray-50 dark:bg-gray-700">
        <div class="flex justify-between items-start">
          <div>
            <p class="font-medium text-gray-800 dark:text-white">${g.nombre}</p>
            <p class="text-sm text-gray-500">${ninos.length} Niño${ninos.length !== 1 ? 's' : ''} - ${g.porcentajeAporte}% aporte</p>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="editGroup(${g.id})" class="text-blue-500 hover:text-blue-700" title="Editar grupo">
              <i data-lucide="edit" class="w-4 h-4"></i>
            </button>
            <button onclick="deleteGroup(${g.id})" class="text-red-500 hover:text-red-700" title="Eliminar grupo">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
        <div class="mt-2 flex flex-wrap gap-1">
          ${ninos.map(n => `<span class="badge badge-secondary">${n.nombre}</span>`).join('')}
        </div>
      </div>
    `;
  }).join('');

  lucide.createIcons();
}

/**
 * Actualiza selectores de grupos
 */
function updateGroupSelects() {
  const select = document.getElementById('group-select');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">Seleccione grupo...</option>';

  gruposActivos.forEach(g => {
    const option = document.createElement('option');
    option.value = g.id;
    option.textContent = g.nombre;
    select.appendChild(option);
  });

  select.value = currentValue;
}

/**
 * Actualiza vista de administracion
 */
function updateAdminView() {
  // Mostrar saldo inicial en display (el input existe en modal, no aqui)
  const saldoDisplay = document.getElementById('saldo-actual-display');
  if (saldoDisplay) saldoDisplay.textContent = formatNumber(saldoInicial);

  // Cargar estadisticas
  google.script.run
    .withSuccessHandler(function(stats) {
      const container = document.getElementById('system-info');
      container.innerHTML = `
        <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded">
          <p class="text-2xl font-bold text-blue-600">${stats.totalTerapeutas || 0}</p>
          <p class="text-sm text-gray-500">Terapeutas</p>
        </div>
        <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded">
          <p class="text-2xl font-bold text-green-600">${stats.totalSesiones || 0}</p>
          <p class="text-sm text-gray-500">Sesiones Totales</p>
        </div>
        <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded">
          <p class="text-2xl font-bold text-purple-600">${stats.totalPaquetesActivos || 0}</p>
          <p class="text-sm text-gray-500">Paquetes Activos</p>
        </div>
        <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded">
          <p class="text-2xl font-bold text-orange-600">${stats.totalGruposActivos || 0}</p>
          <p class="text-sm text-gray-500">Grupos Activos</p>
        </div>
      `;
    })
    .withFailureHandler(function(error) {
      console.error('Error cargando estadisticas:', error);
      const container = document.getElementById('system-info');
      if (container) {
        container.innerHTML = '<p class="text-red-500 col-span-4">Error al cargar estadisticas</p>';
      }
    })
    .getEstadisticasSistema();
}

// ===========================
// HANDLERS DE FORMULARIOS
// ===========================

/**
 * Maneja envio de formulario de sesion
 */
function handleSessionSubmit(e) {
  e.preventDefault();

  // Verificar modo de registro
  const modoRegistro = document.querySelector('input[name="modo-registro"]:checked');
  const usaCredito = modoRegistro && modoRegistro.value === 'usar-credito';

  // Obtener paqueteId si usa credito
  let paqueteId = null;
  if (usaCredito) {
    const selectedPaqueteInput = document.getElementById('selected-paquete-id');
    paqueteId = selectedPaqueteInput ? selectedPaqueteInput.value : null;

    if (!paqueteId) {
      showNotification('Seleccione un paquete de creditos', 'warning');
      return;
    }
  }

  // Obtener tipo de aporte desde radio buttons
  const aporteRadio = document.querySelector('input[name="neurotea-contribution"]:checked');
  const tipoAporte = aporteRadio ? aporteRadio.value : '30';

  const sessionData = {
    fecha: fechaActual,
    terapeuta: document.getElementById('therapist-select').value,
    paciente: document.getElementById('patient-name').value.trim(),
    efectivo: parseNumber(document.getElementById('cash-to-neurotea').value),
    transferenciaNeurotea: parseNumber(document.getElementById('transfer-to-neurotea').value),
    transferenciaTerapeuta: parseNumber(document.getElementById('transfer-to-therapist').value),
    tipoAporte: tipoAporte,
    aporteNeurotea: parseNumber(document.getElementById('fixed-amount-input').value),
    usaCredito: usaCredito,
    paqueteId: paqueteId
  };

  // Validaciones
  if (!sessionData.terapeuta) {
    showNotification('Seleccione un terapeuta', 'warning');
    return;
  }
  if (!sessionData.paciente) {
    showNotification('Ingrese el nombre del paciente', 'warning');
    return;
  }

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Sesion registrada exitosamente', 'success');
        resetSessionForm();
        loadDateData(fechaActual);
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .registrarSesion(sessionData);
}

/**
 * Maneja envio de formulario de egreso
 */
function handleEgresoSubmit(e) {
  e.preventDefault();

  const egresoData = {
    fecha: fechaActual,
    tipo: document.getElementById('egreso-type').value,
    terapeuta: document.getElementById('egreso-therapist-select').value,
    concepto: document.getElementById('egreso-concept').value,
    monto: parseInt(document.getElementById('egreso-value').value) || 0
  };

  if (!egresoData.tipo) {
    showNotification('Seleccione un tipo de egreso', 'warning');
    return;
  }
  if (egresoData.monto <= 0) {
    showNotification('El monto debe ser mayor a 0', 'warning');
    return;
  }

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Egreso registrado', 'success');
        // Reset campos individuales de egreso (no hay form wrapper)
        const egresoType = document.getElementById('egreso-type');
        const egresoConcept = document.getElementById('egreso-concept');
        const egresoValue = document.getElementById('egreso-value');
        const egresoTherapistContainer = document.getElementById('egreso-therapist-container');
        if (egresoType) egresoType.value = '';
        if (egresoConcept) egresoConcept.value = '';
        if (egresoValue) egresoValue.value = '';
        if (egresoTherapistContainer) egresoTherapistContainer.style.display = 'none';
        loadDateData(fechaActual);
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .registrarEgreso(egresoData);
}

/**
 * Maneja envio de formulario de terapeuta
 */
function handleTherapistSubmit(e) {
  e.preventDefault();

  const nombre = document.getElementById('new-therapist-name').value.trim();
  if (!nombre) {
    showNotification('Ingrese el nombre del terapeuta', 'warning');
    return;
  }

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Terapeuta agregado', 'success');
        document.getElementById('new-therapist-name').value = '';
        terapeutas.push(nombre);
        updateAllViews();
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .crearTerapeuta(nombre);
}

/**
 * Maneja envio de formulario de paquete
 */
function handlePackageSubmit(e) {
  e.preventDefault();

  const packageData = {
    fecha: fechaActual,
    terapeuta: document.getElementById('package-therapist').value,
    paciente: document.getElementById('package-patient-name').value.trim(),
    sesionesTotal: parseInt(document.getElementById('package-sessions').value) || 0,
    efectivo: parseInt(document.getElementById('package-cash').value) || 0,
    transferenciaNeurotea: parseInt(document.getElementById('package-transfer-neurotea').value) || 0,
    transferenciaTerapeuta: parseInt(document.getElementById('package-transfer-therapist').value) || 0,
    tipoAporte: document.querySelector('input[name="package-neurotea-contribution"]:checked')?.value || '30'
  };

  if (!packageData.terapeuta) {
    showNotification('Seleccione un terapeuta', 'warning');
    return;
  }
  if (!packageData.paciente) {
    showNotification('Ingrese el nombre del paciente', 'warning');
    return;
  }

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Paquete creado', 'success');
        document.getElementById('package-form').reset();
        loadDateData(fechaActual);
        // Recargar paquetes activos
        google.script.run
          .withSuccessHandler(function(packages) {
            paquetesActivos = packages || [];
            updatePackagesList();
          })
          .withFailureHandler(function(error) {
            console.warn('Error recargando paquetes:', error.message);
          })
          .getPaquetesActivos();
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .crearPaquete(packageData);
}

/**
 * NOTA: Esta funcion es CODIGO LEGACY - NO SE USA ACTUALMENTE
 * La creacion de grupos se hace mediante createGroup() que crea grupos
 * sin ninos inicialmente. Los ninos se agregan despues via el modal de edicion.
 *
 * Esta funcion referencia elementos HTML que no existen (#group-children-inputs)
 * Se mantiene comentada por referencia historica.
 */
// function handleGroupSubmit(e) {
//   e.preventDefault();
//   const nombre = document.getElementById('new-group-name').value.trim();
//   const porcentajeAporte = document.getElementById('new-group-percentage').value;
//   const childRows = document.querySelectorAll('#group-children-inputs .child-input-row');
//   const ninos = [];
//   childRows.forEach(row => {
//     const nombreNino = row.querySelector('.child-name').value.trim();
//     const valor = parseInt(row.querySelector('.child-value').value) || 0;
//     if (nombreNino) {
//       ninos.push({ nombre: nombreNino, valor: valor });
//     }
//   });
//   if (!nombre) {
//     showNotification('Ingrese el nombre del grupo', 'warning');
//     return;
//   }
//   if (ninos.length === 0) {
//     showNotification('Agregue al menos un nino', 'warning');
//     return;
//   }
//   showLoading(true);
//   google.script.run
//     .withSuccessHandler(function(result) {
//       showLoading(false);
//       if (result.success) {
//         showNotification('Grupo creado', 'success');
//         document.getElementById('new-group-name').value = '';
//         document.getElementById('new-group-percentage').value = '30';
//         google.script.run
//           .withSuccessHandler(function(groups) {
//             gruposActivos = groups;
//             updateGroupsList();
//             updateGroupSelects();
//           })
//           .getGruposActivos();
//       } else {
//         showNotification(result.message, 'error');
//       }
//     })
//     .withFailureHandler(function(error) {
//       showLoading(false);
//       showNotification('Error: ' + error.message, 'error');
//     })
//     .crearGrupo({ nombre: nombre, porcentajeAporte: porcentajeAporte, ninos: ninos });
// }

/**
 * Maneja envio de formulario de saldo inicial (legacy - usar saveSaldoInicial)
 */
function handleSaldoSubmit(e) {
  e.preventDefault();

  const efectivo = parseInt(document.getElementById('nuevo-saldo-input').value) || 0;

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Saldo inicial guardado', 'success');
        saldoInicial = efectivo;
        // Resetear el formulario
        document.getElementById('nuevo-saldo-input').value = '';
        updateSummaryView();
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .establecerSaldoInicial(fechaActual, efectivo);
}

// ===========================
// FUNCIONES DE UTILIDAD
// ===========================

/**
 * Cambia de pestana
 */
function switchTab(tabId) {
  // Ocultar todos los contenidos
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });

  // Desactivar todos los botones
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active-tab');
  });

  // Mostrar contenido seleccionado
  document.getElementById('tab-' + tabId).classList.remove('hidden');

  // Activar boton
  document.querySelector(`[data-tab="${tabId}"]`).classList.add('active-tab');

  // Actualizar vista si es necesario
  if (tabId === 'transferencias') updateTransfersView();
  if (tabId === 'rendicion') updateRendicionView();
}

/**
 * Formatea valor como moneda
 */
function formatCurrency(value) {
  const num = parseInt(value) || 0;
  return 'Gs ' + num.toLocaleString('es-PY');
}

/**
 * Parsea un valor de texto a numero (elimina caracteres no numericos)
 * FUNCION CRITICA - usada en multiples lugares
 */
function parseNumber(value) {
  if (!value) return 0;
  return parseInt(value.toString().replace(/[^\d]/g, '')) || 0;
}

/**
 * Muestra/oculta loading
 */
function showLoading(show) {
  document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
}

/**
 * Muestra notificacion
 */
function showNotification(message, type = 'info') {
  const container = document.getElementById('notification-container');
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <span>${message}</span>
    <button onclick="this.parentElement.remove()" class="ml-2">
      <i data-lucide="x" class="w-4 h-4"></i>
    </button>
  `;

  container.appendChild(notification);
  lucide.createIcons();

  // Auto-remover despues de 5 segundos
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

/**
 * Resetea formulario de sesion
 */
function resetSessionForm() {
  // Resetear campos individuales (no hay form element)
  const patientName = document.getElementById('patient-name');
  if (patientName) patientName.value = '';

  const cashInput = document.getElementById('cash-to-neurotea');
  if (cashInput) cashInput.value = '';

  const transferNeurotea = document.getElementById('transfer-to-neurotea');
  if (transferNeurotea) transferNeurotea.value = '';

  const transferTherapist = document.getElementById('transfer-to-therapist');
  if (transferTherapist) transferTherapist.value = '';

  // Resetear radio buttons de modo de registro a "pago-dia"
  const modoPagoDia = document.getElementById('modo-pago-dia');
  if (modoPagoDia) modoPagoDia.checked = true;

  // Resetear radio buttons de aporte a 30%
  const contribution30 = document.getElementById('contribution-30');
  if (contribution30) contribution30.checked = true;

  // Resetear monto fijo
  const fixedInput = document.getElementById('fixed-amount-input');
  if (fixedInput) {
    fixedInput.value = '';
    fixedInput.disabled = true;
  }

  // Ocultar indicador de credito
  const creditIndicator = document.getElementById('credit-indicator');
  if (creditIndicator) creditIndicator.classList.add('hidden');

  // Ocultar seccion de paciente con creditos
  const creditSection = document.getElementById('paciente-credito-section');
  if (creditSection) creditSection.style.display = 'none';

  // Actualizar displays de valores
  updatePaymentDisplay();
}

/**
 * Verifica creditos del paciente
 */
function checkPatientCredits() {
  const paciente = document.getElementById('patient-name').value.trim();
  const terapeuta = document.getElementById('therapist-select').value;

  if (!paciente || !terapeuta) return;

  google.script.run
    .withSuccessHandler(function(result) {
      // Mostrar informacion de creditos disponibles
      const creditInfo = document.getElementById('creditos-info-display');
      const modoUsarCredito = document.getElementById('modo-usar-credito');

      if (result && result.hasCredits) {
        if (creditInfo) {
          creditInfo.textContent = `${result.totalRemaining} creditos disponibles`;
          creditInfo.classList.remove('hidden');
        }
        // Habilitar opcion de usar credito
        if (modoUsarCredito) modoUsarCredito.disabled = false;
      } else {
        if (creditInfo) {
          creditInfo.textContent = '';
          creditInfo.classList.add('hidden');
        }
        // Deshabilitar opcion de usar credito si no hay creditos
        if (modoUsarCredito) modoUsarCredito.disabled = true;
      }
    })
    .withFailureHandler(function(error) {
      console.warn('Error verificando creditos:', error);
    })
    .verificarCreditos(paciente, terapeuta);
}

/**
 * Agrega input para nino en formulario de grupo
 * Nota: Esta funcion requiere un contenedor con id 'group-children-inputs' o 'edit-group-children-list'
 */
function addChildInput() {
  // Buscar el contenedor correcto
  const container = document.getElementById('edit-group-children-list');
  if (!container) {
    console.warn('Contenedor de ninos no encontrado');
    return;
  }

  const newRow = document.createElement('div');
  newRow.className = 'flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-700 rounded';
  newRow.innerHTML = `
    <input type="text" placeholder="Nombre del niño" class="flex-1 p-2 border rounded-md text-sm dark:bg-gray-600 dark:border-gray-500 child-name">
    <input type="number" placeholder="Valor" class="w-28 p-2 border rounded-md text-sm dark:bg-gray-600 dark:border-gray-500 child-value" min="0">
    <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 p-1">
      <i data-lucide="trash-2" class="w-4 h-4"></i>
    </button>
  `;
  container.appendChild(newRow);
  lucide.createIcons();
  lucide.createIcons();
}

/**
 * Obtiene clase CSS para card de rendicion
 */
function getRendicionCardClass(estado) {
  const classes = {
    'SALDADO': 'saldado',
    'DAR EFECTIVO': 'dar-efectivo',
    'TRANSFERIR': 'transferir',
    'DAR Y TRANSFERIR': 'dar-transferir',
    'LA TERAPEUTA DEBE DAR': 'terapeuta-debe',
    'FONDOS INSUFICIENTES': 'terapeuta-debe'
  };
  return classes[estado] || 'saldado';
}

/**
 * Obtiene clase de badge
 */
function getBadgeClass(estado) {
  const classes = {
    'SALDADO': 'badge-secondary',
    'DAR EFECTIVO': 'badge-success',
    'TRANSFERIR': 'badge-info',
    'DAR Y TRANSFERIR': 'badge-warning',
    'LA TERAPEUTA DEBE DAR': 'badge-danger',
    'FONDOS INSUFICIENTES': 'badge-danger',
    'CONFIRMADO': 'badge-success'
  };
  return classes[estado] || 'badge-secondary';
}

/**
 * Toggle dark mode
 */
function toggleDarkMode() {
  document.documentElement.classList.toggle('dark');
}

// ===========================
// FUNCIONES DE ACCIONES
// ===========================

/**
 * Elimina una sesion
 */
function deleteSession(id) {
  if (!confirm('¿Eliminar esta sesion?')) return;

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Sesion eliminada', 'success');
        loadDateData(fechaActual);
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al eliminar: ' + error.message, 'error');
    })
    .eliminarSesion(id);
}

/**
 * Elimina una sesion grupal
 */
function deleteGroupSession(id) {
  if (!confirm('¿Eliminar esta sesion grupal?')) return;

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Sesion grupal eliminada', 'success');
        loadDateData(fechaActual);
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al eliminar: ' + error.message, 'error');
    })
    .eliminarSesionGrupal(id);
}

/**
 * Elimina un egreso
 */
function deleteEgreso(id) {
  if (!confirm('¿Eliminar este egreso?')) return;

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Egreso eliminado', 'success');
        loadDateData(fechaActual);
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al eliminar: ' + error.message, 'error');
    })
    .eliminarEgreso(id);
}

/**
 * Elimina un terapeuta
 */
function deleteTherapist(nombre) {
  if (!confirm('Eliminar al terapeuta ' + nombre + '?\n\nSi tiene registros asociados, se ofrecera desactivar en su lugar.')) return;

  showLoading(true);

  // Intentar borrado permanente primero
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        // Borrado permanente exitoso
        showNotification('Terapeuta eliminado permanentemente', 'success');
        terapeutas = terapeutas.filter(function(t) {
          var n = typeof t === 'string' ? t : t.nombre;
          return n !== nombre;
        });
        updateAllViews();
      } else {
        // No se puede borrar (tiene registros asociados), ofrecer desactivar
        var ofrecerDesactivar = confirm(
          result.message + '\n\nDesea desactivar al terapeuta en su lugar?\n(El terapeuta no aparecera en la lista pero sus registros se conservan)'
        );
        if (ofrecerDesactivar) {
          showLoading(true);
          google.script.run
            .withSuccessHandler(function(deactResult) {
              showLoading(false);
              if (deactResult.success) {
                showNotification('Terapeuta desactivado', 'success');
                terapeutas = terapeutas.filter(function(t) {
                  var n = typeof t === 'string' ? t : t.nombre;
                  return n !== nombre;
                });
                updateAllViews();
              } else {
                showNotification(deactResult.message, 'error');
              }
            })
            .withFailureHandler(function(error) {
              showLoading(false);
              showNotification('Error al desactivar: ' + error.message, 'error');
            })
            .desactivarTerapeuta(nombre);
        }
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al eliminar: ' + error.message, 'error');
    })
    .eliminarTerapeuta(nombre);
}

// ===========================
// FUNCIONES DE EDICION
// ===========================

/**
 * Abre el modal para editar una sesion
 */
function editSession(id) {
  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        const session = result.data;

        // Poblar el select de terapeutas
        const selectTerapeuta = document.getElementById('edit-session-terapeuta');
        selectTerapeuta.innerHTML = terapeutas.map(t => {
          const name = typeof t === 'string' ? t : t.nombre;
          return `<option value="${name}" ${name === session.terapeuta ? 'selected' : ''}>${name}</option>`;
        }).join('');

        // Llenar los campos del modal
        document.getElementById('edit-session-id').value = session.id;
        document.getElementById('edit-session-paciente').value = session.paciente || '';
        document.getElementById('edit-session-efectivo').value = session.efectivo || 0;
        document.getElementById('edit-session-transf-neurotea').value = session.transferenciaNeurotea || 0;
        document.getElementById('edit-session-transf-terapeuta').value = session.transferenciaTerapeuta || 0;

        // Calcular y mostrar el valor total
        updateEditSessionValue();

        // Configurar event listeners (remover primero para evitar duplicados/memory leak)
        const inputIds = ['edit-session-efectivo', 'edit-session-transf-neurotea', 'edit-session-transf-terapeuta'];
        inputIds.forEach(inputId => {
          const el = document.getElementById(inputId);
          // Clonar y reemplazar para remover todos los listeners anteriores
          const newEl = el.cloneNode(true);
          el.parentNode.replaceChild(newEl, el);
          newEl.addEventListener('input', updateEditSessionValue);
        });

        // Mostrar modal
        document.getElementById('edit-session-modal').classList.remove('hidden');
        lucide.createIcons();
      } else {
        showNotification(result.message || 'Error al cargar sesion', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .getSesionPorId(id);
}

/**
 * Actualiza el valor mostrado en el modal de edicion
 */
function updateEditSessionValue() {
  const efectivo = parseInt(document.getElementById('edit-session-efectivo').value) || 0;
  const transfNeurotea = parseInt(document.getElementById('edit-session-transf-neurotea').value) || 0;
  const transfTerapeuta = parseInt(document.getElementById('edit-session-transf-terapeuta').value) || 0;
  const total = efectivo + transfNeurotea + transfTerapeuta;

  document.getElementById('edit-session-valor').textContent = formatCurrency(total);
}

/**
 * Cierra el modal de edicion de sesion
 */
function closeEditSessionModal() {
  document.getElementById('edit-session-modal').classList.add('hidden');
  // Limpiar datos del modal
  document.getElementById('edit-session-id').value = '';
  document.getElementById('edit-session-paciente').value = '';
  document.getElementById('edit-session-efectivo').value = '0';
  document.getElementById('edit-session-transf-neurotea').value = '0';
  document.getElementById('edit-session-transf-terapeuta').value = '0';
}

/**
 * Guarda los cambios de la sesion editada
 */
function saveSessionEdit() {
  const id = parseInt(document.getElementById('edit-session-id').value);
  const updates = {
    paciente: document.getElementById('edit-session-paciente').value.trim(),
    terapeuta: document.getElementById('edit-session-terapeuta').value,
    efectivo: parseInt(document.getElementById('edit-session-efectivo').value) || 0,
    transferenciaNeurotea: parseInt(document.getElementById('edit-session-transf-neurotea').value) || 0,
    transferenciaTerapeuta: parseInt(document.getElementById('edit-session-transf-terapeuta').value) || 0
  };

  if (!updates.paciente) {
    showNotification('El nombre del paciente es requerido', 'error');
    return;
  }

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        closeEditSessionModal();
        showNotification('Sesion actualizada', 'success');
        loadDateData(fechaActual);
      } else {
        showNotification(result.message || 'Error al actualizar', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .actualizarSesion(id, updates);
}

// ===========================
// EDICION DE SESIONES GRUPALES
// ===========================

/**
 * Abre el modal para editar una sesion grupal
 */
function editGroupSession(id) {
  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        const session = result.data;

        // Guardar ID
        document.getElementById('edit-group-session-id').value = session.id;

        // Mostrar info del grupo
        document.getElementById('edit-group-session-nombre').textContent = session.grupoNombre || 'Grupo';
        const terapeutas = session.terapeutasJSON || [];
        document.getElementById('edit-group-session-terapeutas').textContent = terapeutas.join(', ');

        // Generar lista de ninos
        const asistencia = session.asistenciaJSON || [];
        const childrenContainer = document.getElementById('edit-group-session-children');
        childrenContainer.innerHTML = asistencia.map(nino => `
          <div class="border rounded p-3 bg-white dark:bg-gray-600 edit-group-child-row" data-child="${nino.nombre}">
            <div class="flex items-center justify-between mb-2">
              <label class="flex items-center space-x-2">
                <input type="checkbox" class="edit-group-attendance" ${nino.presente ? 'checked' : ''}>
                <span class="font-medium">${nino.nombre}</span>
              </label>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="text-xs text-gray-500">Valor</label>
                <input type="number" class="edit-group-child-value w-full p-1 border rounded text-sm" value="${nino.valor || 0}" min="0">
              </div>
              <div>
                <label class="text-xs text-gray-500">Efectivo</label>
                <input type="number" class="edit-group-child-cash w-full p-1 border rounded text-sm" value="${nino.efectivo || 0}" min="0">
              </div>
              <div>
                <label class="text-xs text-gray-500">Transferencia</label>
                <input type="number" class="edit-group-child-transfer w-full p-1 border rounded text-sm" value="${nino.transferencia || 0}" min="0">
              </div>
            </div>
          </div>
        `).join('');

        // Agregar event listeners
        childrenContainer.querySelectorAll('input').forEach(input => {
          input.addEventListener('input', updateEditGroupSessionTotals);
          input.addEventListener('change', updateEditGroupSessionTotals);
        });

        // Calcular totales iniciales
        updateEditGroupSessionTotals();

        // Mostrar modal
        document.getElementById('edit-group-session-modal').classList.remove('hidden');
        lucide.createIcons();
      } else {
        showNotification(result.message || 'Error al cargar sesion grupal', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .getSesionGrupalPorId(id);
}

/**
 * Actualiza los totales del modal de edicion de sesion grupal
 */
function updateEditGroupSessionTotals() {
  let totalValue = 0;
  let totalCash = 0;
  let totalTransfer = 0;

  document.querySelectorAll('.edit-group-child-row').forEach(row => {
    const presente = row.querySelector('.edit-group-attendance').checked;
    if (presente) {
      totalValue += parseNumber(row.querySelector('.edit-group-child-value').value);
      totalCash += parseNumber(row.querySelector('.edit-group-child-cash').value);
      totalTransfer += parseNumber(row.querySelector('.edit-group-child-transfer').value);
    }
  });

  document.getElementById('edit-group-session-total').textContent = formatCurrency(totalValue);
  document.getElementById('edit-group-session-efectivo').textContent = formatCurrency(totalCash);
  document.getElementById('edit-group-session-transfer').textContent = formatCurrency(totalTransfer);
}

/**
 * Cierra el modal de edicion de sesion grupal
 */
function closeEditGroupSessionModal() {
  document.getElementById('edit-group-session-modal').classList.add('hidden');
  // Limpiar datos del modal
  const container = document.getElementById('edit-group-session-children');
  if (container) container.innerHTML = '';
}

/**
 * Guarda los cambios de la sesion grupal editada
 */
function saveGroupSessionEdit() {
  const id = parseInt(document.getElementById('edit-group-session-id').value);

  // Recopilar asistencia actualizada
  const asistencia = [];
  document.querySelectorAll('.edit-group-child-row').forEach(row => {
    asistencia.push({
      nombre: row.dataset.child,
      presente: row.querySelector('.edit-group-attendance').checked,
      valor: parseNumber(row.querySelector('.edit-group-child-value').value),
      efectivo: parseNumber(row.querySelector('.edit-group-child-cash').value),
      transferencia: parseNumber(row.querySelector('.edit-group-child-transfer').value)
    });
  });

  const updates = { asistencia: asistencia };

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        closeEditGroupSessionModal();
        showNotification('Sesion grupal actualizada', 'success');
        loadDateData(fechaActual);
      } else {
        showNotification(result.message || 'Error al actualizar', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .actualizarSesionGrupal(id, updates);
}

/**
 * Abre el modal para editar un egreso
 */
function editEgreso(id) {
  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        const egreso = result.data;

        // Poblar el select de terapeutas
        const selectTerapeuta = document.getElementById('edit-egreso-terapeuta');
        selectTerapeuta.innerHTML = '<option value="">Seleccionar terapeuta</option>' + terapeutas.map(t => {
          const name = typeof t === 'string' ? t : t.nombre;
          return `<option value="${name}" ${name === egreso.terapeuta ? 'selected' : ''}>${name}</option>`;
        }).join('');

        // Llenar los campos del modal
        document.getElementById('edit-egreso-id').value = egreso.id;
        document.getElementById('edit-egreso-tipo').value = egreso.tipo || 'gasto-neurotea';
        document.getElementById('edit-egreso-concepto').value = egreso.concepto || '';
        document.getElementById('edit-egreso-monto').value = egreso.monto || 0;

        // Mostrar/ocultar selector de terapeuta
        toggleEditEgresoTerapeuta();

        // Mostrar modal
        document.getElementById('edit-egreso-modal').classList.remove('hidden');
        lucide.createIcons();
      } else {
        showNotification(result.message || 'Error al cargar egreso', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .getEgresoPorId(id);
}

/**
 * Muestra/oculta el selector de terapeuta en el modal de egreso
 */
function toggleEditEgresoTerapeuta() {
  const tipo = document.getElementById('edit-egreso-tipo').value;
  const container = document.getElementById('edit-egreso-terapeuta-container');
  container.style.display = tipo === 'adelanto' ? 'block' : 'none';
}

/**
 * Cierra el modal de edicion de egreso
 */
function closeEditEgresoModal() {
  document.getElementById('edit-egreso-modal').classList.add('hidden');
  // Limpiar datos del modal
  document.getElementById('edit-egreso-id').value = '';
  document.getElementById('edit-egreso-tipo').value = 'gasto-neurotea';
  document.getElementById('edit-egreso-concepto').value = '';
  document.getElementById('edit-egreso-monto').value = '0';
}

/**
 * Guarda los cambios del egreso editado
 */
function saveEgresoEdit() {
  const id = parseInt(document.getElementById('edit-egreso-id').value);
  const tipo = document.getElementById('edit-egreso-tipo').value;
  const updates = {
    tipo: tipo,
    concepto: document.getElementById('edit-egreso-concepto').value.trim(),
    monto: parseInt(document.getElementById('edit-egreso-monto').value) || 0,
    terapeuta: tipo === 'adelanto' ? document.getElementById('edit-egreso-terapeuta').value : ''
  };

  if (updates.monto <= 0) {
    showNotification('El monto debe ser mayor a 0', 'error');
    return;
  }

  if (tipo === 'adelanto' && !updates.terapeuta) {
    showNotification('Seleccione un terapeuta para el adelanto', 'error');
    return;
  }

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        closeEditEgresoModal();
        showNotification('Egreso actualizado', 'success');
        loadDateData(fechaActual);
      } else {
        showNotification(result.message || 'Error al actualizar', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .actualizarEgreso(id, updates);
}

/**
 * Renombra un terapeuta
 */
function renameTherapist(nombreActual) {
  const nuevoNombre = prompt(`Ingrese el nuevo nombre para "${nombreActual}":`, nombreActual);

  if (!nuevoNombre || nuevoNombre.trim() === '') {
    return;
  }

  if (nuevoNombre.trim() === nombreActual) {
    showNotification('El nombre no ha cambiado', 'warning');
    return;
  }

  if (!confirm(`¿Renombrar "${nombreActual}" a "${nuevoNombre.trim()}"?\n\nEsto actualizara el nombre en todas las sesiones, egresos y paquetes asociados.`)) {
    return;
  }

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification(`Terapeuta renombrado de "${nombreActual}" a "${nuevoNombre.trim()}"`, 'success');
        // Recargar todos los datos
        loadInitialData();
      } else {
        showNotification(result.message || 'Error al renombrar', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .renombrarTerapeuta(nombreActual, nuevoNombre.trim());
}

/**
 * Elimina un paquete
 */
function deletePackage(id) {
  const mensaje =
    '⚠️ ADVERTENCIA: Esta acción eliminará permanentemente:\n\n' +
    '• El paquete seleccionado\n' +
    '• Todos los créditos asociados\n\n' +
    '¿Está seguro de continuar?';

  if (!confirm(mensaje)) return;
  if (!confirm('Esta acción NO se puede deshacer. ¿Confirma que desea proceder?')) return;

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Paquete eliminado', 'success');
        paquetesActivos = paquetesActivos.filter(p => p.id !== id);
        updatePackagesList();
        loadDateData(fechaActual);
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al eliminar paquete: ' + error.message, 'error');
    })
    .eliminarPaquete(id);
}

/**
 * Edita un grupo existente - abre el modal de edicion
 */
function editGroup(id) {
  openEditGroupModal(id);
}

/**
 * Elimina un grupo
 */
function deleteGroup(id) {
  if (!confirm('¿Eliminar este grupo?')) return;

  var groupId = typeof id === 'string' ? parseInt(id) : id;

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Grupo eliminado', 'success');
        gruposActivos = gruposActivos.filter(g => g.id != groupId);
        updateGroupsList();
        updateGroupSelects();
        // Cerrar modal de edicion si esta abierto
        closeEditGroupModal();
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al eliminar grupo: ' + error.message, 'error');
    })
    .eliminarGrupo(groupId);
}

/**
 * Toggle confirmacion de transferencia
 */
function toggleTransfer(transferId) {
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        updateTransfersView();
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al cambiar estado: ' + error.message, 'error');
    })
    .toggleTransferencia(transferId);
}

/**
 * Genera HTML para el boton/dropdown de accion de pago segun el estado
 */
function getPaymentActionHTML(status) {
  const terapeuta = status.terapeuta.replace(/'/g, "\\'");
  const neuroteaDebeFormatted = formatCurrency(status.neuroteaLeDebe);

  // Si esta SALDADO, solo boton de confirmar simple
  if (status.estado === 'SALDADO') {
    return `<button onclick="confirmPaymentSimple('${terapeuta}')" class="btn btn-secondary btn-sm flex-1">
              <i data-lucide="check" class="w-4 h-4 mr-1"></i>Confirmar
            </button>`;
  }

  // Si terapeuta debe dar
  if (status.estado === 'LA TERAPEUTA DEBE DAR') {
    return `<select onchange="handlePaymentOption('${terapeuta}', this.value)" class="form-select btn-sm flex-1">
              <option value="">Seleccionar...</option>
              <option value="efectivo">Entrega efectivo (${formatCurrency(status.terapeutaDebe)})</option>
              <option value="transferencia">Transfiere a cuenta</option>
            </select>`;
  }

  // Si hay fondos insuficientes
  if (status.estado === 'FONDOS INSUFICIENTES') {
    return `<button class="btn btn-danger btn-sm flex-1" disabled>
              <i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i>Fondos insuficientes
            </button>`;
  }

  // Si NeuroTEA debe dar efectivo
  if (status.estado === 'DAR EFECTIVO') {
    return `<select onchange="handlePaymentOption('${terapeuta}', this.value)" class="form-select btn-sm flex-1">
              <option value="">Seleccionar...</option>
              <option value="exacto">Dar exacto (${neuroteaDebeFormatted})</option>
              <option value="vuelto">Dar con vuelto (por transferencia)...</option>
              <option value="vuelto-efectivo">Dar con vuelto en efectivo...</option>
              <option value="transferir">Solo transferir</option>
            </select>`;
  }

  // Si es dar y transferir (mixto)
  if (status.estado === 'DAR Y TRANSFERIR') {
    return `<button onclick="confirmPaymentMixed('${terapeuta}')" class="btn btn-warning btn-sm flex-1">
              <i data-lucide="check" class="w-4 h-4 mr-1"></i>Confirmar mixto
            </button>`;
  }

  // Si solo transferir
  if (status.estado === 'TRANSFERIR') {
    return `<button onclick="confirmPaymentTransfer('${terapeuta}')" class="btn btn-info btn-sm flex-1">
              <i data-lucide="check" class="w-4 h-4 mr-1"></i>Confirmar transferencia
            </button>`;
  }

  // Default: boton simple
  return `<button onclick="confirmPaymentSimple('${terapeuta}')" class="btn btn-primary btn-sm flex-1">
            <i data-lucide="check" class="w-4 h-4 mr-1"></i>Confirmar Pago
          </button>`;
}

/**
 * Maneja la seleccion de opcion de pago del dropdown
 */
/* handlePaymentOption definida mas abajo (despues de confirmarRendicion) */

/**
 * Funcion principal para confirmar rendicion de un terapeuta
 * Obtiene el estado actual y muestra opciones de pago apropiadas
 */
function confirmarRendicion(terapeuta) {
  showLoading(true);

  // Obtener estado actual del terapeuta
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);

      if (!result.success) {
        showNotification('Error obteniendo estado: ' + result.message, 'error');
        return;
      }

      const status = result.data;

      // Si ya esta confirmado, no permitir
      if (status.confirmado || status.confirmacionInfo) {
        showNotification('Este terapeuta ya tiene una confirmacion', 'warning');
        return;
      }

      // Verificar fondos insuficientes
      if (status.estado === 'FONDOS INSUFICIENTES') {
        alert('No hay fondos suficientes para realizar el pago.\n\n' +
              'Saldo en Caja: ' + formatCurrency(status.saldoCajaActual) + '\n' +
              'Cuenta NeuroTEA: ' + formatCurrency(status.saldoCuentaNeuroTEA) + '\n' +
              'Monto a pagar: ' + formatCurrency(status.neuroteaLeDebe));
        return;
      }

      // Mostrar dialogo con opciones segun estado
      mostrarOpcionesPago(terapeuta, status);
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .getEstadoTerapeuta(terapeuta, fechaActual);
}

/**
 * Muestra dialogo con opciones de pago segun el estado
 */
function mostrarOpcionesPago(terapeuta, status) {
  let opciones = [];
  let mensaje = '';

  switch (status.estado) {
    case 'DAR EFECTIVO':
      const montoADar = formatCurrency(status.neuroteaLeDebe);
      mensaje = `${terapeuta}\n\nNeuroTEA debe dar: ${montoADar}\n\nSeleccione como pagar:`;
      opciones = [
        { texto: `Dar exacto en efectivo (${montoADar})`, valor: 'exacto' },
        { texto: `Dar efectivo con vuelto (terapeuta transfiere diferencia)`, valor: 'vuelto' },
        { texto: `Dar efectivo con vuelto en efectivo`, valor: 'vuelto-efectivo' },
        { texto: `Transferir desde cuenta NeuroTEA (${montoADar})`, valor: 'transferir' }
      ];
      break;

    case 'DAR Y TRANSFERIR':
      mensaje = `${terapeuta}\n\nNeuroTEA debe dar: ${formatCurrency(status.neuroteaLeDebe)}\n` +
                `Saldo en caja: ${formatCurrency(status.saldoCajaActual)}\n` +
                `Se dara todo el efectivo disponible y el resto por transferencia.\n\n` +
                `¿Confirmar pago mixto?`;
      if (confirm(mensaje)) {
        executePaymentConfirmation(terapeuta, {
          tipoOpcion: 'dar-transferir',
          efectivoUsado: status.saldoCajaActual,
          bancoUsado: status.neuroteaLeDebe - status.saldoCajaActual
        });
      }
      return;

    case 'TRANSFERIR':
      mensaje = `${terapeuta}\n\nNeuroTEA debe transferir: ${formatCurrency(status.neuroteaLeDebe)}\n` +
                `Disponible en cuenta: ${formatCurrency(status.saldoCuentaNeuroTEA)}\n\n` +
                `¿Confirmar transferencia?`;
      if (confirm(mensaje)) {
        executePaymentConfirmation(terapeuta, {
          tipoOpcion: 'transferir',
          bancoUsado: status.neuroteaLeDebe
        });
      }
      return;

    case 'LA TERAPEUTA DEBE DAR':
      const montoTerapeuta = formatCurrency(status.terapeutaDebe);
      mensaje = `${terapeuta}\n\nLa terapeuta debe entregar: ${montoTerapeuta}\n\nSeleccione como recibe:`;
      opciones = [
        { texto: `Recibir en efectivo (${montoTerapeuta})`, valor: 'devolucion-efectivo' },
        { texto: `Recibir por transferencia a cuenta NeuroTEA (${montoTerapeuta})`, valor: 'devolucion-transferencia' }
      ];
      break;

    case 'SALDADO':
      mensaje = `${terapeuta}\n\nEsta saldado (no hay movimiento de dinero).\n\n¿Confirmar como saldado?`;
      if (confirm(mensaje)) {
        executePaymentConfirmation(terapeuta, { tipoOpcion: 'saldado' });
      }
      return;

    default:
      showNotification('Estado no reconocido: ' + status.estado, 'error');
      return;
  }

  // Mostrar prompt con opciones para DAR EFECTIVO y LA TERAPEUTA DEBE DAR
  const opcionesTexto = opciones.map((o, i) => `${i + 1}. ${o.texto}`).join('\n');
  const seleccion = prompt(mensaje + '\n\n' + opcionesTexto + '\n\nIngrese el numero de la opcion:', '1');

  if (!seleccion) return;

  const indice = parseInt(seleccion) - 1;
  if (indice < 0 || indice >= opciones.length) {
    showNotification('Opcion invalida', 'warning');
    return;
  }

  const opcionSeleccionada = opciones[indice].valor;

  // Manejar opciones con vuelto
  if (opcionSeleccionada === 'vuelto' || opcionSeleccionada === 'vuelto-efectivo') {
    const montoReal = prompt(
      `Debe dar ${formatCurrency(status.neuroteaLeDebe)}.\n` +
      `¿Cuanto va a entregar en efectivo?`,
      status.neuroteaLeDebe
    );

    if (!montoReal) return;

    const monto = parseNumber(montoReal);
    if (monto <= status.neuroteaLeDebe) {
      alert('El monto debe ser mayor al adeudado para generar vuelto');
      return;
    }

    const vuelto = monto - status.neuroteaLeDebe;
    executePaymentConfirmation(terapeuta, {
      tipoOpcion: opcionSeleccionada,
      efectivoUsado: monto,
      vueltoEfectivo: opcionSeleccionada === 'vuelto-efectivo' ? vuelto : 0,
      vueltoTransferencia: opcionSeleccionada === 'vuelto' ? vuelto : 0
    });
  } else {
    // Opciones simples
    executePaymentConfirmation(terapeuta, { tipoOpcion: opcionSeleccionada });
  }
}

/**
 * Confirma pago simple (sin opciones especiales)
 */
function confirmPaymentSimple(terapeuta) {
  if (!confirm(`¿Confirmar pago a ${terapeuta}?`)) return;
  executePaymentConfirmation(terapeuta, { tipoOpcion: 'exacto' });
}

/**
 * Confirma pago exacto (DAR EFECTIVO)
 */
function confirmPaymentExact(terapeuta) {
  if (!confirm(`¿Confirmar pago exacto a ${terapeuta}?`)) return;
  executePaymentConfirmation(terapeuta, { tipoOpcion: 'exacto' });
}

/**
 * Confirma pago con vuelto
 */
function confirmPaymentWithChange(terapeuta, tipoVuelto) {
  // Primero obtener el estado actual
  google.script.run
    .withSuccessHandler(function(status) {
      const montoADar = status.neuroteaLeDebe;
      const mensaje = tipoVuelto === 'efectivo'
        ? `Debe dar ${formatCurrency(montoADar)}.\n¿Cuanto va a entregar en efectivo? (Vuelto sera en efectivo)`
        : `Debe dar ${formatCurrency(montoADar)}.\n¿Cuanto va a entregar en efectivo? (Vuelto sera por transferencia)`;

      const montoReal = prompt(mensaje, montoADar);
      if (!montoReal) return;

      const monto = parseNumber(montoReal);
      if (monto <= montoADar) {
        alert('El monto debe ser mayor al adeudado para generar vuelto');
        return;
      }

      const vuelto = monto - montoADar;
      const opcion = {
        tipoOpcion: tipoVuelto === 'efectivo' ? 'vuelto-efectivo' : 'vuelto',
        efectivoUsado: monto,
        vueltoEfectivo: tipoVuelto === 'efectivo' ? vuelto : 0,
        vueltoTransferencia: tipoVuelto !== 'efectivo' ? vuelto : 0
      };

      executePaymentConfirmation(terapeuta, opcion);
    })
    .withFailureHandler(function(error) {
      showNotification('Error al obtener estado: ' + error.message, 'error');
    })
    .calcularEstadoTerapeuta(terapeuta, fechaActual);
}

/**
 * Confirma pago por transferencia
 */
function confirmPaymentTransfer(terapeuta) {
  if (!confirm(`¿Confirmar pago por transferencia a ${terapeuta}?`)) return;
  executePaymentConfirmation(terapeuta, { tipoOpcion: 'transferir' });
}

/**
 * Confirma pago mixto (efectivo + transferencia)
 */
function confirmPaymentMixed(terapeuta) {
  if (!confirm(`¿Confirmar pago mixto (efectivo + transferencia) a ${terapeuta}?`)) return;
  executePaymentConfirmation(terapeuta, { tipoOpcion: 'dar-transferir' });
}

/**
 * Confirma cuando la terapeuta debe dar
 */
function confirmPaymentTherapistGives(terapeuta, metodo) {
  const mensaje = metodo === 'efectivo'
    ? `¿Confirmar que ${terapeuta} entrega efectivo?`
    : `¿Confirmar que ${terapeuta} transfiere a cuenta NeuroTEA?`;

  if (!confirm(mensaje)) return;

  const opcion = {
    tipoOpcion: metodo === 'efectivo' ? 'devolucion-efectivo' : 'devolucion-transferencia'
  };
  executePaymentConfirmation(terapeuta, opcion);
}

/**
 * Ejecuta la confirmacion de pago en el backend
 */
function executePaymentConfirmation(terapeuta, opcionPago) {
  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Pago confirmado exitosamente', 'success');
        updateRendicionView();
        updateSummaryView();
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al confirmar pago: ' + error.message, 'error');
    })
    .confirmarPagoTerapeuta(terapeuta, fechaActual, opcionPago);
}

/**
 * Muestra opciones de pago para confirmacion (legacy - ahora usa dropdown)
 */
function showPaymentOptions(terapeuta) {
  confirmPaymentSimple(terapeuta);
}

/**
 * Maneja seleccion de opcion de pago desde dropdown inline (DAR EFECTIVO)
 */
function handlePaymentOption(terapeuta, opcion) {
  if (!opcion) return;

  if (opcion === 'exacto') {
    if (!confirm('Dar exacto en efectivo a ' + terapeuta + '?')) {
      updateRendicionView();
      return;
    }
    executePaymentConfirmation(terapeuta, { tipoOpcion: 'exacto' });
  } else if (opcion === 'vuelto' || opcion === 'vuelto-efectivo') {
    google.script.run
      .withSuccessHandler(function(result) {
        if (!result.success) {
          showNotification('Error: ' + result.message, 'error');
          return;
        }
        const status = result.data;
        const montoADar = status.neuroteaLeDebe;
        const tipoVuelto = opcion === 'vuelto-efectivo' ? 'en efectivo' : 'por transferencia';
        const montoReal = prompt(
          'Debe dar ' + formatCurrency(montoADar) + '.\nCuanto va a entregar en efectivo?\n(Vuelto sera ' + tipoVuelto + ')',
          montoADar
        );
        if (!montoReal) { updateRendicionView(); return; }
        const monto = parseNumber(montoReal);
        if (monto <= montoADar) {
          alert('El monto debe ser mayor al adeudado para generar vuelto');
          updateRendicionView();
          return;
        }
        const vuelto = monto - montoADar;
        executePaymentConfirmation(terapeuta, {
          tipoOpcion: opcion,
          efectivoUsado: monto,
          vueltoEfectivo: opcion === 'vuelto-efectivo' ? vuelto : 0,
          vueltoTransferencia: opcion === 'vuelto' ? vuelto : 0
        });
      })
      .withFailureHandler(function(error) {
        showNotification('Error: ' + error.message, 'error');
      })
      .getEstadoTerapeuta(terapeuta, fechaActual);
  } else if (opcion === 'transferir') {
    if (!confirm('Transferir desde cuenta NeuroTEA a ' + terapeuta + '?')) {
      updateRendicionView();
      return;
    }
    executePaymentConfirmation(terapeuta, { tipoOpcion: 'transferir' });
  } else if (opcion === 'efectivo') {
    confirmPaymentTherapistGives(terapeuta, 'efectivo');
  } else if (opcion === 'transferencia') {
    confirmPaymentTherapistGives(terapeuta, 'transferencia');
  }
}

/**
 * Maneja seleccion de pago cuando la terapeuta debe dar (dropdown inline)
 */
function handleTherapistDebtPayment(terapeuta, metodo) {
  if (!metodo) return;

  const mensaje = metodo === 'efectivo'
    ? 'Confirmar que ' + terapeuta + ' entrega efectivo?'
    : 'Confirmar que ' + terapeuta + ' transfiere a cuenta NeuroTEA?';

  if (!confirm(mensaje)) {
    updateRendicionView();
    return;
  }

  executePaymentConfirmation(terapeuta, {
    tipoOpcion: metodo === 'efectivo' ? 'devolucion-efectivo' : 'devolucion-transferencia'
  });
}

/**
 * Genera comprobante HTML individual para un terapeuta
 * Obtiene estado del backend y usa datos cliente para construir el HTML profesional
 */
function generateTherapistReceipt(terapeuta) {
  showLoading(true);
  showNotification('Generando comprobante...', 'info');

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success && result.data) {
        var status = result.data;
        var htmlContent = generateReceiptHTMLContent(terapeuta, fechaActual, status);
        downloadHTMLFile(htmlContent, terapeuta, fechaActual);
        showNotification('Comprobante generado', 'success');
      } else {
        showNotification('No hay datos para generar comprobante', 'warning');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error generando comprobante: ' + error.message, 'error');
    })
    .getEstadoTerapeuta(terapeuta, fechaActual);
}

/**
 * Revierte una confirmacion
 */
function revertConfirmation(terapeuta) {
  if (!confirm(`¿Revertir confirmacion de ${terapeuta}?`)) return;

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Confirmacion revertida', 'success');
        updateRendicionView();
        updateSummaryView();
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al revertir: ' + error.message, 'error');
    })
    .revertirConfirmacionPago(terapeuta, fechaActual);
}

// ===========================
// GENERACION DE COMPROBANTES - SISTEMA COMPLETO
// Portado del sistema original NeuroTEA con diseño profesional
// ===========================

/**
 * Formatea fecha para comprobante (Ejemplo: "Lunes, 15 de Enero de 2025")
 * @param {string} fecha - Fecha en formato YYYY-MM-DD
 * @returns {string} - Fecha formateada
 */
function formatDateForReceipt(fecha) {
  var parts = fecha.split('-').map(Number);
  var fechaObj = new Date(parts[0], parts[1] - 1, parts[2]);
  var diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado'];
  var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  return diasSemana[fechaObj.getDay()] + ', ' + fechaObj.getDate() + ' de ' + meses[fechaObj.getMonth()] + ' de ' + fechaObj.getFullYear();
}

/**
 * Genera filas HTML de ingresos del dia para la tabla del comprobante
 * Usa variables globales del cliente: sesiones, paquetesFecha, sesionesGrupales
 * @param {string} terapeuta - Nombre del terapeuta
 * @returns {string} - Filas HTML de la tabla
 */
function generatePackageAndCreditRows(terapeuta) {
  var rows = [];

  // 1. Sesiones normales (sin credito usado)
  sesiones.filter(function(s) {
    return s.terapeuta === terapeuta && !s.usaCredito;
  }).forEach(function(session) {
    rows.push(
      '<tr>' +
        '<td>' + (session.paciente || 'Sin nombre') + '</td>' +
        '<td>SESION NORMAL</td>' +
        '<td class="currency">' + formatCurrency(session.valorSesion || 0) + '</td>' +
        '<td class="currency">' + formatCurrency(session.aporteNeurotea || 0) + '</td>' +
        '<td class="currency">' + formatCurrency(session.honorarios || 0) + '</td>' +
      '</tr>'
    );
  });

  // 2. Sesiones con credito usado (valores en Gs 0)
  sesiones.filter(function(s) {
    return s.terapeuta === terapeuta && s.usaCredito === true;
  }).forEach(function(session) {
    rows.push(
      '<tr>' +
        '<td>' + (session.paciente || 'Sin nombre') + '</td>' +
        '<td>SESION CON CREDITO</td>' +
        '<td class="currency">Gs 0</td>' +
        '<td class="currency">Gs 0</td>' +
        '<td class="currency">Gs 0</td>' +
      '</tr>'
    );
  });

  // 3. Paquetes comprados en la fecha actual
  paquetesFecha.filter(function(p) {
    return p.terapeuta === terapeuta;
  }).forEach(function(pkg) {
    var honorarios = (pkg.valorTotal || 0) - (pkg.aporteNeurotea || 0);
    rows.push(
      '<tr>' +
        '<td>' + (pkg.paciente || 'Sin nombre') + '</td>' +
        '<td>PAQUETE</td>' +
        '<td class="currency">' + formatCurrency(pkg.valorTotal || 0) + '</td>' +
        '<td class="currency">' + formatCurrency(pkg.aporteNeurotea || 0) + '</td>' +
        '<td class="currency">' + formatCurrency(honorarios) + '</td>' +
      '</tr>'
    );
  });

  // 4. Sesiones grupales donde participo esta terapeuta
  sesionesGrupales.filter(function(gs) {
    return gs.terapeutas && gs.terapeutas.indexOf(terapeuta) !== -1;
  }).forEach(function(gs) {
    var therapistCount = gs.cantidadTerapeutas || (gs.terapeutas ? gs.terapeutas.length : 1);
    var therapistIndex = gs.terapeutas ? gs.terapeutas.indexOf(terapeuta) : -1;
    var isFirstTherapist = therapistIndex === 0;

    // Valor proporcional
    var baseValor = Math.floor((gs.valorTotal || 0) / therapistCount);
    var residuoValor = (gs.valorTotal || 0) - (baseValor * therapistCount);
    var valorProporcional = baseValor + (isFirstTherapist ? residuoValor : 0);

    // Aporte proporcional
    var baseAporte = Math.floor((gs.aporteNeurotea || 0) / therapistCount);
    var residuoAporte = (gs.aporteNeurotea || 0) - (baseAporte * therapistCount);
    var aporteProporcion = baseAporte + (isFirstTherapist ? residuoAporte : 0);

    // Honorarios proporcionales
    var baseHonorarios = gs.honorariosPorTerapeuta || 0;
    var residuoHonorarios = gs.residuoHonorarios || 0;
    var honorariosProporcion = baseHonorarios + (isFirstTherapist ? residuoHonorarios : 0);

    rows.push(
      '<tr>' +
        '<td>' + (gs.grupoNombre || 'Sin nombre') + '</td>' +
        '<td>SESION GRUPAL</td>' +
        '<td class="currency">' + formatCurrency(valorProporcional) + '</td>' +
        '<td class="currency">' + formatCurrency(aporteProporcion) + '</td>' +
        '<td class="currency">' + formatCurrency(honorariosProporcion) + '</td>' +
      '</tr>'
    );
  });

  if (rows.length === 0) {
    return '<tr><td colspan="5" style="text-align: center; font-style: italic;">No hay registros para esta fecha</td></tr>';
  }

  return rows.join('');
}

/**
 * Genera la seccion HTML de detalle del pago para el comprobante
 * Incluye informacion sobre vueltos y modalidad de pago
 * @param {Object} status - Estado del terapeuta (de getEstadoTerapeuta)
 * @returns {string} - HTML de la seccion de detalle de pago
 */
function generatePaymentDetailSection(status) {
  var conf = status.confirmacionInfo;

  // Si no hay confirmacion, mostrar estado pendiente
  if (!conf || !conf.confirmado) {
    return '<div class="payment-detail-section pending">' +
      '<div class="payment-detail-title pending">' +
        'PAGO PENDIENTE DE CONFIRMACION' +
      '</div>' +
      '<div class="payment-modalidad">El pago aun no ha sido procesado en el sistema.</div>' +
    '</div>';
  }

  // Determinar modalidad de pago
  var modalidadTexto = '';
  var detalleHTML = '';
  var tipoOpcion = conf.tipoOpcion || 'exacto';

  // Detectar pago mixto para confirmaciones antiguas que no tienen tipoOpcion correcto
  if (tipoOpcion === 'exacto' && conf.efectivoUsado > 0 && conf.bancoUsado > 0) {
    tipoOpcion = 'dar-transferir';
  }

  switch(tipoOpcion) {
    case 'exacto':
      modalidadTexto = 'Pago en efectivo exacto';
      detalleHTML =
        '<div class="payment-detail-line">' +
          '<span>Efectivo entregado:</span>' +
          '<span>' + formatCurrency(conf.efectivoUsado || 0) + '</span>' +
        '</div>';
      break;

    case 'vuelto':
      var vueltoTransf = conf.vueltoTransferencia || 0;
      var entregadoVuelto = conf.efectivoUsado || 0;
      modalidadTexto = 'Pago en efectivo con vuelto por transferencia';
      detalleHTML =
        '<div class="payment-detail-line">' +
          '<span>Efectivo entregado:</span>' +
          '<span>' + formatCurrency(entregadoVuelto) + '</span>' +
        '</div>' +
        '<div class="payment-detail-line">' +
          '<span>Vuelto (transferencia a cuenta NeuroTEA):</span>' +
          '<span>' + formatCurrency(vueltoTransf) + '</span>' +
        '</div>' +
        '<div class="payment-detail-line highlight">' +
          '<span>Neto recibido por terapeuta:</span>' +
          '<span>' + formatCurrency(entregadoVuelto - vueltoTransf) + '</span>' +
        '</div>';
      break;

    case 'vuelto-efectivo':
      var vueltoEfectivo = conf.vueltoEfectivo || 0;
      var netoEfectivo = conf.efectivoUsado || 0;
      var entregadoTotal = netoEfectivo + vueltoEfectivo;
      modalidadTexto = 'Pago en efectivo con vuelto en efectivo';
      detalleHTML =
        '<div class="payment-detail-line">' +
          '<span>Efectivo entregado:</span>' +
          '<span>' + formatCurrency(entregadoTotal) + '</span>' +
        '</div>' +
        '<div class="payment-detail-line">' +
          '<span>Vuelto en efectivo (regresa a caja):</span>' +
          '<span>' + formatCurrency(vueltoEfectivo) + '</span>' +
        '</div>' +
        '<div class="payment-detail-line highlight">' +
          '<span>Neto recibido por terapeuta:</span>' +
          '<span>' + formatCurrency(netoEfectivo) + '</span>' +
        '</div>';
      break;

    case 'transferir':
      modalidadTexto = 'Pago por transferencia bancaria';
      detalleHTML =
        '<div class="payment-detail-line">' +
          '<span>Transferido desde cuenta NeuroTEA:</span>' +
          '<span>' + formatCurrency(conf.bancoUsado || 0) + '</span>' +
        '</div>';
      break;

    case 'dar-transferir':
      var efectivoDado = conf.efectivoUsado || 0;
      var transferenciaComplemento = conf.bancoUsado || 0;
      var totalPagado = efectivoDado + transferenciaComplemento;
      modalidadTexto = 'Pago mixto (efectivo + transferencia)';
      detalleHTML =
        '<div class="payment-detail-line">' +
          '<span>Efectivo entregado de caja:</span>' +
          '<span>' + formatCurrency(efectivoDado) + '</span>' +
        '</div>' +
        '<div class="payment-detail-line">' +
          '<span>Transferido desde cuenta NeuroTEA:</span>' +
          '<span>' + formatCurrency(transferenciaComplemento) + '</span>' +
        '</div>' +
        '<div class="payment-detail-line highlight">' +
          '<span>Total pagado a terapeuta:</span>' +
          '<span>' + formatCurrency(totalPagado) + '</span>' +
        '</div>';
      break;

    case 'devolucion-transferencia':
      modalidadTexto = 'Devolucion por transferencia bancaria';
      detalleHTML =
        '<div class="payment-detail-line">' +
          '<span>Transferencia recibida de terapeuta:</span>' +
          '<span>' + formatCurrency(Math.abs(conf.bancoUsado || 0)) + '</span>' +
        '</div>';
      break;

    case 'devolucion-efectivo':
      modalidadTexto = 'Devolucion en efectivo';
      detalleHTML =
        '<div class="payment-detail-line">' +
          '<span>Efectivo recibido de terapeuta:</span>' +
          '<span>' + formatCurrency(conf.efectivoRecibido || 0) + '</span>' +
        '</div>';
      break;

    default:
      if (conf.efectivoUsado > 0 && conf.bancoUsado > 0) {
        modalidadTexto = 'Pago mixto (efectivo + transferencia)';
        detalleHTML =
          '<div class="payment-detail-line">' +
            '<span>Efectivo de caja:</span>' +
            '<span>' + formatCurrency(conf.efectivoUsado || 0) + '</span>' +
          '</div>' +
          '<div class="payment-detail-line">' +
            '<span>Transferencia desde cuenta:</span>' +
            '<span>' + formatCurrency(conf.bancoUsado || 0) + '</span>' +
          '</div>' +
          '<div class="payment-detail-line highlight">' +
            '<span>Total pagado a terapeuta:</span>' +
            '<span>' + formatCurrency((conf.efectivoUsado || 0) + (conf.bancoUsado || 0)) + '</span>' +
          '</div>';
      } else if (conf.bancoUsado < 0) {
        modalidadTexto = 'Devolucion por transferencia bancaria';
        detalleHTML =
          '<div class="payment-detail-line">' +
            '<span>Transferencia recibida de terapeuta:</span>' +
            '<span>' + formatCurrency(Math.abs(conf.bancoUsado)) + '</span>' +
          '</div>';
      } else if (conf.efectivoRecibido > 0) {
        modalidadTexto = 'Devolucion en efectivo';
        detalleHTML =
          '<div class="payment-detail-line">' +
            '<span>Efectivo recibido de terapeuta:</span>' +
            '<span>' + formatCurrency(conf.efectivoRecibido || 0) + '</span>' +
          '</div>';
      } else {
        modalidadTexto = 'Pago procesado';
        detalleHTML =
          '<div class="payment-detail-line">' +
            '<span>Monto procesado:</span>' +
            '<span>' + formatCurrency(conf.efectivoUsado || conf.bancoUsado || 0) + '</span>' +
          '</div>';
      }
  }

  // Formatear timestamp de confirmacion
  var fechaConfirmacion = conf.timestamp ? new Date(conf.timestamp).toLocaleString('es-PY') : 'No disponible';

  return '<div class="payment-detail-section">' +
    '<div class="payment-detail-title">' +
      'DETALLE DEL PAGO CONFIRMADO' +
    '</div>' +
    '<div class="payment-modalidad">Modalidad: ' + modalidadTexto + '</div>' +
    detalleHTML +
    '<div class="payment-detail-line" style="margin-top: 10px; font-size: 9px; color: #666;">' +
      '<span>Confirmado:</span>' +
      '<span>' + fechaConfirmacion + '</span>' +
    '</div>' +
  '</div>';
}

/**
 * Genera observaciones dinamicas para el comprobante
 * Usa variables globales del cliente: sesiones, sesionesGrupales
 * @param {string} terapeuta - Nombre del terapeuta
 * @returns {Array<string>} - Lista de observaciones
 */
function generateDynamicObservations(terapeuta) {
  var observaciones = [];

  // Observaciones de sesiones con credito
  sesiones.filter(function(s) {
    return s.terapeuta === terapeuta;
  }).forEach(function(session) {
    if (session.usaCredito === true) {
      observaciones.push(
        (session.paciente || 'Sin nombre') + ': Sesion pagada con credito de paquete'
      );
    }
  });

  // Observaciones de sesiones grupales
  sesionesGrupales.filter(function(gs) {
    return gs.terapeutas && gs.terapeutas.indexOf(terapeuta) !== -1;
  }).forEach(function(gs) {
    var groupName = gs.grupoNombre || 'Sin nombre';
    var presentCount = gs.cantidadPresentes || 0;
    var therapistCount = gs.cantidadTerapeutas || (gs.terapeutas ? gs.terapeutas.length : 1);
    var totalValue = gs.valorTotal || 0;
    var valorPorTerapeuta = Math.floor(totalValue / therapistCount);

    observaciones.push(
      groupName + ': ' + presentCount + ' niños presentes. ' +
      formatCurrency(totalValue) + ' / ' + therapistCount + ' = ' +
      formatCurrency(valorPorTerapeuta) + ' p/terapeuta'
    );
  });

  if (observaciones.length === 0) {
    observaciones.push('Comprobante generado automaticamente por Sistema NeuroTEA');
  }

  return observaciones;
}

/**
 * Genera el HTML completo del comprobante con diseño profesional A4
 * Portado del sistema original con adaptacion a nombres GAS
 * @param {string} terapeuta - Nombre del terapeuta
 * @param {string} fecha - Fecha en formato YYYY-MM-DD
 * @param {Object} status - Estado calculado del terapeuta (de getEstadoTerapeuta)
 * @returns {string} - HTML completo del comprobante
 */
function generateReceiptHTMLContent(terapeuta, fecha, status) {
  try {
    // Datos basicos
    var fechaFormateada = formatDateForReceipt(fecha);
    var horaActual = new Date().toLocaleTimeString('es-PY', { hour: '2-digit', minute: '2-digit' });
    var numeroComprobante = '#CP-' + fecha.replace(/-/g, '') + '-001';

    // Conteo total de sesiones (individuales + grupales)
    var totalSesiones = (status.totalSesionesIndividuales || 0) + (status.totalSesionesGrupales || 0);

    // Calcular diferencia
    var diferencia = (status.neuroteaLeDebe || 0) - (status.terapeutaDebe || 0);

    // Generar filas de ingresos
    var ingresoRows = generatePackageAndCreditRows(terapeuta);

    // Texto del resultado final
    var textoResultado;
    if (diferencia > 0) {
      textoResultado = 'LA TERAPEUTA DEBE RECIBIR: ' + formatCurrency(Math.abs(diferencia));
    } else if (diferencia < 0) {
      textoResultado = 'LA TERAPEUTA DEBE DAR: ' + formatCurrency(Math.abs(diferencia));
    } else {
      textoResultado = 'SALDOS EQUILIBRADOS: Gs 0';
    }

    // Generar seccion de detalle del pago
    var detallePagoHTML = generatePaymentDetailSection(status);

    // Observaciones
    var observaciones = generateDynamicObservations(terapeuta);
    var observacionesHTML = observaciones.length > 0
      ? observaciones.join('<br>')
      : 'Comprobante generado automaticamente por Sistema NeuroTEA';

    // HTML completo con estilos profesionales para impresion A4
    return '<!DOCTYPE html>' +
'<html lang="es">' +
'<head>' +
    '<meta charset="UTF-8">' +
    '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
    '<title>Comprobante NeuroTEA - ' + terapeuta + '</title>' +
    '<style>' +
        'body {' +
            'margin: 0;' +
            'padding: 0;' +
            'font-family: Helvetica, Arial, sans-serif;' +
            'background: white;' +
            'color: black;' +
            'width: 210mm;' +
            'min-height: 297mm;' +
            'box-sizing: border-box;' +
        '}' +
        '.header {' +
            'background: #e6e6e6;' +
            'height: 60px;' +
            'padding: 0 30px;' +
            'position: relative;' +
            'display: flex;' +
            'align-items: center;' +
            'justify-content: space-between;' +
            'border-bottom: 1px solid #ccc;' +
            'margin: 0 auto;' +
            'max-width: 190mm;' +
        '}' +
        '.header-left {' +
            'position: relative;' +
            'flex: 1;' +
        '}' +
        '.avanza-text {' +
            'color: black;' +
            'font-style: italic;' +
            'font-size: 18px;' +
            'margin-bottom: -5px;' +
        '}' +
        '.neurotea-text {' +
            'color: black;' +
            'font-weight: bold;' +
            'font-size: 32px;' +
            'margin-top: -5px;' +
        '}' +
        '.tea-orange {' +
            'color: black;' +
        '}' +
        '.header-right {' +
            'color: black;' +
            'font-weight: bold;' +
            'font-size: 36px;' +
            'padding-right: 20px;' +
            'text-align: right;' +
            'flex: 0 0 auto;' +
        '}' +
        '.content {' +
            'padding: 20px 30px;' +
        '}' +
        '.basic-info {' +
            'margin-bottom: 20px;' +
            'border-bottom: 1px solid #000;' +
            'padding-bottom: 10px;' +
        '}' +
        '.info-grid {' +
            'display: grid;' +
            'grid-template-columns: 1fr 1fr;' +
            'gap: 20px;' +
            'margin-bottom: 10px;' +
        '}' +
        '.info-column {' +
            'display: flex;' +
            'flex-direction: column;' +
            'gap: 8px;' +
        '}' +
        '.info-item {' +
            'display: flex;' +
            'justify-content: space-between;' +
            'font-size: 12px;' +
        '}' +
        '.info-label {' +
            'font-weight: bold;' +
            'color: black;' +
        '}' +
        '.info-value {' +
            'color: black;' +
        '}' +
        '.packages-section {' +
            'margin: 20px 0;' +
        '}' +
        '.section-title {' +
            'background-color: #f5f5f5;' +
            'padding: 8px 12px;' +
            'font-weight: bold;' +
            'font-size: 12px;' +
            'color: black;' +
            'border: 1px solid #ddd;' +
            'margin-bottom: 0;' +
        '}' +
        '.sessions-table {' +
            'width: 100%;' +
            'border-collapse: collapse;' +
            'font-size: 10px;' +
            'margin-bottom: 20px;' +
        '}' +
        '.sessions-table th,' +
        '.sessions-table td {' +
            'padding: 6px 8px;' +
            'text-align: left;' +
            'border: 1px solid #ddd;' +
        '}' +
        '.sessions-table th {' +
            'background-color: #f5f5f5;' +
            'font-weight: bold;' +
            'color: black;' +
            'font-size: 10px;' +
        '}' +
        '.totals-section {' +
            'border: 1px solid #ddd;' +
            'padding: 15px;' +
            'margin: 20px 0;' +
            'background-color: #f9f9f9;' +
        '}' +
        '.total-line {' +
            'display: flex;' +
            'justify-content: space-between;' +
            'padding: 4px 0;' +
            'font-size: 11px;' +
        '}' +
        '.total-label {' +
            'font-weight: bold;' +
            'color: black;' +
        '}' +
        '.total-value {' +
            'color: black;' +
            'font-weight: bold;' +
        '}' +
        '.calculation-section {' +
            'border: 2px solid #000;' +
            'padding: 15px;' +
            'margin: 20px 0;' +
            'background-color: #f0f0f0;' +
        '}' +
        '.calc-title {' +
            'font-weight: bold;' +
            'font-size: 12px;' +
            'color: black;' +
            'margin-bottom: 10px;' +
            'text-align: center;' +
        '}' +
        '.calc-result {' +
            'font-size: 14px;' +
            'font-weight: bold;' +
            'text-align: center;' +
            'color: black;' +
            'background-color: white;' +
            'padding: 10px;' +
            'border: 1px solid #000;' +
            'margin-top: 10px;' +
        '}' +
        '.payment-detail-section {' +
            'margin: 20px 0;' +
            'padding: 15px;' +
            'border: 1px solid #ccc;' +
            'background-color: #f5f5f5;' +
            'border-radius: 0;' +
        '}' +
        '.payment-detail-section.pending {' +
            'border-color: #999;' +
            'background-color: #e8e8e8;' +
        '}' +
        '.payment-detail-title {' +
            'font-weight: bold;' +
            'font-size: 12px;' +
            'color: #333;' +
            'margin-bottom: 10px;' +
            'display: flex;' +
            'align-items: center;' +
        '}' +
        '.payment-detail-title.pending {' +
            'color: #555;' +
        '}' +
        '.payment-detail-line {' +
            'display: flex;' +
            'justify-content: space-between;' +
            'padding: 4px 0;' +
            'font-size: 11px;' +
            'color: black;' +
        '}' +
        '.payment-detail-line.highlight {' +
            'font-weight: bold;' +
            'border-top: 1px solid #999;' +
            'padding-top: 8px;' +
            'margin-top: 5px;' +
        '}' +
        '.payment-modalidad {' +
            'font-size: 11px;' +
            'color: #666;' +
            'margin-bottom: 8px;' +
            'font-style: italic;' +
        '}' +
        '.observations-section {' +
            'margin: 20px 0;' +
            'padding: 10px;' +
            'border: 1px solid #ddd;' +
            'background-color: #f9f9f9;' +
        '}' +
        '.obs-title {' +
            'font-weight: bold;' +
            'margin-bottom: 8px;' +
            'color: black;' +
            'font-size: 11px;' +
        '}' +
        '.obs-content {' +
            'font-size: 10px;' +
            'color: #555;' +
            'font-style: italic;' +
        '}' +
        '.signatures-section {' +
            'margin-top: 50px;' +
            'display: grid;' +
            'grid-template-columns: 1fr 1fr;' +
            'gap: 60px;' +
            'font-size: 11px;' +
            'padding: 0 40px;' +
        '}' +
        '.signature-block {' +
            'text-align: center;' +
        '}' +
        '.signature-line {' +
            'border-bottom: 2px dotted #666;' +
            'width: 150px;' +
            'margin: 0 auto 10px auto;' +
            'height: 40px;' +
        '}' +
        '.signature-text {' +
            'font-weight: bold;' +
            'margin-bottom: 8px;' +
            'color: black;' +
            'font-size: 11px;' +
        '}' +
        '.signature-name {' +
            'font-weight: normal;' +
            'color: black;' +
            'font-size: 11px;' +
        '}' +
        '.currency {' +
            'font-family: monospace;' +
            'color: black;' +
        '}' +
        '@media print {' +
            'body { width: auto; min-height: auto; }' +
        '}' +
    '</style>' +
'</head>' +
'<body>' +
    '<!-- ENCABEZADO -->' +
    '<div class="header">' +
        '<div class="header-left">' +
            '<div class="avanza-text">Avanza</div>' +
            '<div class="neurotea-text">Neuro<span class="tea-orange">TEA</span></div>' +
        '</div>' +
        '<div class="header-right">COMPROBANTE</div>' +
    '</div>' +
    '<!-- CONTENIDO -->' +
    '<div class="content">' +
        '<!-- INFORMACION BASICA -->' +
        '<div class="basic-info">' +
            '<div class="info-grid">' +
                '<div class="info-column">' +
                    '<div class="info-item">' +
                        '<span class="info-label">TERAPEUTA:</span>' +
                        '<span class="info-value">' + terapeuta + '</span>' +
                    '</div>' +
                    '<div class="info-item">' +
                        '<span class="info-label">FECHA:</span>' +
                        '<span class="info-value">' + fechaFormateada + '</span>' +
                    '</div>' +
                    '<div class="info-item">' +
                        '<span class="info-label">SESIONES:</span>' +
                        '<span class="info-value">' + totalSesiones + ' sesiones realizadas</span>' +
                    '</div>' +
                '</div>' +
                '<div class="info-column">' +
                    '<div class="info-item">' +
                        '<span class="info-label">COMPROBANTE:</span>' +
                        '<span class="info-value">' + numeroComprobante + '</span>' +
                    '</div>' +
                    '<div class="info-item">' +
                        '<span class="info-label">HORA:</span>' +
                        '<span class="info-value">' + horaActual + '</span>' +
                    '</div>' +
                    '<div class="info-item">' +
                        '<span class="info-label">ESTADO:</span>' +
                        '<span class="info-value">' + (diferencia > 0 ? 'DEBE RECIBIR' : diferencia < 0 ? 'DEBE DAR' : 'EQUILIBRADO') + '</span>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>' +
        '<!-- DETALLE DE INGRESOS DEL DIA -->' +
        '<div class="packages-section">' +
            '<h3 class="section-title">DETALLE DE INGRESOS DEL DIA</h3>' +
            '<table class="sessions-table">' +
                '<thead>' +
                    '<tr>' +
                        '<th style="width: 25%;">PACIENTE</th>' +
                        '<th style="width: 20%;">TIPO</th>' +
                        '<th style="width: 20%;">VALOR SESION</th>' +
                        '<th style="width: 17.5%;">APORTE NEUROTEA</th>' +
                        '<th style="width: 17.5%;">HONORARIOS</th>' +
                    '</tr>' +
                '</thead>' +
                '<tbody>' +
                    ingresoRows +
                '</tbody>' +
            '</table>' +
        '</div>' +
        '<!-- TOTALES -->' +
        '<div class="totals-section">' +
            '<div class="total-line">' +
                '<span class="total-label">VALOR TOTAL SESIONES:</span>' +
                '<span class="total-value currency">' + formatCurrency(status.valorTotalSesiones || 0) + '</span>' +
            '</div>' +
            '<div class="total-line">' +
                '<span class="total-label">TOTAL APORTE NEUROTEA:</span>' +
                '<span class="total-value currency">' + formatCurrency(status.aporteNeuroTEA || 0) + '</span>' +
            '</div>' +
            '<div class="total-line">' +
                '<span class="total-label">TOTAL HONORARIOS:</span>' +
                '<span class="total-value currency">' + formatCurrency(status.honorarios || 0) + '</span>' +
            '</div>' +
            '<div class="total-line">' +
                '<span class="total-label">TRANSFERENCIAS A TERAPEUTA:</span>' +
                '<span class="total-value currency">' + formatCurrency(status.transferenciaATerapeuta || 0) + '</span>' +
            '</div>' +
            '<div class="total-line">' +
                '<span class="total-label">ADELANTOS RECIBIDOS:</span>' +
                '<span class="total-value currency">' + formatCurrency(status.adelantosRecibidos || 0) + '</span>' +
            '</div>' +
        '</div>' +
        '<!-- CALCULO FINAL -->' +
        '<div class="calculation-section">' +
            '<div class="calc-title">CALCULO FINAL</div>' +
            '<div class="calc-result">' + textoResultado + '</div>' +
        '</div>' +
        '<!-- DETALLE DEL PAGO -->' +
        detallePagoHTML +
        '<!-- OBSERVACIONES -->' +
        '<div class="observations-section">' +
            '<div class="obs-title">OBSERVACIONES:</div>' +
            '<div class="obs-content">' +
                observacionesHTML +
            '</div>' +
        '</div>' +
        '<!-- FIRMAS -->' +
        '<div class="signatures-section">' +
            '<div class="signature-block">' +
                '<div class="signature-line"></div>' +
                '<div class="signature-text">RECIBI CONFORME</div>' +
                '<div class="signature-name">' + terapeuta + '</div>' +
            '</div>' +
            '<div class="signature-block">' +
                '<div class="signature-line"></div>' +
                '<div class="signature-text">ENTREGUE CONFORME</div>' +
                '<div class="signature-name">Secretaria NeuroTEA</div>' +
            '</div>' +
        '</div>' +
    '</div>' +
'</body>' +
'</html>';

  } catch (error) {
    console.error('Error en generateReceiptHTMLContent:', error);
    return '<!DOCTYPE html><html><head><title>Error</title></head><body style="color: #000;">' +
      '<h1>Error al generar comprobante</h1>' +
      '<p>Error: ' + error.message + '</p>' +
      '<p>Terapeuta: ' + terapeuta + '</p>' +
      '<p>Fecha: ' + fecha + '</p>' +
    '</body></html>';
  }
}

/**
 * Formatea fecha para mostrar
 */
function formatDateDisplay(fecha) {
  const parts = fecha.split('-');
  return parts[2] + '/' + parts[1] + '/' + parts[0];
}

/**
 * Descarga archivo HTML
 */
function downloadHTMLFile(htmlContent, terapeuta, fecha) {
  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Comprobante_' + terapeuta.replace(/\\s+/g, '_') + '_' + fecha + '.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===========================
// MINI CARRITO DE SESIONES FUTURAS
// ===========================

/**
 * Inicializa el dropdown de terapeutas para sesiones futuras
 */
function initTerapeutasFuturasSelect() {
  const select = document.getElementById('terapeuta-futura-select');
  if (!select) return;

  select.innerHTML = '<option value="">Seleccionar terapeuta...</option>';
  terapeutas.forEach(t => {
    const nombre = typeof t === 'string' ? t : t.nombre;
    select.innerHTML += `<option value="${nombre}">${nombre}</option>`;
  });
}

/**
 * Toggle para mostrar/ocultar el carrito de sesiones futuras
 */
function toggleSesionesFuturasContainer() {
  const checkbox = document.getElementById('crear-creditos-adicionales');
  const container = document.getElementById('sesiones-futuras-container');

  if (checkbox.checked) {
    container.style.display = 'block';
    initTerapeutasFuturasSelect();
  } else {
    container.style.display = 'none';
    sesionesFuturasTemp = [];
    actualizarListaSesionesFuturas();
  }
}

/**
 * Agrega una sesion futura al carrito temporal
 */
function agregarSesionFutura() {
  const terapeutaSelect = document.getElementById('terapeuta-futura-select');
  const cantidadInput = document.getElementById('cantidad-futura-input');

  const terapeuta = terapeutaSelect.value;
  const cantidad = parseInt(cantidadInput.value) || 1;

  if (!terapeuta) {
    showNotification('Selecciona una terapeuta', 'warning');
    return;
  }

  if (cantidad < 1 || cantidad > 20) {
    showNotification('La cantidad debe estar entre 1 y 20', 'warning');
    return;
  }

  // Obtener valores de la sesion actual para calcular el precio
  const cash = parseNumber(document.getElementById('cash-to-neurotea').value) || 0;
  const transferNeurotea = parseNumber(document.getElementById('transfer-to-neurotea').value) || 0;
  const transferTerapeuta = parseNumber(document.getElementById('transfer-to-therapist').value) || 0;
  const valorSesionActual = cash + transferNeurotea + transferTerapeuta;

  // Calcular aporte NeuroTEA
  const contributionSelected = document.querySelector('input[name="neurotea-contribution"]:checked');
  let porcentajeAporte = 30;
  let aporteNeurotea = 0;

  if (contributionSelected) {
    if (contributionSelected.value === 'fixed') {
      aporteNeurotea = parseNumber(document.getElementById('fixed-amount-input').value) || 0;
    } else {
      porcentajeAporte = parseInt(contributionSelected.value) || 30;
      aporteNeurotea = Math.round(valorSesionActual * (porcentajeAporte / 100));
    }
  }

  const valorPorSesion = valorSesionActual;
  const totalFutura = valorPorSesion * cantidad;

  // Verificar si ya existe una entrada para este terapeuta
  const existingIndex = sesionesFuturasTemp.findIndex(s => s.terapeuta === terapeuta);

  if (existingIndex >= 0) {
    // Actualizar cantidad existente
    sesionesFuturasTemp[existingIndex].cantidad += cantidad;
    sesionesFuturasTemp[existingIndex].total = sesionesFuturasTemp[existingIndex].cantidad * valorPorSesion;
  } else {
    // Agregar nueva entrada
    sesionesFuturasTemp.push({
      id: Date.now(),
      terapeuta: terapeuta,
      cantidad: cantidad,
      valorPorSesion: valorPorSesion,
      porcentajeAporte: porcentajeAporte,
      aporteNeurotea: aporteNeurotea,
      total: totalFutura
    });
  }

  // Limpiar formulario
  terapeutaSelect.value = '';
  cantidadInput.value = '1';

  actualizarListaSesionesFuturas();
  showNotification(`${cantidad} sesion(es) futura(s) agregada(s) para ${terapeuta}`, 'success');
}

/**
 * Actualiza la vista de la lista de sesiones futuras
 */
function actualizarListaSesionesFuturas() {
  const lista = document.getElementById('lista-sesiones-futuras');
  const resumen = document.getElementById('resumen-sesiones-futuras');

  if (sesionesFuturasTemp.length === 0) {
    lista.innerHTML = `
      <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-2 italic">
        No hay sesiones futuras agregadas
      </div>
    `;
    resumen.style.display = 'none';
    return;
  }

  lista.innerHTML = sesionesFuturasTemp.map(sesion => `
    <div class="bg-white dark:bg-gray-800 p-3 rounded border flex items-center justify-between">
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <span class="font-medium text-gray-800 dark:text-white">${sesion.terapeuta}</span>
          <span class="text-sm text-gray-500">x${sesion.cantidad} sesiones</span>
        </div>
        <div class="text-sm text-gray-600 dark:text-gray-400">
          ${formatCurrency(sesion.valorPorSesion)}/sesion = ${formatCurrency(sesion.total)}
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="editarSesionFutura(${sesion.id})" class="text-blue-500 hover:text-blue-700 p-1" title="Editar">
          <i data-lucide="edit-2" class="w-4 h-4"></i>
        </button>
        <button onclick="eliminarSesionFutura(${sesion.id})" class="text-red-500 hover:text-red-700 p-1" title="Eliminar">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
      </div>
    </div>
  `).join('');

  resumen.style.display = 'block';
  calcularGranTotal();
  lucide.createIcons();
}

/**
 * Calcula el gran total de sesion actual + sesiones futuras
 */
function calcularGranTotal() {
  // Total de sesion actual
  const cash = parseNumber(document.getElementById('cash-to-neurotea').value) || 0;
  const transferNeurotea = parseNumber(document.getElementById('transfer-to-neurotea').value) || 0;
  const transferTerapeuta = parseNumber(document.getElementById('transfer-to-therapist').value) || 0;
  const totalActual = cash + transferNeurotea + transferTerapeuta;

  // Total de sesiones futuras
  const totalFuturas = sesionesFuturasTemp.reduce((sum, sesion) => sum + sesion.total, 0);

  // Gran total
  const granTotal = totalActual + totalFuturas;

  // Actualizar displays
  const totalSesionActualEl = document.getElementById('total-sesion-actual');
  const totalSesionesFuturasEl = document.getElementById('total-sesiones-futuras');
  const granTotalEl = document.getElementById('gran-total-pagar');

  if (totalSesionActualEl) totalSesionActualEl.textContent = formatCurrency(totalActual);
  if (totalSesionesFuturasEl) totalSesionesFuturasEl.textContent = formatCurrency(totalFuturas);
  if (granTotalEl) granTotalEl.textContent = formatCurrency(granTotal);
}

/**
 * Edita una sesion futura del carrito
 */
function editarSesionFutura(sesionId) {
  const sesion = sesionesFuturasTemp.find(s => s.id == sesionId);
  if (!sesion) return;

  const nuevaCantidad = prompt(`Cantidad de sesiones para ${sesion.terapeuta}:`, sesion.cantidad);
  if (nuevaCantidad === null) return;

  const cantidad = parseInt(nuevaCantidad);
  if (cantidad < 1 || cantidad > 20 || isNaN(cantidad)) {
    showNotification('Cantidad invalida (1-20)', 'error');
    return;
  }

  sesion.cantidad = cantidad;
  sesion.total = sesion.valorPorSesion * cantidad;

  actualizarListaSesionesFuturas();
}

/**
 * Elimina una sesion futura del carrito
 */
function eliminarSesionFutura(sesionId) {
  sesionesFuturasTemp = sesionesFuturasTemp.filter(s => s.id != sesionId);
  actualizarListaSesionesFuturas();
}

/**
 * Procesa y crea todos los creditos de sesiones futuras
 * @param {string} pacienteName - Nombre del paciente
 * @param {string} fechaCompra - Fecha de compra
 * @returns {number} - Cantidad de creditos creados
 */
function procesarSesionesFuturas(pacienteName, fechaCompra) {
  if (sesionesFuturasTemp.length === 0) return 0;

  let creditosCreados = 0;

  sesionesFuturasTemp.forEach(sesion => {
    // Crear paquete/creditos para cada terapeuta
    const paqueteData = {
      paciente: pacienteName,
      terapeuta: sesion.terapeuta,
      sesionesTotal: sesion.cantidad,
      valorTotal: sesion.total,
      porcentajeAporte: sesion.porcentajeAporte,
      efectivo: 0,
      transferenciaNeurotea: 0,
      transferenciaTerapeuta: 0,
      notas: 'Sesiones futuras pagadas junto con sesion principal'
    };

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          creditosCreados += sesion.cantidad;
          console.log('Creditos creados para ' + sesion.terapeuta + ': ' + sesion.cantidad);
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error creando creditos para ' + sesion.terapeuta, error);
      })
      .crearPaquete(paqueteData, fechaCompra);
  });

  // Limpiar carrito temporal
  sesionesFuturasTemp = [];
  actualizarListaSesionesFuturas();

  return creditosCreados;
}

/**
 * Limpia el mini carrito de sesiones futuras
 */
function limpiarMiniCarrito() {
  sesionesFuturasTemp = [];
  const sesionesFuturasContainer = document.getElementById('sesiones-futuras-container');
  if (sesionesFuturasContainer) {
    sesionesFuturasContainer.style.display = 'none';
  }
  const checkboxCreditos = document.getElementById('crear-creditos-adicionales');
  if (checkboxCreditos) {
    checkboxCreditos.checked = false;
  }
  actualizarListaSesionesFuturas();
}

// ===========================
// HISTORIAL DE PAQUETES
// ===========================

/**
 * Abre el modal de historial de paquetes
 */
function openPackageHistoryModal() {
  const modal = document.getElementById('package-history-modal');
  modal.classList.remove('hidden');
  loadPackageHistory();
  lucide.createIcons();
}

/**
 * Cierra el modal de historial de paquetes
 */
function closePackageHistoryModal() {
  document.getElementById('package-history-modal').classList.add('hidden');
}

/**
 * Carga el historial de paquetes desde el servidor
 */
function loadPackageHistory() {
  const container = document.getElementById('package-history-table-container');
  const totalDisplay = document.getElementById('package-history-total');

  container.innerHTML = '<p class="text-gray-500 text-center py-4">Cargando...</p>';

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success && result.data && result.data.length > 0) {
        const history = result.data;

        // Ordenar por fecha de compra descendente
        history.sort((a, b) => {
          const dateA = a.fechaCompletado || a.fechaCompra || '';
          const dateB = b.fechaCompletado || b.fechaCompra || '';
          return dateB.localeCompare(dateA);
        });

        // Generar tabla
        container.innerHTML = `
          <table class="min-w-full">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Paciente</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Terapeuta</th>
                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Sesiones</th>
                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Valor</th>
                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">F. Compra</th>
                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">F. Completado</th>
                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
              ${history.map(pkg => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                  <td class="px-3 py-2 text-sm font-medium">${pkg.paciente || '-'}</td>
                  <td class="px-3 py-2 text-sm">${pkg.terapeuta || '-'}</td>
                  <td class="px-3 py-2 text-sm text-center">${pkg.sesionesTotal || 0}</td>
                  <td class="px-3 py-2 text-sm text-right">${formatCurrency(pkg.valorTotal || 0)}</td>
                  <td class="px-3 py-2 text-sm text-center">${pkg.fechaCompra || '-'}</td>
                  <td class="px-3 py-2 text-sm text-center">${pkg.fechaCompletado || '-'}</td>
                  <td class="px-3 py-2 text-sm text-center">
                    <button onclick="deletePackageFromHistory(${pkg.id})" class="text-red-500 hover:text-red-700" title="Eliminar">
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        totalDisplay.textContent = 'Total: ' + history.length + ' paquete' + (history.length !== 1 ? 's' : '');
        lucide.createIcons();
      } else {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay paquetes completados en el historial</p>';
        totalDisplay.textContent = 'Total: 0 paquetes';
      }
    })
    .withFailureHandler(function(error) {
      container.innerHTML = '<p class="text-red-500 text-center py-4">Error cargando historial</p>';
      totalDisplay.textContent = 'Total: 0 paquetes';
    })
    .getHistorialPaquetes();
}

/**
 * Elimina un paquete del historial
 */
function deletePackageFromHistory(packageId) {
  if (!confirm('¿Eliminar este paquete del historial?')) return;

  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Paquete eliminado del historial', 'success');
        loadPackageHistory();
        updatePackageHistoryCounter();
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .eliminarPaqueteHistorial(packageId);
}

/**
 * Actualiza el contador de paquetes en historial
 */
function updatePackageHistoryCounter() {
  google.script.run
    .withSuccessHandler(function(result) {
      const counter = document.getElementById('history-packages-counter');
      if (counter && result.success) {
        counter.textContent = result.data || 0;
      }
    })
    .withFailureHandler(function(error) {
      console.warn('Error actualizando contador de historial:', error.message);
    })
    .getHistorialPaquetesCount();
}

// ===========================
// FUNCIONES DE BACKUP
// ===========================

/**
 * Exporta backup completo
 */
function exportFullBackup() {
  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        downloadJSON(result.data, 'neurotea_backup_completo_' + fechaActual + '.json');
        showNotification('Backup descargado', 'success');
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al crear backup: ' + error.message, 'error');
    })
    .crearBackupCompleto();
}

/**
 * Exporta datos del dia
 */
function exportDayData() {
  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        downloadJSON(result.data, 'neurotea_datos_' + fechaActual + '.json');
        showNotification('Datos del dia descargados', 'success');
      } else {
        showNotification(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al exportar: ' + error.message, 'error');
    })
    .exportarDatosDia(fechaActual);
}

/**
 * Importa datos (deprecada - redirige a importDayData o importFullBackup segun tipo)
 */
function importData() {
  var fileInput = document.getElementById('import-day-file') || document.getElementById('restore-backup-file');
  if (!fileInput) {
    showNotification('Elemento de archivo no encontrado', 'error');
    return;
  }
  var file = fileInput.files ? fileInput.files[0] : null;

  if (!file) {
    showNotification('Seleccione un archivo', 'warning');
    return;
  }

  // Password protection
  var password = prompt('Ingrese la contrasena para importar datos:');
  if (password !== '280208') {
    showNotification('Contrasena incorrecta', 'error');
    return;
  }

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);

      if (data.backupInfo && data.backupInfo.type === 'full_backup') {
        // Validar estructura
        if (!validateFullBackupStructure(data)) {
          showNotification('El archivo no tiene estructura valida de backup completo', 'error');
          return;
        }
        if (!confirm('Restaurar backup completo? Esto reemplazara TODOS los datos.')) return;

        showLoading(true);
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            if (result.success) {
              showNotification('Backup restaurado', 'success');
              loadInitialData();
            } else {
              showNotification(result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showLoading(false);
            showNotification('Error al restaurar: ' + error.message, 'error');
          })
          .restaurarBackupCompleto(data);

      } else if (data.exportInfo && data.exportInfo.type === 'day_data') {
        // Validar estructura
        if (!validateDayDataStructure(data)) {
          showNotification('El archivo no tiene estructura valida de datos del dia', 'error');
          return;
        }

        var fecha = data.exportInfo.fecha;

        // Detectar conflictos
        var existingData = {
          sesiones: (fecha === fechaActual) ? sesiones : [],
          sesionesGrupales: (fecha === fechaActual) ? sesionesGrupales : [],
          egresos: (fecha === fechaActual) ? egresos : []
        };

        var conflicts = detectDataConflicts(existingData, data);

        if (conflicts.hasConflicts) {
          showConflictResolutionDialog(fecha, data, conflicts);
        } else {
          executeDayDataImport(fecha, data, 'merge');
        }

      } else {
        showNotification('Formato de archivo no reconocido', 'error');
      }
    } catch (error) {
      showNotification('Error leyendo archivo: ' + error.message, 'error');
    }
  };
  reader.readAsText(file);
}

/**
 * Descarga objeto como JSON
 */
function downloadJSON(data, filename) {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===========================
// FUNCIONES WRAPPER PARA BOTONES
// ===========================

/**
 * Registrar sesion (wrapper para boton)
 */
function registerSession() {
  const terapeuta = document.getElementById('therapist-select').value;
  const paciente = document.getElementById('patient-name').value.trim();
  const efectivo = parseFloat(document.getElementById('cash-to-neurotea').value) || 0;
  const transferenciaNeurotea = parseFloat(document.getElementById('transfer-to-neurotea').value) || 0;
  const transferenciaTerapeuta = parseFloat(document.getElementById('transfer-to-therapist').value) || 0;

  if (!terapeuta) {
    showNotification('Seleccione un terapeuta', 'error');
    return;
  }
  if (!paciente) {
    showNotification('Ingrese el nombre del paciente', 'error');
    return;
  }

  const valorSesion = efectivo + transferenciaNeurotea + transferenciaTerapeuta;
  if (valorSesion <= 0) {
    showNotification('Ingrese un monto de pago', 'error');
    return;
  }

  // Obtener tipo de aporte
  const tipoAporteRadio = document.querySelector('input[name="neurotea-contribution"]:checked');
  const tipoAporte = tipoAporteRadio ? tipoAporteRadio.value : '30';
  const montoFijo = tipoAporte === 'fixed' ? parseFloat(document.getElementById('fixed-amount-input').value) || 0 : 0;

  // Calcular aporte
  let aporteNeurotea;
  if (tipoAporte === 'fixed') {
    aporteNeurotea = montoFijo;
  } else {
    aporteNeurotea = Math.round(valorSesion * (parseInt(tipoAporte) / 100));
  }
  const honorarios = valorSesion - aporteNeurotea;

  // Verificar si hay sesiones futuras en el carrito
  const tieneSesionesFuturas = sesionesFuturasTemp.length > 0;

  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        // Si hay sesiones futuras, procesarlas
        if (tieneSesionesFuturas) {
          procesarSesionesFuturas(paciente, fechaActual);
          showNotification('Sesion registrada con creditos futuros', 'success');
        } else {
          showNotification('Sesion registrada correctamente', 'success');
        }

        // Limpiar mini carrito y formulario
        limpiarMiniCarrito();
        resetSessionForm();
        loadDateData(fechaActual);
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .registrarSesion({
      fecha: fechaActual,
      terapeuta: terapeuta,
      paciente: paciente,
      efectivo: efectivo,
      transferenciaNeurotea: transferenciaNeurotea,
      transferenciaTerapeuta: transferenciaTerapeuta,
      valorSesion: valorSesion,
      aporteNeurotea: aporteNeurotea,
      honorarios: honorarios,
      tipoAporte: tipoAporte
    });
}

/**
 * Registrar egreso (wrapper para boton)
 */
function registerEgreso() {
  const tipo = document.getElementById('egreso-type').value;
  const concepto = document.getElementById('egreso-concept').value.trim();
  const monto = parseFloat(document.getElementById('egreso-value').value) || 0;
  const terapeuta = document.getElementById('egreso-therapist-select').value;

  if (!tipo) {
    showNotification('Seleccione un tipo de egreso', 'error');
    return;
  }
  if (monto <= 0) {
    showNotification('Ingrese un monto valido', 'error');
    return;
  }
  if (tipo === 'adelanto' && !terapeuta) {
    showNotification('Seleccione una terapeuta', 'error');
    return;
  }

  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Egreso registrado correctamente', 'success');
        document.getElementById('egreso-type').value = '';
        document.getElementById('egreso-concept').value = '';
        document.getElementById('egreso-value').value = '';
        document.getElementById('egreso-therapist-container').style.display = 'none';
        loadDateData(fechaActual);
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .registrarEgreso({
      fecha: fechaActual,
      tipo: tipo,
      concepto: concepto,
      monto: monto,
      terapeuta: tipo === 'adelanto' ? terapeuta : null
    });
}

/**
 * Agregar terapeuta (wrapper para boton)
 */
function addTherapist() {
  const nombre = document.getElementById('new-therapist-name').value.trim();
  if (!nombre) {
    showNotification('Ingrese el nombre de la terapeuta', 'error');
    return;
  }

  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Terapeuta agregada correctamente', 'success');
        document.getElementById('new-therapist-name').value = '';
        terapeutas.push(result.data);
        updateTherapistSelects();
        updateTherapistsList();
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .crearTerapeuta(nombre);
}

/**
 * Crear grupo (wrapper para boton)
 */
function createGroup() {
  const nombre = document.getElementById('new-group-name').value.trim();
  const porcentaje = parseInt(document.getElementById('new-group-percentage').value) || 30;

  if (!nombre) {
    showNotification('Ingrese el nombre del grupo', 'error');
    return;
  }

  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Grupo creado - Agregue los niños', 'success');
        document.getElementById('new-group-name').value = '';
        document.getElementById('new-group-percentage').value = '30';
        gruposActivos.push(result.data);
        updateGroupsList();
        updateGroupSelects();
        // Abrir modal de edicion para agregar niños inmediatamente
        openEditGroupModal(result.data.id);
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .crearGrupo({
      nombre: nombre,
      porcentajeAporte: porcentaje,
      ninos: []
    });
}

/**
 * Limpiar sesiones del dia
 */
function clearDaySessions() {
  if (!confirm('¿Está seguro de eliminar TODAS las sesiones de hoy?')) return;
  showLoading(true);

  // Eliminar todas las sesiones del dia actual
  const promises = sesiones.map(s => {
    return new Promise((resolve) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(resolve)
        .eliminarSesion(s.id);
    });
  });

  Promise.all(promises).then(() => {
    showLoading(false);
    showNotification('Sesiones eliminadas', 'success');
    loadDateData(fechaActual);
  });
}

/**
 * Limpia TODOS los registros del dia actual
 * Incluye: sesiones, sesiones grupales, egresos, paquetes, confirmaciones
 */
function clearDayRecords() {
  const mensaje =
    '⚠️ ADVERTENCIA: Esta acción eliminará TODOS los registros del día:\n\n' +
    '• ' + sesiones.length + ' sesiones individuales\n' +
    '• ' + sesionesGrupales.length + ' sesiones grupales\n' +
    '• ' + egresos.length + ' egresos\n' +
    '• Paquetes comprados hoy\n' +
    '• Todas las confirmaciones de rendición\n\n' +
    '¿Está seguro de continuar?';

  if (!confirm(mensaje)) return;

  // Segunda confirmación para operación destructiva
  if (!confirm('Esta acción NO se puede deshacer. ¿Confirma que desea proceder?')) return;

  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        const c = result.data;
        const resumen =
          'Registros eliminados:\n' +
          '• Sesiones: ' + c.sesiones + '\n' +
          '• Sesiones grupales: ' + c.sesionesGrupales + '\n' +
          '• Egresos: ' + c.egresos + '\n' +
          '• Paquetes: ' + c.paquetes + '\n' +
          '• Confirmaciones: ' + c.confirmaciones;

        alert(resumen);
        showNotification('Día limpiado exitosamente', 'success');
        loadDateData(fechaActual);
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .limpiarDiaCompleto(fechaActual);
}

/**
 * Limpiar egresos del dia
 */
function clearDayEgresos() {
  if (!confirm('Esta seguro de eliminar TODOS los egresos de hoy?')) return;
  showLoading(true);

  const promises = egresos.map(e => {
    return new Promise((resolve) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(resolve)
        .eliminarEgreso(e.id);
    });
  });

  Promise.all(promises).then(() => {
    showLoading(false);
    showNotification('Egresos eliminados', 'success');
    loadDateData(fechaActual);
  });
}

// ===========================
// FUNCIONES DE MODALES
// ===========================

/**
 * Actualiza el badge de saldo inicial (color del punto segun estado)
 */
function updateSaldoBadge() {
  const badge = document.getElementById('saldo-inicial-badge');
  const dot = document.getElementById('saldo-status-dot');
  if (!badge || !dot) return;

  // Limpiar clases previas
  dot.classList.remove('bg-gray-400', 'bg-green-500', 'bg-orange-500');

  if (saldoInicial === 0) {
    // Gris: Sin definir
    dot.classList.add('bg-gray-400');
    badge.title = 'Saldo inicial: No definido';
  } else {
    // Verde: Configurado
    dot.classList.add('bg-green-500');
    badge.title = 'Saldo inicial: ' + formatCurrency(saldoInicial);
  }
}

/**
 * Abrir modal de saldo inicial
 */
function openSaldoModal() {
  document.getElementById('saldo-modal').classList.remove('hidden');
  document.getElementById('saldo-actual-display').textContent = formatCurrency(saldoInicial).replace('Gs ', '');
  lucide.createIcons();
}

/**
 * Cerrar modal de saldo inicial
 */
function closeSaldoModal() {
  document.getElementById('saldo-modal').classList.add('hidden');
  document.getElementById('saldo-edit-section').classList.add('hidden');
  document.getElementById('saldo-action-buttons').classList.remove('hidden');
  // Limpiar input para evitar datos residuales
  const saldoInput = document.getElementById('nuevo-saldo-input');
  if (saldoInput) saldoInput.value = '';
}

/**
 * Alternar modo edicion de saldo
 */
function toggleEditMode() {
  const editSection = document.getElementById('saldo-edit-section');
  const actionButtons = document.getElementById('saldo-action-buttons');

  if (editSection.classList.contains('hidden')) {
    editSection.classList.remove('hidden');
    actionButtons.classList.add('hidden');
    document.getElementById('nuevo-saldo-input').value = saldoInicial || '';
  } else {
    editSection.classList.add('hidden');
    actionButtons.classList.remove('hidden');
  }
}

/**
 * Guardar saldo inicial
 */
function saveSaldoInicial() {
  const nuevoSaldo = parseFloat(document.getElementById('nuevo-saldo-input').value) || 0;

  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        saldoInicial = nuevoSaldo;
        showNotification('Saldo inicial guardado', 'success');
        closeSaldoModal();
        updateAllViews();
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .establecerSaldoInicial(fechaActual, nuevoSaldo);
}

/**
 * Toggle historial visibility
 */
function toggleHistorial() {
  const content = document.getElementById('historial-content');
  const chevron = document.getElementById('historial-chevron');

  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    chevron.style.transform = 'rotate(180deg)';
    updateHistorialDisplay();
  } else {
    content.classList.add('hidden');
    chevron.style.transform = 'rotate(0deg)';
  }
}

/**
 * Update historial display
 */
function updateHistorialDisplay() {
  const container = document.getElementById('historial-list');
  const counter = document.getElementById('historial-counter');

  // Obtener historial del servidor
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success && result.data && result.data.length > 0) {
        const historial = result.data;
        counter.textContent = historial.length;

        container.innerHTML = historial.map(entrada => `
          <div class="flex justify-between items-center text-sm bg-gray-50 dark:bg-gray-700 p-2 rounded">
            <div>
              <span class="font-medium">${formatCurrency(entrada.valorAnterior)}</span>
              <i data-lucide="arrow-right" class="w-3 h-3 inline mx-1"></i>
              <span class="font-medium text-blue-600">${formatCurrency(entrada.valorNuevo)}</span>
            </div>
            <span class="text-xs text-gray-500">${formatTimestamp(entrada.timestamp)}</span>
          </div>
        `).join('');

        lucide.createIcons();
      } else {
        counter.textContent = '0';
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">No hay cambios registrados</p>';
      }
    })
    .withFailureHandler(function(error) {
      counter.textContent = '0';
      container.innerHTML = '<p class="text-sm text-red-500 text-center py-2">Error cargando historial</p>';
    })
    .getHistorialSaldos(fechaActual);
}

/**
 * Format timestamp for display
 */
function formatTimestamp(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  return date.toLocaleTimeString('es-PY', { hour: '2-digit', minute: '2-digit' });
}

/**
 * Clear historial saldo (with password protection)
 */
function clearHistorialSaldo() {
  const password = prompt('Ingrese contrasena para limpiar historial:');

  if (password !== '280208') {
    showNotification('Contrasena incorrecta', 'error');
    return;
  }

  if (!confirm('¿Esta seguro de que desea resetear completamente el saldo inicial? Esto limpiara el historial Y volvera el saldo a 0. Esta accion no se puede deshacer.')) {
    return;
  }

  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        saldoInicial = 0;
        showNotification('Historial y saldo limpiados', 'success');
        closeSaldoModal();
        updateAllViews();
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .limpiarHistorialYSaldo(fechaActual);
}

/**
 * Abrir modal de sesion grupal
 */
function openGroupSessionModal() {
  document.getElementById('group-session-modal').classList.remove('hidden');
  updateGroupSelects();
  lucide.createIcons();
}

/**
 * Cerrar modal de sesion grupal
 */
function closeGroupSessionModal() {
  document.getElementById('group-session-modal').classList.add('hidden');
  document.getElementById('group-select').value = '';
  document.getElementById('group-therapists-section').classList.add('hidden');
  document.getElementById('group-attendance-section').classList.add('hidden');
  document.getElementById('group-values-section').classList.add('hidden');
  // Limpiar contenido dinamico para evitar memory leaks
  const therapistsList = document.getElementById('group-therapists-list');
  if (therapistsList) therapistsList.innerHTML = '';
  const attendanceList = document.getElementById('group-attendance-list');
  if (attendanceList) attendanceList.innerHTML = '';
  // Resetear radio a pago-dia (replica comportamiento original)
  var modoPagoDia = document.getElementById('modo-pago-dia');
  if (modoPagoDia) {
    modoPagoDia.checked = true;
    togglePaymentMode();
  }
}

/**
 * Manejar cambio de seleccion de grupo
 */
function onGroupSelectChange() {
  const grupoId = document.getElementById('group-select').value;

  if (!grupoId) {
    document.getElementById('group-therapists-section').classList.add('hidden');
    document.getElementById('group-attendance-section').classList.add('hidden');
    document.getElementById('group-values-section').classList.add('hidden');
    return;
  }

  const grupo = gruposActivos.find(g => g.id == grupoId);
  if (!grupo) return;

  // Mostrar secciones
  document.getElementById('group-therapists-section').classList.remove('hidden');
  document.getElementById('group-attendance-section').classList.remove('hidden');
  document.getElementById('group-values-section').classList.remove('hidden');

  // Llenar lista de terapeutas con checkboxes
  const therapistsList = document.getElementById('group-therapists-list');
  therapistsList.innerHTML = terapeutas.map(t => `
    <label class="flex items-center space-x-2 p-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
      <input type="checkbox" class="group-therapist-checkbox" value="${t.nombre}">
      <span>${t.nombre}</span>
    </label>
  `).join('');

  // Llenar lista de ninos
  const ninos = grupo.ninos || [];
  const attendanceList = document.getElementById('group-attendance-list');
  attendanceList.innerHTML = ninos.map(nino => `
    <div class="border rounded p-3 bg-white dark:bg-gray-600">
      <div class="flex items-center justify-between mb-2">
        <label class="flex items-center space-x-2">
          <input type="checkbox" class="child-attendance-checkbox" data-child="${nino.nombre}" checked>
          <span class="font-medium">${nino.nombre}</span>
        </label>
      </div>
      <div class="grid grid-cols-3 gap-2">
        <div>
          <label class="text-xs text-gray-500">Valor</label>
          <input type="number" class="child-value w-full p-1 border rounded text-sm" data-child="${nino.nombre}" value="${nino.valor || 0}" min="0">
        </div>
        <div>
          <label class="text-xs text-gray-500">Efectivo</label>
          <input type="number" class="child-cash w-full p-1 border rounded text-sm" data-child="${nino.nombre}" value="0" min="0">
        </div>
        <div>
          <label class="text-xs text-gray-500">Transf. NeuroTEA</label>
          <input type="number" class="child-transfer w-full p-1 border rounded text-sm" data-child="${nino.nombre}" value="0" min="0">
        </div>
      </div>
    </div>
  `).join('') || '<p class="text-gray-500 text-center">No hay niños en este grupo</p>';

  // Agregar event listeners a los elementos dinamicos
  document.querySelectorAll('.group-therapist-checkbox').forEach(cb => {
    cb.addEventListener('change', updateGroupSessionTotals);
  });
  document.querySelectorAll('.child-attendance-checkbox').forEach(cb => {
    cb.addEventListener('change', updateGroupSessionTotals);
  });
  document.querySelectorAll('.child-value, .child-cash, .child-transfer').forEach(input => {
    input.addEventListener('input', updateGroupSessionTotals);
  });

  // Calcular totales iniciales
  updateGroupSessionTotals();

  lucide.createIcons();
}

/**
 * Actualiza los totales de sesion grupal en tiempo real
 */
function updateGroupSessionTotals() {
  const grupoId = document.getElementById('group-select').value;
  const grupo = gruposActivos.find(g => g.id == grupoId);
  if (!grupo) return;

  // Contar terapeutas seleccionados
  const terapeutasSeleccionados = document.querySelectorAll('.group-therapist-checkbox:checked').length;

  // Calcular totales de ninos presentes
  let childrenCount = 0;
  let totalValue = 0;
  let totalCash = 0;
  let totalTransfer = 0;

  document.querySelectorAll('.child-attendance-checkbox').forEach(cb => {
    if (cb.checked) {
      childrenCount++;
      const childName = cb.dataset.child;
      totalValue += parseNumber(document.querySelector(`.child-value[data-child="${childName}"]`)?.value);
      totalCash += parseNumber(document.querySelector(`.child-cash[data-child="${childName}"]`)?.value);
      totalTransfer += parseNumber(document.querySelector(`.child-transfer[data-child="${childName}"]`)?.value);
    }
  });

  // Calcular aporte y honorarios
  const aporteNeurotea = Math.round(totalValue * (grupo.porcentajeAporte / 100));
  const honorariosTotales = totalValue - aporteNeurotea;
  const honorariosPorTerapeuta = terapeutasSeleccionados > 0 ? Math.floor(honorariosTotales / terapeutasSeleccionados) : 0;

  // Actualizar displays
  document.getElementById('group-children-count').textContent = childrenCount;
  document.getElementById('group-total-value').textContent = formatCurrency(totalValue);
  document.getElementById('group-neurotea-value').textContent = formatCurrency(aporteNeurotea);
  document.getElementById('group-therapist-fee').textContent = formatCurrency(honorariosPorTerapeuta);
  document.getElementById('group-total-cash').textContent = formatCurrency(totalCash);
  document.getElementById('group-total-transfer-neurotea').textContent = formatCurrency(totalTransfer);

  // Mostrar advertencia si totales de pago no coinciden con valor
  const totalPagos = totalCash + totalTransfer;
  const warningEl = document.getElementById('group-payment-warning');
  if (warningEl) {
    if (childrenCount > 0 && totalPagos !== totalValue) {
      warningEl.classList.remove('hidden');
      warningEl.textContent = 'El total de pagos (' + formatCurrency(totalPagos) + ') no coincide con el valor de la sesion (' + formatCurrency(totalValue) + ')';
    } else {
      warningEl.classList.add('hidden');
    }
  }

  // Habilitar/deshabilitar boton de registro
  const registerBtn = document.getElementById('register-group-btn');
  if (registerBtn) {
    registerBtn.disabled = childrenCount === 0 || terapeutasSeleccionados === 0;
  }
}

/**
 * Registrar sesion grupal
 */
function registerGroupSession() {
  const grupoId = document.getElementById('group-select').value;
  const grupo = gruposActivos.find(g => g.id == grupoId);

  if (!grupo) {
    showNotification('Seleccione un grupo', 'error');
    return;
  }

  // Obtener terapeutas seleccionados
  const therapistCheckboxes = document.querySelectorAll('.group-therapist-checkbox:checked');
  const terapeutasSeleccionados = Array.from(therapistCheckboxes).map(cb => cb.value);

  if (terapeutasSeleccionados.length === 0) {
    showNotification('Seleccione al menos una terapeuta', 'error');
    return;
  }

  // Obtener asistencia
  const asistencia = [];
  document.querySelectorAll('.child-attendance-checkbox').forEach(cb => {
    const childName = cb.dataset.child;
    const presente = cb.checked;
    const valor = parseFloat(document.querySelector(`.child-value[data-child="${childName}"]`).value) || 0;
    const efectivo = parseFloat(document.querySelector(`.child-cash[data-child="${childName}"]`).value) || 0;
    const transferencia = parseFloat(document.querySelector(`.child-transfer[data-child="${childName}"]`).value) || 0;

    asistencia.push({
      nombre: childName,
      presente: presente,
      valor: valor,
      efectivo: efectivo,
      transferencia: transferencia
    });
  });

  const presentes = asistencia.filter(a => a.presente);
  if (presentes.length === 0) {
    showNotification('Marque al menos un niño como presente', 'error');
    return;
  }

  // Calcular totales
  const valorTotal = presentes.reduce((sum, a) => sum + a.valor, 0);
  const totalEfectivo = presentes.reduce((sum, a) => sum + a.efectivo, 0);
  const totalTransferencia = presentes.reduce((sum, a) => sum + a.transferencia, 0);
  const aporteNeurotea = Math.round(valorTotal * (grupo.porcentajeAporte / 100));
  const honorariosTotales = valorTotal - aporteNeurotea;
  const honorariosPorTerapeuta = Math.floor(honorariosTotales / terapeutasSeleccionados.length);

  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Sesion grupal registrada correctamente', 'success');
        closeGroupSessionModal();
        loadDateData(fechaActual);
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .registrarSesionGrupal({
      fecha: fechaActual,
      grupoId: grupoId,
      grupoNombre: grupo.nombre,
      asistencia: asistencia,
      terapeutas: terapeutasSeleccionados,
      cantidadTerapeutas: terapeutasSeleccionados.length,
      cantidadPresentes: presentes.length,
      valorTotal: valorTotal,
      porcentajeAporte: grupo.porcentajeAporte,
      aporteNeurotea: aporteNeurotea,
      honorariosTotales: honorariosTotales,
      honorariosPorTerapeuta: honorariosPorTerapeuta,
      efectivo: totalEfectivo,
      transferenciaNeurotea: totalTransferencia
    });
}

// Variable para grupo en edicion
let currentEditingGroup = null;

/**
 * Abrir modal de editar grupo
 */
function openEditGroupModal(grupoId) {
  const grupo = gruposActivos.find(g => g.id == grupoId);
  if (!grupo) return;

  currentEditingGroup = grupo;
  document.getElementById('edit-group-modal').classList.remove('hidden');
  document.getElementById('edit-group-id').value = grupo.id;
  document.getElementById('edit-group-title').textContent = grupo.nombre;
  document.getElementById('edit-group-name').value = grupo.nombre;
  document.getElementById('edit-group-percentage').value = grupo.porcentajeAporte || 30;

  updateEditGroupChildrenList();
  lucide.createIcons();
}

/**
 * Cerrar modal de editar grupo
 */
function closeEditGroupModal() {
  document.getElementById('edit-group-modal').classList.add('hidden');
  currentEditingGroup = null;
}

/**
 * Actualizar lista de ninos en edicion
 */
function updateEditGroupChildrenList() {
  const container = document.getElementById('edit-group-children-list');
  const ninos = currentEditingGroup?.ninos || [];

  if (ninos.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay niños en este grupo</p>';
    return;
  }

  container.innerHTML = ninos.map(function(nino, i) {
    return '<div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-600 rounded">' +
      '<span class="flex-1 text-sm font-medium">' + nino.nombre + '</span>' +
      '<div class="flex items-center gap-1">' +
        '<label class="text-xs text-gray-500">Gs</label>' +
        '<input type="number" class="child-group-value w-24 p-1 border rounded text-sm dark:bg-gray-500 dark:border-gray-400" ' +
          'data-index="' + i + '" value="' + (nino.valor || 0) + '" min="0" ' +
          'onchange="updateChildValue(' + i + ', this.value)">' +
      '</div>' +
      '<button onclick="removeChildFromGroup(\'' + nino.nombre + '\')" class="text-red-500 hover:text-red-700 p-1">' +
        '<i data-lucide="x" class="w-4 h-4"></i>' +
      '</button>' +
    '</div>';
  }).join('');

  lucide.createIcons();
}

/**
 * Actualiza el valor de un niño en el grupo en edicion
 */
function updateChildValue(index, value) {
  if (!currentEditingGroup || !currentEditingGroup.ninos) return;
  if (index >= 0 && index < currentEditingGroup.ninos.length) {
    currentEditingGroup.ninos[index].valor = parseInt(value) || 0;
  }
}

/**
 * Agregar nino al grupo actual
 */
function addChildToCurrentGroup() {
  const nombre = document.getElementById('new-child-name').value.trim();
  const valorInput = document.getElementById('new-child-value');
  const valor = parseInt(valorInput?.value) || 0;

  if (!nombre) {
    showNotification('Ingrese el nombre del niño', 'error');
    return;
  }

  if (!currentEditingGroup) return;

  if (!currentEditingGroup.ninos) {
    currentEditingGroup.ninos = [];
  }

  // Verificar duplicados (igual que sistema original)
  var existe = currentEditingGroup.ninos.some(function(n) {
    return n.nombre.toLowerCase() === nombre.toLowerCase();
  });
  if (existe) {
    showNotification('Este niño ya está en el grupo', 'error');
    return;
  }

  currentEditingGroup.ninos.push({ nombre: nombre, valor: valor });
  document.getElementById('new-child-name').value = '';
  if (valorInput) valorInput.value = '';
  updateEditGroupChildrenList();
}

/**
 * Eliminar nino del grupo
 */
function removeChildFromGroup(nombre) {
  if (!currentEditingGroup) return;
  currentEditingGroup.ninos = currentEditingGroup.ninos.filter(n => n.nombre !== nombre);
  updateEditGroupChildrenList();
}

/**
 * Guardar cambios del grupo
 */
function saveGroupChanges() {
  if (!currentEditingGroup) return;

  const nombre = document.getElementById('edit-group-name').value.trim();
  const porcentaje = parseInt(document.getElementById('edit-group-percentage').value) || 30;

  if (!nombre) {
    showNotification('Ingrese el nombre del grupo', 'error');
    return;
  }

  // Sincronizar precios desde los inputs del DOM antes de guardar
  document.querySelectorAll('.child-group-value').forEach(function(input) {
    var idx = parseInt(input.dataset.index);
    if (currentEditingGroup.ninos && idx >= 0 && idx < currentEditingGroup.ninos.length) {
      currentEditingGroup.ninos[idx].valor = parseInt(input.value) || 0;
    }
  });

  // Capturar datos antes de cerrar modal (closeEditGroupModal anula currentEditingGroup)
  var grupoId = currentEditingGroup.id;
  var ninosGuardados = (currentEditingGroup.ninos || []).slice();

  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showNotification('Grupo actualizado correctamente', 'success');
        // Actualizar en memoria ANTES de cerrar modal
        var idx = gruposActivos.findIndex(g => g.id == grupoId);
        if (idx >= 0) {
          gruposActivos[idx] = { ...gruposActivos[idx], nombre: nombre, porcentajeAporte: porcentaje, ninos: ninosGuardados };
        }
        closeEditGroupModal();
        updateGroupsList();
        updateGroupSelects();
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error: ' + error.message, 'error');
    })
    .actualizarGrupo(grupoId, {
      nombre: nombre,
      porcentajeAporte: porcentaje,
      ninos: ninosGuardados
    });
}

// ===========================
// FUNCIONES DE ADMINISTRACION
// ===========================

/**
 * Cambiar modulo de administracion
 */
function switchAdminModule(moduleId) {
  // Esta funcion solo cambia la apariencia, los modulos futuros no estan implementados
  document.querySelectorAll('.admin-module-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.admin-module-content').forEach(content => {
    content.classList.add('hidden');
  });

  document.querySelector(`[onclick="switchAdminModule('${moduleId}')"]`)?.classList.add('active');
  const module = document.getElementById(`${moduleId}-module`);
  if (module) module.classList.remove('hidden');
}

/**
 * Crear backup completo
 */
function createFullBackup() {
  exportFullBackup();
}

/**
 * Importar backup completo (con validacion de estructura)
 */
function importFullBackup() {
  var fileInput = document.getElementById('restore-backup-file');
  var file = fileInput.files[0];

  if (!file) {
    showNotification('Seleccione un archivo', 'error');
    return;
  }

  // Password protection
  var password = prompt('Ingrese la contrasena para restaurar el backup:');
  if (password !== '280208') {
    showNotification('Contrasena incorrecta', 'error');
    return;
  }

  if (!confirm('Esta seguro? Esta operacion reemplazara TODOS los datos actuales.')) {
    return;
  }

  if (!confirm('ULTIMA CONFIRMACION: Se perderan todos los datos actuales. Continuar?')) {
    return;
  }

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);

      // Validar estructura del backup
      if (!validateFullBackupStructure(data)) {
        showNotification('El archivo no tiene la estructura valida para backup completo', 'error');
        return;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading(false);
          if (result.success) {
            showNotification('Backup restaurado correctamente. Recargando...', 'success');
            setTimeout(function() { location.reload(); }, 2000);
          } else {
            showNotification('Error: ' + result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showNotification('Error: ' + error.message, 'error');
        })
        .restaurarBackupCompleto(data);
    } catch (error) {
      showNotification('Error al leer el archivo: ' + error.message, 'error');
    }
  };
  reader.readAsText(file);
}

/**
 * Importar datos del dia (con deteccion de conflictos)
 */
function importDayData() {
  var fileInput = document.getElementById('import-day-file');
  var file = fileInput.files[0];

  if (!file) {
    showNotification('Seleccione un archivo', 'error');
    return;
  }

  // Password protection
  var password = prompt('Ingrese la contrasena para importar datos:');
  if (password !== '280208') {
    showNotification('Contrasena incorrecta', 'error');
    return;
  }

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);

      // Validar estructura del archivo
      if (!validateDayDataStructure(data)) {
        showNotification('El archivo no tiene la estructura valida para datos del dia', 'error');
        return;
      }

      var fecha = data.exportInfo.fecha;

      // Detectar conflictos antes de importar
      if (fecha === fechaActual) {
        // Usar datos ya cargados en memoria para la fecha actual
        var conflicts = detectDataConflicts({
          sesiones: sesiones,
          sesionesGrupales: sesionesGrupales,
          egresos: egresos
        }, data);

        if (conflicts.hasConflicts) {
          showConflictResolutionDialog(fecha, data, conflicts);
        } else {
          executeDayDataImport(fecha, data, 'merge');
        }
      } else {
        // Cargar datos de la fecha destino para detectar conflictos
        showLoading(true);
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            if (result.success) {
              var existingData = result.data;
              var conflicts = detectDataConflicts({
                sesiones: existingData.sesiones || [],
                sesionesGrupales: existingData.sesionesGrupales || [],
                egresos: existingData.egresos || []
              }, data);

              if (conflicts.hasConflicts) {
                showConflictResolutionDialog(fecha, data, conflicts);
              } else {
                executeDayDataImport(fecha, data, 'merge');
              }
            } else {
              // No se pudieron cargar datos, proceder con merge (modo seguro)
              executeDayDataImport(fecha, data, 'merge');
            }
          })
          .withFailureHandler(function(error) {
            showLoading(false);
            // En caso de error, proceder con merge como fallback
            executeDayDataImport(fecha, data, 'merge');
          })
          .cargarDatosFecha(fecha);
      }

    } catch (error) {
      showNotification('Error al leer el archivo: ' + error.message, 'error');
    }
  };
  reader.readAsText(file);
}

/**
 * Valida la estructura de un archivo de datos del dia
 * @param {Object} data - Datos parseados del archivo JSON
 * @returns {boolean} - true si la estructura es valida
 */
function validateDayDataStructure(data) {
  return data &&
         data.exportInfo &&
         data.exportInfo.type === 'day_data' &&
         data.exportInfo.fecha &&
         Array.isArray(data.sessions) &&
         Array.isArray(data.egresos);
}

/**
 * Valida la estructura de un archivo de backup completo
 * @param {Object} data - Datos parseados del archivo JSON
 * @returns {boolean} - true si la estructura es valida
 */
function validateFullBackupStructure(data) {
  return data &&
         data.backupInfo &&
         data.backupInfo.type === 'full_backup' &&
         (data.backupInfo.createdAt || data.backupInfo.date);
}

/**
 * Detecta conflictos entre datos existentes y datos a importar
 * @param {Object} existingData - Datos existentes {sesiones, sesionesGrupales, egresos}
 * @param {Object} importData - Datos del archivo a importar
 * @returns {Object} - Resultado con hasConflicts, detalles por tipo
 */
function detectDataConflicts(existingData, importData) {
  var conflicts = {
    hasConflicts: false,
    sessions: false,
    groupSessions: false,
    egresos: false,
    details: []
  };

  var existingSesiones = existingData.sesiones || [];
  var existingGrupales = existingData.sesionesGrupales || [];
  var existingEgresos = existingData.egresos || [];

  var importSesiones = importData.sessions || [];
  var importGrupales = importData.groupSessions || [];
  var importEgresos = importData.egresos || [];

  // Verificar conflictos en sesiones individuales
  if (existingSesiones.length > 0 && importSesiones.length > 0) {
    conflicts.hasConflicts = true;
    conflicts.sessions = true;
    conflicts.details.push(existingSesiones.length + ' sesiones existentes vs ' + importSesiones.length + ' en el archivo');
  }

  // Verificar conflictos en sesiones grupales
  if (existingGrupales.length > 0 && importGrupales.length > 0) {
    conflicts.hasConflicts = true;
    conflicts.groupSessions = true;
    conflicts.details.push(existingGrupales.length + ' sesiones grupales existentes vs ' + importGrupales.length + ' en el archivo');
  }

  // Verificar conflictos en egresos
  if (existingEgresos.length > 0 && importEgresos.length > 0) {
    conflicts.hasConflicts = true;
    conflicts.egresos = true;
    conflicts.details.push(existingEgresos.length + ' egresos existentes vs ' + importEgresos.length + ' en el archivo');
  }

  return conflicts;
}

/**
 * Muestra dialogo de resolucion de conflictos al importar datos del dia
 * Permite al usuario elegir: fusionar, sobrescribir o cancelar
 * @param {string} fecha - Fecha de los datos
 * @param {Object} importData - Datos a importar
 * @param {Object} conflicts - Resultado de detectDataConflicts()
 */
function showConflictResolutionDialog(fecha, importData, conflicts) {
  // Guardar datos temporalmente para los handlers del dialogo
  window.tempImportData = importData;
  window.tempImportFecha = fecha;

  // Remover dialogo previo si existe
  var existing = document.getElementById('conflict-dialog');
  if (existing) {
    document.body.removeChild(existing);
  }

  var dialog = document.createElement('div');
  dialog.id = 'conflict-dialog';
  dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

  var detailsHtml = conflicts.details.map(function(d) {
    return '<li class="flex items-start"><span class="mr-2 text-red-500">&#8226;</span><span>' + d + '</span></li>';
  }).join('');

  dialog.innerHTML =
    '<div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">' +
      '<h3 class="text-lg font-bold mb-4 text-red-600 dark:text-red-400">Conflictos Detectados</h3>' +
      '<p class="text-sm text-gray-600 dark:text-gray-400 mb-3">' +
        'Ya existen datos para la fecha <strong>' + fecha + '</strong>:' +
      '</p>' +
      '<ul class="text-sm mb-4 space-y-1 text-gray-700 dark:text-gray-300">' +
        detailsHtml +
      '</ul>' +
      '<p class="text-sm font-medium mb-4 text-gray-800 dark:text-gray-200">Como desea proceder?</p>' +
      '<div class="space-y-2">' +
        '<button id="conflict-merge-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm font-medium">' +
          'Fusionar (Combinar ambos datos)' +
        '</button>' +
        '<button id="conflict-overwrite-btn" class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm font-medium">' +
          'Sobrescribir (Reemplazar existentes)' +
        '</button>' +
        '<button id="conflict-cancel-btn" class="w-full bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 text-sm font-medium">' +
          'Cancelar' +
        '</button>' +
      '</div>' +
      '<p class="text-xs text-gray-500 dark:text-gray-500 mt-3">' +
        'Fusionar: agrega datos nuevos sin borrar existentes. Sobrescribir: elimina datos del dia y los reemplaza.' +
      '</p>' +
    '</div>';

  document.body.appendChild(dialog);

  // Event listeners con addEventListener (no inline onclick)
  document.getElementById('conflict-merge-btn').addEventListener('click', function() {
    closeConflictDialog();
    executeDayDataImport(window.tempImportFecha, window.tempImportData, 'merge');
    cleanupConflictTemp();
  });

  document.getElementById('conflict-overwrite-btn').addEventListener('click', function() {
    closeConflictDialog();
    executeDayDataImport(window.tempImportFecha, window.tempImportData, 'overwrite');
    cleanupConflictTemp();
  });

  document.getElementById('conflict-cancel-btn').addEventListener('click', function() {
    closeConflictDialog();
    cleanupConflictTemp();
    showNotification('Importacion cancelada', 'info');
  });

  // Cerrar con click en overlay
  dialog.addEventListener('click', function(e) {
    if (e.target === dialog) {
      closeConflictDialog();
      cleanupConflictTemp();
      showNotification('Importacion cancelada', 'info');
    }
  });
}

/**
 * Cierra el dialogo de conflictos
 */
function closeConflictDialog() {
  var dialog = document.getElementById('conflict-dialog');
  if (dialog) {
    document.body.removeChild(dialog);
  }
}

/**
 * Limpia datos temporales del dialogo de conflictos
 */
function cleanupConflictTemp() {
  delete window.tempImportData;
  delete window.tempImportFecha;
}

/**
 * Ejecuta la importacion de datos del dia al backend
 * @param {string} fecha - Fecha de los datos
 * @param {Object} importData - Datos a importar
 * @param {string} mode - Modo: 'merge' o 'overwrite'
 */
function executeDayDataImport(fecha, importData, mode) {
  showLoading(true);

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        var modeLabel = mode === 'overwrite' ? 'sobrescritura' : 'fusion';
        showNotification('Datos importados correctamente (modo: ' + modeLabel + ')', 'success');
        // Recargar datos de la fecha importada
        loadDateData(fecha);
        // Limpiar input de archivo
        var fileInput = document.getElementById('import-day-file');
        if (fileInput) fileInput.value = '';
      } else {
        showNotification('Error: ' + result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showNotification('Error al importar: ' + error.message, 'error');
    })
    .importarDatosDia(importData, mode);
}

/**
 * Generar reporte HTML profesional de rendicion
 * Calcula todos los datos localmente desde variables globales GAS
 * Genera documento HTML standalone optimizado para impresion
 */
function generateRendicionHTML() {
  const fecha = fechaActual;

  // Formatear fecha legible
  const [year, month, day] = fecha.split('-').map(Number);
  const fechaLocal = new Date(year, month - 1, day);
  const fechaFormateada = fechaLocal.toLocaleDateString('es-PY', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
  const fechaCapitalizada = fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1);

  // Datos del dia desde variables globales GAS
  const daySessions = sesiones || [];
  const dayGroupSessions = sesionesGrupales || [];
  const dayEgresos = egresos || [];
  const dayPackages = paquetesFecha || [];
  const confs = Array.isArray(confirmaciones) ? confirmaciones : [];

  // Calcular totales generales
  let totalGeneral = 0;
  let totalEfectivo = 0;
  let totalTransfNeurotea = 0;
  let aporteTotalNeuroTEA = 0;

  daySessions.forEach(function(s) {
    if (!s.usaCredito) {
      totalGeneral += s.valorSesion || 0;
      totalEfectivo += s.efectivo || 0;
      totalTransfNeurotea += s.transferenciaNeurotea || 0;
      aporteTotalNeuroTEA += s.aporteNeurotea || 0;
    }
  });

  dayPackages.forEach(function(p) {
    totalGeneral += p.valorTotal || 0;
    totalEfectivo += p.efectivo || 0;
    totalTransfNeurotea += p.transferenciaNeurotea || 0;
    aporteTotalNeuroTEA += p.aporteNeurotea || 0;
  });

  dayGroupSessions.forEach(function(gs) {
    totalGeneral += gs.valorTotal || 0;
    totalEfectivo += gs.efectivo || 0;
    totalTransfNeurotea += gs.transferenciaNeurotea || 0;
    aporteTotalNeuroTEA += gs.aporteNeurotea || 0;
  });

  var totalEgresosVal = 0;
  dayEgresos.forEach(function(e) { totalEgresosVal += e.monto || 0; });

  // Saldos dinamicos
  var saldoCaja = calcularSaldoCajaLocal();
  var cuentaNeuroTEA = calcularCuentaNeuroTEALocal();

  // Obtener terapeutas unicos del dia
  var therapistsFromSessions = daySessions.map(function(s) { return s.terapeuta; });
  var therapistsFromPackages = dayPackages.map(function(p) { return p.terapeuta; });
  var therapistsFromGroupSessions = dayGroupSessions.reduce(function(acc, gs) {
    var t = gs.terapeutas || gs.terapeutasJSON || [];
    return acc.concat(t);
  }, []);
  var uniqueTherapists = [];
  var seen = {};
  therapistsFromSessions.concat(therapistsFromPackages).concat(therapistsFromGroupSessions).forEach(function(t) {
    if (t && !seen[t]) {
      seen[t] = true;
      uniqueTherapists.push(t);
    }
  });

  // Helper para clase de badge de estado
  function getStatusBadgeClass(estado, isConfirmed) {
    if (isConfirmed) return 'confirmado';
    if (estado === 'SALDADO') return 'equilibrado';
    if (estado === 'LA TERAPEUTA DEBE DAR') return 'debe-dar';
    if (estado === 'DAR EFECTIVO' || estado === 'DAR Y TRANSFERIR' || estado === 'TRANSFERIR') return 'debe-recibir';
    return 'equilibrado';
  }

  // Generar filas de terapeutas con calculo local de estado
  var therapistRowsHTML = '';
  if (uniqueTherapists.length > 0) {
    uniqueTherapists.forEach(function(therapist) {
      // Sesiones individuales
      var valorTotal = 0, aporteNeurotea = 0, honorariosTotal = 0, transferenciaATerapeuta = 0;

      daySessions.forEach(function(s) {
        if (s.terapeuta !== therapist) return;
        if (s.usaCredito) return;
        valorTotal += s.valorSesion || 0;
        aporteNeurotea += s.aporteNeurotea || 0;
        honorariosTotal += s.honorarios || 0;
        transferenciaATerapeuta += s.transferenciaTerapeuta || 0;
      });

      // Sesiones grupales (proporcional por terapeuta)
      dayGroupSessions.forEach(function(gs) {
        var terapeutasList = gs.terapeutas || gs.terapeutasJSON || [];
        var index = terapeutasList.indexOf(therapist);
        if (index === -1) return;

        var isFirst = index === 0;
        var cantidadTerapeutas = gs.cantidadTerapeutas || terapeutasList.length;

        var valorProp = Math.floor((gs.valorTotal || 0) / cantidadTerapeutas);
        var residuoValor = (gs.valorTotal || 0) - (valorProp * cantidadTerapeutas);

        var aporteProp = Math.floor((gs.aporteNeurotea || 0) / cantidadTerapeutas);
        var residuoAporte = (gs.aporteNeurotea || 0) - (aporteProp * cantidadTerapeutas);

        var honPorTerapeuta = gs.honorariosPorTerapeuta || 0;
        var residuoHon = gs.residuoHonorarios || 0;

        valorTotal += valorProp + (isFirst ? residuoValor : 0);
        aporteNeurotea += aporteProp + (isFirst ? residuoAporte : 0);
        honorariosTotal += honPorTerapeuta + (isFirst ? residuoHon : 0);
      });

      // Paquetes comprados en la fecha
      dayPackages.forEach(function(p) {
        if (p.terapeuta !== therapist) return;
        valorTotal += p.valorTotal || 0;
        aporteNeurotea += p.aporteNeurotea || 0;
        var honPaquete = (p.valorTotal || 0) - (p.aporteNeurotea || 0);
        honorariosTotal += honPaquete;
        transferenciaATerapeuta += p.transferenciaTerapeuta || 0;
      });

      // Adelantos (egresos tipo adelanto)
      var totalAdelantos = 0;
      dayEgresos.forEach(function(e) {
        if (e.tipo === 'adelanto' && e.terapeuta === therapist) {
          totalAdelantos += e.monto || 0;
        }
      });

      // Calcular deudas
      var neuroteaLeDebe = Math.max(0, honorariosTotal - transferenciaATerapeuta - totalAdelantos);
      var terapeutaDebe = Math.max(0, transferenciaATerapeuta + totalAdelantos - honorariosTotal);

      // Determinar estado
      var estado = 'SALDADO';
      if (neuroteaLeDebe > 0 && terapeutaDebe === 0) {
        if (saldoCaja >= neuroteaLeDebe) {
          estado = 'DAR EFECTIVO';
        } else if (saldoCaja > 0 && (saldoCaja + cuentaNeuroTEA) >= neuroteaLeDebe) {
          estado = 'DAR Y TRANSFERIR';
        } else if (cuentaNeuroTEA >= neuroteaLeDebe) {
          estado = 'TRANSFERIR';
        } else {
          estado = 'FONDOS INSUFICIENTES';
        }
      } else if (terapeutaDebe > 0) {
        estado = 'LA TERAPEUTA DEBE DAR';
      }

      // Verificar confirmacion
      var conf = null;
      for (var ci = 0; ci < confs.length; ci++) {
        if (confs[ci].terapeuta === therapist) { conf = confs[ci]; break; }
      }
      var isConfirmed = !!conf;

      // Valores para mostrar (usar estado congelado si esta confirmado)
      var displayIngresoTotal = valorTotal;
      var displayAporte = aporteNeurotea;
      var displayHonorarios = honorariosTotal;
      var displayTransfTerapeuta = transferenciaATerapeuta;
      var displayAdelantos = totalAdelantos;
      var displayNeuroteaLeDebe = neuroteaLeDebe;
      var displayTerapeutaDebe = terapeutaDebe;
      var displayEstado = estado;

      if (isConfirmed) {
        var frozen = conf.estadoCongelado || conf.estadoCongeladoJSON || null;
        if (frozen && typeof frozen === 'object') {
          displayIngresoTotal = frozen.valorTotalSesiones != null ? frozen.valorTotalSesiones : valorTotal;
          displayAporte = frozen.aporteNeuroTEA != null ? frozen.aporteNeuroTEA : aporteNeurotea;
          displayHonorarios = frozen.honorarios != null ? frozen.honorarios : honorariosTotal;
          displayTransfTerapeuta = frozen.transferenciaATerapeuta != null ? frozen.transferenciaATerapeuta : transferenciaATerapeuta;
          displayAdelantos = frozen.adelantosRecibidos != null ? frozen.adelantosRecibidos : totalAdelantos;
          displayNeuroteaLeDebe = frozen.neuroteaLeDebe != null ? frozen.neuroteaLeDebe : neuroteaLeDebe;
          displayTerapeutaDebe = frozen.terapeutaDebe != null ? frozen.terapeutaDebe : terapeutaDebe;
          displayEstado = frozen.estado || estado;
        }
      }

      var badgeClass = getStatusBadgeClass(displayEstado, isConfirmed);
      var estadoTexto = displayEstado + (isConfirmed ? ' &#10003;' : '');

      therapistRowsHTML += '<tr>' +
        '<td class="therapist-name">' + therapist + '</td>' +
        '<td class="right amount">' + formatCurrency(displayIngresoTotal) + '</td>' +
        '<td class="right amount">' + formatCurrency(displayAporte) + '</td>' +
        '<td class="right amount">' + formatCurrency(displayHonorarios) + '</td>' +
        '<td class="right amount">' + formatCurrency(displayTransfTerapeuta) + '</td>' +
        '<td class="right amount">' + formatCurrency(displayAdelantos) + '</td>' +
        '<td class="right amount' + (displayNeuroteaLeDebe > 0 ? ' positive' : '') + '">' + formatCurrency(displayNeuroteaLeDebe > 0 ? displayNeuroteaLeDebe : 0) + '</td>' +
        '<td class="right amount' + (displayTerapeutaDebe > 0 ? ' negative' : '') + '">' + formatCurrency(displayTerapeutaDebe > 0 ? displayTerapeutaDebe : 0) + '</td>' +
        '<td class="center"><span class="status-badge ' + badgeClass + '"><span class="status-dot"></span>' + estadoTexto + '</span></td>' +
        '</tr>';
    });
  } else {
    therapistRowsHTML = '<tr><td colspan="9" class="empty-state">No hay terapeutas registradas para este dia</td></tr>';
  }

  // Generar filas de egresos
  var egresosRowsHTML = '';
  if (dayEgresos.length > 0) {
    dayEgresos.forEach(function(e) {
      var tipoTexto = e.tipo === 'adelanto' ? ('Adelanto a ' + e.terapeuta) : 'Gasto de NeuroTEA';
      egresosRowsHTML += '<tr>' +
        '<td>' + (e.concepto || '') + '</td>' +
        '<td>' + tipoTexto + '</td>' +
        '<td class="right amount">' + formatCurrency(e.monto) + '</td>' +
        '</tr>';
    });
  } else {
    egresosRowsHTML = '<tr><td colspan="3" class="empty-state">No hay egresos registrados para este dia</td></tr>';
  }

  // Recopilar transferencias
  var transfers = [];

  // Transferencias de sesiones individuales
  daySessions.forEach(function(s) {
    if ((s.transferenciaNeurotea || 0) > 0) {
      transfers.push({
        destinatario: 'NeuroTEA',
        monto: s.transferenciaNeurotea,
        concepto: 'Pago de sesion con ' + s.terapeuta
      });
    }
  });

  // Transferencias de sesiones grupales - individualizado por nino
  dayGroupSessions.forEach(function(gs) {
    var groupName = gs.grupoNombre || 'Grupo';
    var asistencia = gs.asistencia || gs.asistenciaJSON || [];
    asistencia.forEach(function(child) {
      if (child.presente && (child.transferencia || 0) > 0) {
        transfers.push({
          destinatario: 'NeuroTEA',
          monto: child.transferencia,
          concepto: 'Pago de sesion grupal de ' + (child.nombre || 'Niño') + ' - "' + groupName + '"'
        });
      }
    });
  });

  // Transferencias de paquetes
  dayPackages.forEach(function(p) {
    if ((p.transferenciaNeurotea || 0) > 0) {
      transfers.push({
        destinatario: 'NeuroTEA',
        monto: p.transferenciaNeurotea,
        concepto: 'Pago de paquete con ' + p.terapeuta
      });
    }
  });

  // Vueltos de terapeutas y transferencias de rendicion
  confs.forEach(function(c) {
    var flujo = c.flujo || c.flujoJSON || {};
    if ((flujo.vueltoTransferencia || 0) > 0) {
      transfers.push({
        destinatario: 'NeuroTEA',
        monto: flujo.vueltoTransferencia,
        concepto: 'Vuelto de ' + c.terapeuta + ' por pago en efectivo'
      });
    }
    if (c.tipo === 'LA TERAPEUTA DEBE DAR' && c.tipoOpcion === 'devolucion-transferencia') {
      var frozenState = c.estadoCongelado || c.estadoCongeladoJSON || {};
      var montoTransf = frozenState.terapeutaDebe || 0;
      if (montoTransf > 0) {
        transfers.push({
          destinatario: 'NeuroTEA',
          monto: montoTransf,
          concepto: 'Transferencia de ' + c.terapeuta + ' por rendicion'
        });
      }
    }
  });

  // Filtrar solo transferencias a NeuroTEA
  var neuroteaTransfers = transfers.filter(function(t) { return t.destinatario === 'NeuroTEA'; });

  // Generar filas de transferencias
  var transfersRowsHTML = '';
  var totalNeuroteaTransfers = 0;
  if (neuroteaTransfers.length > 0) {
    neuroteaTransfers.forEach(function(t) {
      totalNeuroteaTransfers += t.monto;
      transfersRowsHTML += '<tr>' +
        '<td>' + t.destinatario + '</td>' +
        '<td class="right amount">' + formatCurrency(t.monto) + '</td>' +
        '<td>' + t.concepto + '</td>' +
        '</tr>';
    });
  } else {
    transfersRowsHTML = '<tr><td colspan="3" class="empty-state">No hay transferencias registradas para este dia</td></tr>';
  }

  // Timestamp de generacion
  var now = new Date();
  var timestampGeneracion = now.toLocaleDateString('es-PY') + ' a las ' + now.toLocaleTimeString('es-PY');

  // Generar HTML completo profesional
  var htmlContent = '<!DOCTYPE html>\n' +
'<html lang="es">\n' +
'<head>\n' +
'    <meta charset="UTF-8">\n' +
'    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
'    <title>Rendicion de Cuentas - NeuroTEA</title>\n' +
'    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">\n' +
'    <style>\n' +
'        * {\n' +
'            margin: 0;\n' +
'            padding: 0;\n' +
'            box-sizing: border-box;\n' +
'        }\n' +
'\n' +
'        @page {\n' +
'            size: A4;\n' +
'            margin: 15mm;\n' +
'        }\n' +
'\n' +
'        body {\n' +
'            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;\n' +
'            background: #f5f5f5;\n' +
'            color: #1a1a1a;\n' +
'            line-height: 1.4;\n' +
'            font-size: 11px;\n' +
'        }\n' +
'\n' +
'        .page {\n' +
'            width: 210mm;\n' +
'            min-height: 297mm;\n' +
'            margin: 0 auto;\n' +
'            background: white;\n' +
'            padding: 15mm;\n' +
'            box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n' +
'        }\n' +
'\n' +
'        /* Header */\n' +
'        .header {\n' +
'            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);\n' +
'            margin: -15mm -15mm 20px -15mm;\n' +
'            padding: 20px 15mm;\n' +
'            color: white;\n' +
'            display: flex;\n' +
'            justify-content: space-between;\n' +
'            align-items: center;\n' +
'        }\n' +
'\n' +
'        .brand {\n' +
'            display: flex;\n' +
'            flex-direction: column;\n' +
'        }\n' +
'\n' +
'        .brand-prefix {\n' +
'            font-size: 12px;\n' +
'            font-weight: 300;\n' +
'            letter-spacing: 1.5px;\n' +
'            opacity: 0.8;\n' +
'            text-transform: uppercase;\n' +
'        }\n' +
'\n' +
'        .brand-name {\n' +
'            font-size: 28px;\n' +
'            font-weight: 700;\n' +
'            letter-spacing: -0.5px;\n' +
'        }\n' +
'\n' +
'        .brand-name span {\n' +
'            color: #f59e0b;\n' +
'        }\n' +
'\n' +
'        .header-subtitle {\n' +
'            font-size: 12px;\n' +
'            opacity: 0.9;\n' +
'            margin-top: 2px;\n' +
'        }\n' +
'\n' +
'        .header-right {\n' +
'            text-align: right;\n' +
'        }\n' +
'\n' +
'        .header-right .date {\n' +
'            font-size: 14px;\n' +
'            font-weight: 600;\n' +
'        }\n' +
'\n' +
'        .header-right .report-type {\n' +
'            font-size: 11px;\n' +
'            opacity: 0.8;\n' +
'            margin-top: 2px;\n' +
'        }\n' +
'\n' +
'        /* Section Title */\n' +
'        .section-title {\n' +
'            font-size: 12px;\n' +
'            font-weight: 700;\n' +
'            text-transform: uppercase;\n' +
'            letter-spacing: 0.5px;\n' +
'            color: #1e3a5f;\n' +
'            margin: 20px 0 10px 0;\n' +
'            padding-bottom: 6px;\n' +
'            border-bottom: 2px solid #1e3a5f;\n' +
'        }\n' +
'\n' +
'        /* Tables */\n' +
'        table {\n' +
'            width: 100%;\n' +
'            border-collapse: collapse;\n' +
'            margin-bottom: 15px;\n' +
'            font-size: 10px;\n' +
'        }\n' +
'\n' +
'        th {\n' +
'            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);\n' +
'            color: white;\n' +
'            text-align: left;\n' +
'            padding: 10px 12px;\n' +
'            font-weight: 600;\n' +
'            font-size: 9px;\n' +
'            text-transform: uppercase;\n' +
'            letter-spacing: 0.3px;\n' +
'        }\n' +
'\n' +
'        th.right, td.right {\n' +
'            text-align: right;\n' +
'        }\n' +
'\n' +
'        th.center, td.center {\n' +
'            text-align: center;\n' +
'        }\n' +
'\n' +
'        td {\n' +
'            padding: 10px 12px;\n' +
'            border-bottom: 1px solid #e5e7eb;\n' +
'            vertical-align: middle;\n' +
'        }\n' +
'\n' +
'        tr:hover {\n' +
'            background: #f8fafc;\n' +
'        }\n' +
'\n' +
'        /* Resumen Table */\n' +
'        .resumen-table td:first-child {\n' +
'            font-weight: 500;\n' +
'            color: #374151;\n' +
'        }\n' +
'\n' +
'        .resumen-table td:last-child {\n' +
'            font-weight: 600;\n' +
'            color: #1e3a5f;\n' +
'            font-family: "SF Mono", "Consolas", monospace;\n' +
'        }\n' +
'\n' +
'        /* Therapist Table */\n' +
'        .therapist-table th {\n' +
'            font-size: 8px;\n' +
'            padding: 8px 6px;\n' +
'        }\n' +
'\n' +
'        .therapist-table td {\n' +
'            padding: 8px 6px;\n' +
'            font-size: 9px;\n' +
'        }\n' +
'\n' +
'        .therapist-name {\n' +
'            font-weight: 600;\n' +
'            color: #1e3a5f;\n' +
'        }\n' +
'\n' +
'        .amount {\n' +
'            font-family: "SF Mono", "Consolas", monospace;\n' +
'            font-weight: 500;\n' +
'        }\n' +
'\n' +
'        .amount.positive {\n' +
'            color: #059669;\n' +
'        }\n' +
'\n' +
'        .amount.negative {\n' +
'            color: #dc2626;\n' +
'        }\n' +
'\n' +
'        /* Status Badge */\n' +
'        .status-badge {\n' +
'            display: inline-flex;\n' +
'            align-items: center;\n' +
'            gap: 5px;\n' +
'            font-size: 8px;\n' +
'            font-weight: 500;\n' +
'            color: #1a1a1a;\n' +
'        }\n' +
'\n' +
'        .status-dot {\n' +
'            width: 7px;\n' +
'            height: 7px;\n' +
'            border-radius: 50%;\n' +
'            flex-shrink: 0;\n' +
'        }\n' +
'\n' +
'        .status-badge.equilibrado .status-dot {\n' +
'            background: #22c55e;\n' +
'        }\n' +
'\n' +
'        .status-badge.debe-recibir .status-dot {\n' +
'            background: #f59e0b;\n' +
'        }\n' +
'\n' +
'        .status-badge.debe-dar .status-dot {\n' +
'            background: #ef4444;\n' +
'        }\n' +
'\n' +
'        .status-badge.confirmado .status-dot {\n' +
'            background: #3b82f6;\n' +
'        }\n' +
'\n' +
'        /* Egresos Table Header */\n' +
'        .egresos-table th {\n' +
'            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);\n' +
'        }\n' +
'\n' +
'        /* Total Row */\n' +
'        .total-row {\n' +
'            font-size: 11px;\n' +
'            font-weight: 700;\n' +
'            color: #1e3a5f;\n' +
'            margin: 8px 0 20px 0;\n' +
'        }\n' +
'\n' +
'        .total-row span {\n' +
'            font-family: "SF Mono", "Consolas", monospace;\n' +
'        }\n' +
'\n' +
'        /* Empty State */\n' +
'        .empty-state {\n' +
'            font-style: italic;\n' +
'            color: #6b7280;\n' +
'            padding: 12px 0;\n' +
'        }\n' +
'\n' +
'        /* Footer */\n' +
'        .footer {\n' +
'            margin-top: 30px;\n' +
'            padding-top: 15px;\n' +
'            border-top: 1px solid #e5e7eb;\n' +
'            display: flex;\n' +
'            justify-content: space-between;\n' +
'            align-items: center;\n' +
'            font-size: 9px;\n' +
'            color: #9ca3af;\n' +
'        }\n' +
'\n' +
'        .footer-brand {\n' +
'            font-weight: 600;\n' +
'            color: #6b7280;\n' +
'        }\n' +
'\n' +
'        .page-number {\n' +
'            color: #6b7280;\n' +
'        }\n' +
'\n' +
'        /* Print Styles */\n' +
'        @media print {\n' +
'            body {\n' +
'                background: white;\n' +
'            }\n' +
'\n' +
'            .page {\n' +
'                width: 100%;\n' +
'                min-height: auto;\n' +
'                box-shadow: none;\n' +
'                padding: 0;\n' +
'                margin: 0;\n' +
'            }\n' +
'\n' +
'            .header {\n' +
'                margin: 0 0 20px 0;\n' +
'                padding: 20px;\n' +
'                -webkit-print-color-adjust: exact;\n' +
'                print-color-adjust: exact;\n' +
'            }\n' +
'\n' +
'            th {\n' +
'                -webkit-print-color-adjust: exact;\n' +
'                print-color-adjust: exact;\n' +
'            }\n' +
'\n' +
'            .egresos-table th {\n' +
'                -webkit-print-color-adjust: exact;\n' +
'                print-color-adjust: exact;\n' +
'            }\n' +
'\n' +
'            .status-badge {\n' +
'                -webkit-print-color-adjust: exact;\n' +
'                print-color-adjust: exact;\n' +
'            }\n' +
'        }\n' +
'    </style>\n' +
'</head>\n' +
'<body>\n' +
'    <div class="page">\n' +
'        <!-- Header -->\n' +
'        <div class="header">\n' +
'            <div class="brand">\n' +
'                <span class="brand-prefix">Avanza</span>\n' +
'                <span class="brand-name">Neuro<span>TEA</span></span>\n' +
'                <span class="header-subtitle">Sistema de Gestion - Reporte de Rendicion de Cuentas</span>\n' +
'            </div>\n' +
'            <div class="header-right">\n' +
'                <div class="date">' + fechaCapitalizada + '</div>\n' +
'                <div class="report-type">Rendicion Diaria</div>\n' +
'            </div>\n' +
'        </div>\n' +
'\n' +
'        <!-- Resumen Financiero -->\n' +
'        <h2 class="section-title">Resumen Financiero</h2>\n' +
'        <table class="resumen-table">\n' +
'            <thead>\n' +
'                <tr>\n' +
'                    <th>Concepto</th>\n' +
'                    <th class="right">Monto</th>\n' +
'                </tr>\n' +
'            </thead>\n' +
'            <tbody>\n' +
'                <tr>\n' +
'                    <td>Ingreso Total del Dia</td>\n' +
'                    <td class="right">' + formatCurrency(totalGeneral) + '</td>\n' +
'                </tr>\n' +
'                <tr>\n' +
'                    <td>Ingreso Total Efectivo</td>\n' +
'                    <td class="right">' + formatCurrency(totalEfectivo) + '</td>\n' +
'                </tr>\n' +
'                <tr>\n' +
'                    <td>Aporte Total a NeuroTEA</td>\n' +
'                    <td class="right">' + formatCurrency(aporteTotalNeuroTEA) + '</td>\n' +
'                </tr>\n' +
'                <tr>\n' +
'                    <td>Cuenta NeuroTEA</td>\n' +
'                    <td class="right">' + formatCurrency(cuentaNeuroTEA) + '</td>\n' +
'                </tr>\n' +
'                <tr>\n' +
'                    <td>Total Egresos</td>\n' +
'                    <td class="right">' + formatCurrency(totalEgresosVal) + '</td>\n' +
'                </tr>\n' +
'                <tr>\n' +
'                    <td>Saldo en Caja</td>\n' +
'                    <td class="right">' + formatCurrency(saldoCaja) + '</td>\n' +
'                </tr>\n' +
'            </tbody>\n' +
'        </table>\n' +
'        <div class="total-row">Total Aporte a NeuroTEA: <span>' + formatCurrency(aporteTotalNeuroTEA) + '</span></div>\n' +
'\n' +
'        <!-- Rendicion por Terapeuta -->\n' +
'        <h2 class="section-title">Rendicion por Terapeuta</h2>\n' +
'        <table class="therapist-table">\n' +
'            <thead>\n' +
'                <tr>\n' +
'                    <th>Terapeuta</th>\n' +
'                    <th class="right">Ingreso Total</th>\n' +
'                    <th class="right">Aporte NeuroTEA</th>\n' +
'                    <th class="right">Honorarios</th>\n' +
'                    <th class="right">Transf. a Terapeuta</th>\n' +
'                    <th class="right">Adelantos</th>\n' +
'                    <th class="right">NeuroTEA Debe</th>\n' +
'                    <th class="right">Terapeuta Debe</th>\n' +
'                    <th class="center">Estado</th>\n' +
'                </tr>\n' +
'            </thead>\n' +
'            <tbody>\n' +
'                ' + therapistRowsHTML + '\n' +
'            </tbody>\n' +
'        </table>\n' +
'\n' +
'        <!-- Egresos del Dia -->\n' +
'        <h2 class="section-title">Egresos del Dia</h2>\n' +
'        <table class="egresos-table">\n' +
'            <thead>\n' +
'                <tr>\n' +
'                    <th>Concepto</th>\n' +
'                    <th>Tipo</th>\n' +
'                    <th class="right">Monto</th>\n' +
'                </tr>\n' +
'            </thead>\n' +
'            <tbody>\n' +
'                ' + egresosRowsHTML + '\n' +
'            </tbody>\n' +
'        </table>\n' +
'        <div class="total-row">Total Egresos: <span>' + formatCurrency(totalEgresosVal) + '</span></div>\n' +
'\n' +
'        <!-- Transferencias del Dia -->\n' +
'        <h2 class="section-title">Transferencias del Dia</h2>\n' +
'        <table>\n' +
'            <thead>\n' +
'                <tr>\n' +
'                    <th>Destinatario</th>\n' +
'                    <th class="right">Monto</th>\n' +
'                    <th>Concepto</th>\n' +
'                </tr>\n' +
'            </thead>\n' +
'            <tbody>\n' +
'                ' + transfersRowsHTML + '\n' +
'            </tbody>\n' +
'        </table>\n' +
'        <div class="total-row">Total Transferencias a NeuroTEA: <span>' + formatCurrency(totalNeuroteaTransfers) + '</span></div>\n' +
'\n' +
'        <!-- Footer -->\n' +
'        <div class="footer">\n' +
'            <span class="footer-brand">Sistema NeuroTEA</span>\n' +
'            <span>Generado el ' + timestampGeneracion + '</span>\n' +
'            <span class="page-number">Pagina 1 de 1</span>\n' +
'        </div>\n' +
'    </div>\n' +
'</body>\n' +
'</html>';

  // Descargar como archivo HTML
  var blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'NeuroTEA_Rendicion_' + fecha.replace(/-/g, '_') + '.html';
  a.click();
  URL.revokeObjectURL(url);
  showNotification('Reporte de rendicion generado', 'success');
}
</script>
