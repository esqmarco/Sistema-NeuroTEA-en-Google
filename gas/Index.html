<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema NeuroTEA - Gestion de Sesiones</title>
  <base target="_top">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- jsPDF para reportes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <!-- Estilos personalizados -->
  <?!= include('Styles'); ?>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex flex-col items-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
      <p class="text-gray-700 dark:text-gray-300">Cargando Sistema NeuroTEA...</p>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div>
            <span class="text-sm italic opacity-80">Avanza</span>
            <h1 class="text-2xl font-bold -mt-1">Neuro<span class="text-orange-400">TEA</span></h1>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <i data-lucide="calendar" class="w-5 h-5"></i>
            <input type="date" id="date-input" class="bg-white/20 border border-white/30 rounded px-3 py-1 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50">
          </div>
          <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-white/20 transition">
            <i data-lucide="moon" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs Navigation -->
  <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4">
      <div class="flex overflow-x-auto scrollbar-hide">
        <button onclick="switchTab('registro')" class="tab-btn active" data-tab="registro">
          <i data-lucide="clipboard-list" class="w-4 h-4 mr-2"></i>
          <span>Registro Diario</span>
        </button>
        <button onclick="switchTab('resumen')" class="tab-btn" data-tab="resumen">
          <i data-lucide="bar-chart-2" class="w-4 h-4 mr-2"></i>
          <span>Resumen Global</span>
        </button>
        <button onclick="switchTab('transferencias')" class="tab-btn" data-tab="transferencias">
          <i data-lucide="send" class="w-4 h-4 mr-2"></i>
          <span>Transferencias</span>
        </button>
        <button onclick="switchTab('rendicion')" class="tab-btn" data-tab="rendicion">
          <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
          <span>Rendicion</span>
        </button>
        <button onclick="switchTab('egresos')" class="tab-btn" data-tab="egresos">
          <i data-lucide="minus-circle" class="w-4 h-4 mr-2"></i>
          <span>Egresos</span>
        </button>
        <button onclick="switchTab('terapeutas')" class="tab-btn" data-tab="terapeutas">
          <i data-lucide="users" class="w-4 h-4 mr-2"></i>
          <span>Terapeutas</span>
        </button>
        <button onclick="switchTab('paquetes')" class="tab-btn" data-tab="paquetes">
          <i data-lucide="package" class="w-4 h-4 mr-2"></i>
          <span>Paquetes</span>
        </button>
        <button onclick="switchTab('grupos')" class="tab-btn" data-tab="grupos">
          <i data-lucide="users-2" class="w-4 h-4 mr-2"></i>
          <span>Grupos</span>
        </button>
        <button onclick="switchTab('admin')" class="tab-btn" data-tab="admin">
          <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
          <span>Admin</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-6">

    <!-- Tab: Registro Diario -->
    <section id="tab-registro" class="tab-content">
      <div class="grid lg:grid-cols-2 gap-6">
        <!-- Formulario de Sesion -->
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-blue-500"></i>
            Registrar Sesion Individual
          </h2>
          <form id="session-form" class="space-y-4">
            <div>
              <label class="form-label">Terapeuta</label>
              <select id="therapist-select" class="form-select" required>
                <option value="">Seleccione terapeuta...</option>
              </select>
            </div>
            <div>
              <label class="form-label">Nombre del Paciente</label>
              <input type="text" id="patient-name" class="form-input" placeholder="Ingrese nombre del paciente" required>
              <div id="credit-indicator" class="hidden mt-2 p-2 bg-green-100 dark:bg-green-900 rounded text-sm text-green-700 dark:text-green-300">
                <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                <span id="credit-count">0</span> creditos disponibles
              </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="form-label">Efectivo</label>
                <input type="number" id="cash-amount" class="form-input" value="0" min="0">
              </div>
              <div>
                <label class="form-label">Transfer. NeuroTEA</label>
                <input type="number" id="transfer-neurotea" class="form-input" value="0" min="0">
              </div>
              <div>
                <label class="form-label">Transfer. Terapeuta</label>
                <input type="number" id="transfer-therapist" class="form-input" value="0" min="0">
              </div>
            </div>
            <div>
              <label class="form-label">Aporte NeuroTEA</label>
              <div class="flex space-x-2">
                <select id="contribution-type" class="form-select flex-1">
                  <option value="30">30%</option>
                  <option value="20">20%</option>
                  <option value="40">40%</option>
                  <option value="50">50%</option>
                  <option value="fixed">Monto fijo</option>
                </select>
                <input type="number" id="fixed-contribution" class="form-input w-32 hidden" placeholder="Monto" min="0">
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" id="use-credit" class="form-checkbox">
              <label for="use-credit" class="text-sm text-gray-700 dark:text-gray-300">Usar credito de paquete</label>
            </div>
            <div class="flex space-x-3">
              <button type="submit" class="btn btn-primary flex-1">
                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                Registrar Sesion
              </button>
              <button type="button" onclick="resetSessionForm()" class="btn btn-secondary">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- Lista de Sesiones del Dia -->
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="list" class="w-5 h-5 mr-2 text-green-500"></i>
            Sesiones del Dia
            <span id="session-count" class="ml-auto text-sm font-normal text-gray-500">(0)</span>
          </h2>
          <div id="sessions-list" class="space-y-2 max-h-96 overflow-y-auto">
            <p class="text-gray-500 dark:text-gray-400 text-center py-8">No hay sesiones registradas</p>
          </div>
        </div>
      </div>

      <!-- Formulario Sesion Grupal -->
      <div class="card mt-6">
        <h2 class="card-title">
          <i data-lucide="users-2" class="w-5 h-5 mr-2 text-purple-500"></i>
          Registrar Sesion Grupal
        </h2>
        <form id="group-session-form" class="space-y-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="form-label">Grupo</label>
              <select id="group-select" class="form-select" required>
                <option value="">Seleccione grupo...</option>
              </select>
            </div>
            <div>
              <label class="form-label">Terapeutas</label>
              <div id="group-therapists-select" class="space-y-2">
                <!-- Checkboxes de terapeutas -->
              </div>
            </div>
          </div>
          <div id="group-children-list" class="hidden">
            <label class="form-label">Asistencia de Ninos</label>
            <div id="children-attendance" class="grid md:grid-cols-2 gap-2">
              <!-- Lista de ninos con checkbox de asistencia -->
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            <i data-lucide="save" class="w-4 h-4 mr-2"></i>
            Registrar Sesion Grupal
          </button>
        </form>
      </div>
    </section>

    <!-- Tab: Resumen Global -->
    <section id="tab-resumen" class="tab-content hidden">
      <div class="grid md:grid-cols-4 gap-4 mb-6">
        <div class="stat-card bg-blue-500">
          <i data-lucide="clipboard-check" class="w-8 h-8 mb-2"></i>
          <p class="stat-value" id="total-sessions">0</p>
          <p class="stat-label">Sesiones Hoy</p>
        </div>
        <div class="stat-card bg-green-500">
          <i data-lucide="banknote" class="w-8 h-8 mb-2"></i>
          <p class="stat-value" id="total-cash">Gs 0</p>
          <p class="stat-label">Efectivo en Caja</p>
        </div>
        <div class="stat-card bg-purple-500">
          <i data-lucide="building-2" class="w-8 h-8 mb-2"></i>
          <p class="stat-value" id="total-bank">Gs 0</p>
          <p class="stat-label">Cuenta NeuroTEA</p>
        </div>
        <div class="stat-card bg-orange-500">
          <i data-lucide="trending-up" class="w-8 h-8 mb-2"></i>
          <p class="stat-value" id="total-contribution">Gs 0</p>
          <p class="stat-label">Aporte NeuroTEA</p>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">
          <i data-lucide="table-2" class="w-5 h-5 mr-2"></i>
          Detalle por Terapeuta
        </h2>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-100 dark:bg-gray-700">
                <th class="table-header">Terapeuta</th>
                <th class="table-header">Sesiones</th>
                <th class="table-header">Valor Total</th>
                <th class="table-header">Aporte</th>
                <th class="table-header">Honorarios</th>
                <th class="table-header">Estado</th>
              </tr>
            </thead>
            <tbody id="summary-table-body">
              <tr><td colspan="6" class="text-center py-4 text-gray-500">Sin datos</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Tab: Transferencias -->
    <section id="tab-transferencias" class="tab-content hidden">
      <div class="grid md:grid-cols-2 gap-6">
        <div class="card">
          <h2 class="card-title text-yellow-600">
            <i data-lucide="clock" class="w-5 h-5 mr-2"></i>
            Transferencias Pendientes
          </h2>
          <div id="pending-transfers" class="space-y-2">
            <p class="text-gray-500 text-center py-4">No hay transferencias pendientes</p>
          </div>
        </div>
        <div class="card">
          <h2 class="card-title text-green-600">
            <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
            Transferencias Confirmadas
          </h2>
          <div id="confirmed-transfers" class="space-y-2">
            <p class="text-gray-500 text-center py-4">No hay transferencias confirmadas</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Tab: Rendicion -->
    <section id="tab-rendicion" class="tab-content hidden">
      <div class="card">
        <h2 class="card-title">
          <i data-lucide="calculator" class="w-5 h-5 mr-2"></i>
          Rendicion de Cuentas
        </h2>
        <div id="rendicion-list" class="space-y-4">
          <p class="text-gray-500 text-center py-4">Seleccione una fecha para ver la rendicion</p>
        </div>
      </div>
    </section>

    <!-- Tab: Egresos -->
    <section id="tab-egresos" class="tab-content hidden">
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="minus-circle" class="w-5 h-5 mr-2 text-red-500"></i>
            Registrar Egreso
          </h2>
          <form id="egreso-form" class="space-y-4">
            <div>
              <label class="form-label">Tipo de Egreso</label>
              <select id="egreso-type" class="form-select" required>
                <option value="">Seleccione tipo...</option>
                <option value="adelanto">Adelanto a Terapeuta</option>
                <option value="gasto-neurotea">Gasto NeuroTEA</option>
              </select>
            </div>
            <div id="egreso-therapist-container" class="hidden">
              <label class="form-label">Terapeuta</label>
              <select id="egreso-therapist" class="form-select">
                <option value="">Seleccione terapeuta...</option>
              </select>
            </div>
            <div>
              <label class="form-label">Concepto</label>
              <input type="text" id="egreso-concept" class="form-input" placeholder="Descripcion del egreso">
            </div>
            <div>
              <label class="form-label">Monto</label>
              <input type="number" id="egreso-amount" class="form-input" placeholder="0" min="1" required>
            </div>
            <button type="submit" class="btn btn-primary w-full">
              <i data-lucide="save" class="w-4 h-4 mr-2"></i>
              Registrar Egreso
            </button>
          </form>
        </div>
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="list" class="w-5 h-5 mr-2"></i>
            Egresos del Dia
          </h2>
          <div id="egresos-list" class="space-y-2 max-h-96 overflow-y-auto">
            <p class="text-gray-500 text-center py-4">No hay egresos registrados</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Tab: Terapeutas -->
    <section id="tab-terapeutas" class="tab-content hidden">
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="user-plus" class="w-5 h-5 mr-2 text-blue-500"></i>
            Agregar Terapeuta
          </h2>
          <form id="therapist-form" class="space-y-4">
            <div>
              <label class="form-label">Nombre del Terapeuta</label>
              <input type="text" id="new-therapist-name" class="form-input" placeholder="Nombre completo" required>
            </div>
            <button type="submit" class="btn btn-primary w-full">
              <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
              Agregar Terapeuta
            </button>
          </form>
        </div>
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="users" class="w-5 h-5 mr-2"></i>
            Lista de Terapeutas
          </h2>
          <div id="therapists-list" class="space-y-2">
            <p class="text-gray-500 text-center py-4">No hay terapeutas registrados</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Tab: Paquetes -->
    <section id="tab-paquetes" class="tab-content hidden">
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="package-plus" class="w-5 h-5 mr-2 text-green-500"></i>
            Crear Paquete de Sesiones
          </h2>
          <form id="package-form" class="space-y-4">
            <div>
              <label class="form-label">Terapeuta</label>
              <select id="package-therapist" class="form-select" required>
                <option value="">Seleccione terapeuta...</option>
              </select>
            </div>
            <div>
              <label class="form-label">Nombre del Paciente</label>
              <input type="text" id="package-patient" class="form-input" placeholder="Nombre del paciente" required>
            </div>
            <div>
              <label class="form-label">Cantidad de Sesiones</label>
              <input type="number" id="package-sessions" class="form-input" min="1" value="10" required>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="form-label">Efectivo</label>
                <input type="number" id="package-cash" class="form-input" value="0" min="0">
              </div>
              <div>
                <label class="form-label">Transfer. NeuroTEA</label>
                <input type="number" id="package-transfer-neurotea" class="form-input" value="0" min="0">
              </div>
              <div>
                <label class="form-label">Transfer. Terapeuta</label>
                <input type="number" id="package-transfer-therapist" class="form-input" value="0" min="0">
              </div>
            </div>
            <div>
              <label class="form-label">Aporte NeuroTEA</label>
              <select id="package-contribution" class="form-select">
                <option value="30">30%</option>
                <option value="20">20%</option>
                <option value="40">40%</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-full">
              <i data-lucide="save" class="w-4 h-4 mr-2"></i>
              Crear Paquete
            </button>
          </form>
        </div>
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="package" class="w-5 h-5 mr-2"></i>
            Paquetes Activos
          </h2>
          <div id="packages-list" class="space-y-2 max-h-96 overflow-y-auto">
            <p class="text-gray-500 text-center py-4">No hay paquetes activos</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Tab: Grupos -->
    <section id="tab-grupos" class="tab-content hidden">
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="folder-plus" class="w-5 h-5 mr-2 text-purple-500"></i>
            Crear Grupo
          </h2>
          <form id="group-form" class="space-y-4">
            <div>
              <label class="form-label">Nombre del Grupo</label>
              <input type="text" id="group-name" class="form-input" placeholder="Ej: Grupo Lunes AM" required>
            </div>
            <div>
              <label class="form-label">Porcentaje Aporte NeuroTEA</label>
              <select id="group-contribution" class="form-select">
                <option value="30">30%</option>
                <option value="20">20%</option>
                <option value="40">40%</option>
              </select>
            </div>
            <div>
              <label class="form-label">Ninos del Grupo</label>
              <div id="group-children-inputs" class="space-y-2">
                <div class="child-input-row flex space-x-2">
                  <input type="text" placeholder="Nombre del nino" class="form-input flex-1 child-name">
                  <input type="number" placeholder="Valor" class="form-input w-28 child-value" min="0">
                  <button type="button" onclick="addChildInput()" class="btn btn-secondary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                  </button>
                </div>
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-full">
              <i data-lucide="save" class="w-4 h-4 mr-2"></i>
              Crear Grupo
            </button>
          </form>
        </div>
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="users-2" class="w-5 h-5 mr-2"></i>
            Grupos Activos
          </h2>
          <div id="groups-list" class="space-y-2 max-h-96 overflow-y-auto">
            <p class="text-gray-500 text-center py-4">No hay grupos registrados</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Tab: Administracion -->
    <section id="tab-admin" class="tab-content hidden">
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Saldo Inicial -->
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="wallet" class="w-5 h-5 mr-2 text-green-500"></i>
            Saldo Inicial del Dia
          </h2>
          <form id="saldo-form" class="space-y-4">
            <div>
              <label class="form-label">Efectivo en Caja</label>
              <input type="number" id="saldo-inicial" class="form-input" placeholder="0" min="0">
            </div>
            <button type="submit" class="btn btn-primary w-full">
              <i data-lucide="save" class="w-4 h-4 mr-2"></i>
              Guardar Saldo Inicial
            </button>
          </form>
        </div>

        <!-- Backup -->
        <div class="card">
          <h2 class="card-title">
            <i data-lucide="database" class="w-5 h-5 mr-2 text-blue-500"></i>
            Backup y Restauracion
          </h2>
          <div class="space-y-3">
            <button onclick="exportFullBackup()" class="btn btn-secondary w-full">
              <i data-lucide="download" class="w-4 h-4 mr-2"></i>
              Descargar Backup Completo
            </button>
            <button onclick="exportDayData()" class="btn btn-secondary w-full">
              <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
              Exportar Datos del Dia
            </button>
            <div class="border-t pt-3">
              <label class="form-label">Importar Datos</label>
              <input type="file" id="import-file" accept=".json" class="form-input">
              <button onclick="importData()" class="btn btn-warning w-full mt-2">
                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                Importar Archivo
              </button>
            </div>
          </div>
        </div>

        <!-- Estadisticas -->
        <div class="card md:col-span-2">
          <h2 class="card-title">
            <i data-lucide="bar-chart" class="w-5 h-5 mr-2 text-purple-500"></i>
            Estadisticas del Sistema
          </h2>
          <div id="system-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Se llena dinamicamente -->
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Notification Toast -->
  <div id="notification-container" class="fixed bottom-4 right-4 z-50 space-y-2">
  </div>

  <!-- Scripts -->
  <?!= include('Scripts'); ?>

  <script>
    // Inicializar iconos
    lucide.createIcons();

    // Inicializar sistema cuando cargue
    document.addEventListener('DOMContentLoaded', initializeSystem);
  </script>
</body>
</html>
